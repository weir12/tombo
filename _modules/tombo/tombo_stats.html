

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tombo.tombo_stats &mdash; Tombo 1.5 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Tombo
          

          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tombo Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Tombo Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resquiggle.html">Re-squiggle Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modified_base_detection.html">Modified Base Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../text_output.html">Text Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filtering.html">Read Filtering Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rna.html">RNA Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_training.html">Model Training (Advanced Users Only)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tombo.html">tombo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tombo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tombo.tombo_stats</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tombo.tombo_stats</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="c1"># Future warning from cython in h5py</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">pdist</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Pipe</span>
<span class="kn">from</span> <span class="nn">numpy.lib.recfunctions</span> <span class="k">import</span> <span class="n">append_fields</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="k">import</span> <span class="n">single</span><span class="p">,</span> <span class="n">leaves_list</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">combinations</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># import tombo functions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tombo_helper</span> <span class="k">as</span> <span class="n">th</span>

<span class="kn">from</span> <span class="nn">._c_helper</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">c_mean_std</span><span class="p">,</span> <span class="n">c_apply_outlier_thresh</span><span class="p">,</span> <span class="n">c_new_means</span><span class="p">,</span> <span class="n">c_calc_llh_ratio</span><span class="p">,</span>
    <span class="n">c_calc_llh_ratio_const_var</span><span class="p">,</span> <span class="n">c_calc_scaled_llh_ratio_const_var</span><span class="p">,</span>
    <span class="n">c_new_mean_stds</span><span class="p">,</span> <span class="n">c_compute_running_pctl_diffs</span><span class="p">,</span> <span class="n">c_compute_slopes</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">._default_parameters</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">SMALLEST_PVAL</span><span class="p">,</span> <span class="n">STANDARD_MODELS</span><span class="p">,</span> <span class="n">ALTERNATE_MODELS</span><span class="p">,</span>
    <span class="n">MIN_KMER_OBS_TO_EST</span><span class="p">,</span> <span class="n">ALT_EST_BATCH</span><span class="p">,</span> <span class="n">MAX_KMER_OBS</span><span class="p">,</span> <span class="n">NUM_DENS_POINTS</span><span class="p">,</span>
    <span class="n">LLR_THRESH</span><span class="p">,</span> <span class="n">SAMP_COMP_THRESH</span><span class="p">,</span> <span class="n">DE_NOVO_THRESH</span><span class="p">,</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">,</span>
    <span class="n">ROC_PLOT_POINTS</span><span class="p">,</span> <span class="n">NANOPOLISH_CENTRAL_POS</span><span class="p">,</span> <span class="n">NUM_READS_FOR_SCALE</span><span class="p">,</span>
    <span class="n">ROBUST_QUANTS</span><span class="p">,</span> <span class="n">MAX_POINTS_FOR_THEIL_SEN</span><span class="p">,</span> <span class="n">NUM_READS_TO_ADJUST_MODEL</span><span class="p">,</span>
    <span class="n">OCLLHR_SCALE</span><span class="p">,</span> <span class="n">OCLLHR_HEIGHT</span><span class="p">,</span> <span class="n">OCLLHR_POWER</span><span class="p">,</span> <span class="n">FM_OFFSET_DEFAULT</span><span class="p">,</span>
    <span class="n">MOST_SIGNIF_NUM_BATCHES_DEFAULT</span><span class="p">,</span> <span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">,</span>
    <span class="n">MEAN_PRIOR_CONST</span><span class="p">,</span> <span class="n">SD_PRIOR_CONST</span><span class="p">,</span> <span class="n">ALGN_PARAMS_TABLE</span><span class="p">,</span> <span class="n">SEG_PARAMS_TABLE</span><span class="p">,</span>
    <span class="n">MIN_EVENT_TO_SEQ_RATIO</span><span class="p">,</span> <span class="n">COLLAPSE_RNA_STALLS</span><span class="p">,</span> <span class="n">STALL_PARAMS</span><span class="p">,</span>
    <span class="n">OUTLIER_THRESH</span><span class="p">,</span>
    <span class="n">RNA_SCALE_NUM_EVENTS</span><span class="p">,</span> <span class="n">RNA_SCALE_MAX_FRAC_EVENTS</span><span class="p">,</span> <span class="n">USE_RNA_EVENT_SCALE</span><span class="p">)</span>
<span class="n">DEFAULT_STALL_PARAMS</span><span class="o">=</span><span class="n">th</span><span class="o">.</span><span class="n">stallParams</span><span class="p">(</span><span class="o">**</span><span class="n">STALL_PARAMS</span><span class="p">)</span>

<span class="c1"># list of classes/functions to include in API</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;TomboStats&#39;</span><span class="p">,</span> <span class="s1">&#39;ModelStats&#39;</span><span class="p">,</span> <span class="s1">&#39;LevelStats&#39;</span><span class="p">,</span> <span class="s1">&#39;PerReadStats&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TomboModel&#39;</span><span class="p">,</span> <span class="s1">&#39;AltModel&#39;</span><span class="p">,</span> <span class="s1">&#39;normalize_raw_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;compute_base_means&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_read_seg_score&#39;</span><span class="p">,</span> <span class="s1">&#39;calc_kmer_fitted_shift_scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;load_resquiggle_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;compute_num_events&#39;</span><span class="p">]</span>


<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">_PROFILE_SIGNIF</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_SIGNIF_STATS_OUT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_SIGNIF_PER_READ</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_EST_REF</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_CENTER_REF</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_ALT_EST</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PROFILE_MOTIF_ALT_EST</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_DEBUG_EST_STD</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG_EST_BW</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">_DEBUG_EST_NUM_KMER_SAVE</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">STAT_BLOCKS_QUEUE_LIMIT</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">DNA_BASES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>

<span class="n">HALF_NORM_EXPECTED_VAL</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">halfnorm</span><span class="o">.</span><span class="n">expect</span><span class="p">()</span>
<span class="n">LOG10_E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">STANDARD_MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>

<span class="n">SAMP_COMP_TXT</span> <span class="o">=</span> <span class="s1">&#39;sample_compare&#39;</span>
<span class="n">DE_NOVO_TXT</span> <span class="o">=</span> <span class="s1">&#39;de_novo&#39;</span>
<span class="n">ALT_MODEL_TXT</span> <span class="o">=</span> <span class="s1">&#39;model_compare&#39;</span>
<span class="n">PER_READ_STATS</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAMP_COMP_TXT</span><span class="p">,</span> <span class="n">DE_NOVO_TXT</span><span class="p">,</span> <span class="n">ALT_MODEL_TXT</span><span class="p">)</span>

<span class="c1"># TODO only ks-test currently implemented</span>
<span class="n">KS_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;ks_test&#39;</span>
<span class="n">U_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;u_test&#39;</span>
<span class="n">T_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;t_test&#39;</span>
<span class="n">KS_STAT_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;ks_stat_test&#39;</span>
<span class="n">U_STAT_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;u_stat_test&#39;</span>
<span class="n">T_STAT_TEST_TXT</span> <span class="o">=</span> <span class="s1">&#39;t_stat_test&#39;</span>
<span class="n">LEVEL_STATS_TXTS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">KS_TEST_TXT</span><span class="p">,</span> <span class="n">U_TEST_TXT</span><span class="p">,</span> <span class="n">T_TEST_TXT</span><span class="p">,</span>
    <span class="n">KS_STAT_TEST_TXT</span><span class="p">,</span> <span class="n">U_STAT_TEST_TXT</span><span class="p">,</span> <span class="n">T_STAT_TEST_TXT</span><span class="p">)</span>

<span class="n">ALT_MODEL_SEP_CHAR</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>

<span class="n">NORM_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;pA&#39;</span><span class="p">,</span> <span class="s1">&#39;pA_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;robust_median&#39;</span><span class="p">,</span>
              <span class="s1">&#39;median_const_scale&#39;</span><span class="p">)</span>

<span class="c1"># options specifying testing methods</span>
<span class="c1"># assume constant SD in model to save on computation</span>
<span class="n">CONST_SD_MODEL</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">STAT_BLOCKS_H5_NAME</span> <span class="o">=</span> <span class="s1">&#39;Statistic_Blocks&#39;</span>
<span class="n">MOST_SIGNIF_H5_NAME</span> <span class="o">=</span> <span class="s1">&#39;Most_Significant_Stats&#39;</span>
<span class="n">COV_DAMP_COUNTS_H5_NAME</span> <span class="o">=</span> <span class="s1">&#39;Cov_Damp_Counts&#39;</span>
<span class="n">COV_THRESH_H5_NAME</span> <span class="o">=</span> <span class="s1">&#39;Cov_Threshold&#39;</span>

<span class="c1"># turned off by default (and not accessible via command line so</span>
<span class="c1"># hardcoded for now)</span>
<span class="n">DEFAULT_TRIM_RNA_PARAMS</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">trimRnaParams</span><span class="p">(</span>
    <span class="n">moving_window_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">min_running_values</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">thresh_scale</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">max_raw_obs</span><span class="o">=</span><span class="mi">40000</span><span class="p">)</span>


<span class="c1">#############################################</span>
<span class="c1">##### Pair-wise Distance and Clustering #####</span>
<span class="c1">#############################################</span>

<span class="k">def</span> <span class="nf">transform_and_trim_stats</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">,</span> <span class="n">are_pvals</span><span class="p">,</span> <span class="n">trim_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">are_pvals</span><span class="p">:</span>
        <span class="n">reg_stats</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="n">nan_r_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="n">reg_stats</span><span class="p">[</span><span class="n">nan_r_stats</span> <span class="o">&gt;</span> <span class="n">trim_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">trim_value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nan_r_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="n">reg_stats</span><span class="p">[</span><span class="n">nan_r_stats</span> <span class="o">&gt;</span> <span class="n">trim_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">trim_value</span>
        <span class="n">reg_stats</span><span class="p">[</span><span class="n">nan_r_stats</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">trim_value</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">trim_value</span>
    <span class="k">return</span> <span class="n">reg_stats</span>

<span class="k">def</span> <span class="nf">order_reads</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute order of reads based on log p-values or -log likelihood ratios</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># get pairwise distances between reads</span>
    <span class="c1"># will get some empty slice means warnings, so suppress those</span>
    <span class="c1">#   (no seterr for this specific warning)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">r_dists</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">u</span><span class="o">-</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))))</span>
    <span class="n">r_dists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_dists</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">r_dists</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># then perform single/min linkage clustering and return the leaf order</span>
    <span class="k">return</span> <span class="n">leaves_list</span><span class="p">(</span><span class="n">single</span><span class="p">(</span><span class="n">r_dists</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sliding_window_dist</span><span class="p">(</span><span class="n">sig_diffs1</span><span class="p">,</span> <span class="n">sig_diffs2</span><span class="p">,</span> <span class="n">slide_span</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute distance over the minimum over a sliding window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
        <span class="n">sig_diffs1</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i1</span><span class="o">+</span><span class="n">num_bases</span><span class="p">]</span> <span class="o">-</span> <span class="n">sig_diffs2</span><span class="p">[</span><span class="n">i2</span><span class="p">:</span><span class="n">i2</span><span class="o">+</span><span class="n">num_bases</span><span class="p">]))</span>
                       <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">euclidian_dist</span><span class="p">(</span><span class="n">sig_diffs1</span><span class="p">,</span> <span class="n">sig_diffs2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Euclidean distance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig_diffs1</span> <span class="o">-</span> <span class="n">sig_diffs2</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">get_pairwise_dists</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">,</span> <span class="n">index_q</span><span class="p">,</span> <span class="n">dists_q</span><span class="p">,</span> <span class="n">slide_span</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute pairwise distances between a set of signal shifts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slide_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">num_bases</span><span class="o">=</span><span class="n">reg_sig_diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">slide_span</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">slide_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">sliding_window_dist</span><span class="p">(</span>
                    <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">slide_span</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span>
                <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">euclidian_dist</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">reg_sig_diffs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span>
                <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_sig_diffs</span><span class="p">))])</span>
        <span class="n">dists_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">row_dists</span><span class="p">))</span>

    <span class="k">return</span>


<span class="c1">##################################</span>
<span class="c1">###### Signal Normalization ######</span>
<span class="c1">##################################</span>

<div class="viewcode-block" id="compute_base_means"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_base_means">[docs]</a><span class="k">def</span> <span class="nf">compute_base_means</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">base_starts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Efficiently compute new base mean values from raw signal and base start</span>
<span class="sd">    positions</span>

<span class="sd">    Args:</span>
<span class="sd">        all_raw_signal (`np.array`): raw nanopore signal obervation values</span>
<span class="sd">        base_starts (`np.array::np.int32`): 0-based base start positions within</span>
<span class="sd">            raw signal</span>

<span class="sd">    Returns:</span>
<span class="sd">        `np.array::np.float64` containing base mean levels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">c_new_means</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">base_starts</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">get_scale_values_from_events</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">,</span>
        <span class="n">num_events</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_frac_events</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num_events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_frac_events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="n">valid_cpts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_frac_events</span> <span class="o">&lt;</span> <span class="n">num_events</span><span class="p">):</span>
            <span class="n">num_events</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_cpts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_frac_events</span><span class="p">)</span>
        <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">valid_cpts</span><span class="p">[:</span><span class="n">num_events</span><span class="p">]</span>
    <span class="n">event_means</span> <span class="o">=</span> <span class="n">compute_base_means</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">)</span>
    <span class="n">read_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">event_means</span><span class="p">)</span>
    <span class="n">read_mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">event_means</span> <span class="o">-</span> <span class="n">read_med</span><span class="p">))</span>
    <span class="n">lower_lim</span> <span class="o">=</span> <span class="o">-</span><span class="n">outlier_thresh</span>
    <span class="n">upper_lim</span> <span class="o">=</span> <span class="n">outlier_thresh</span>

    <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">scaleValues</span><span class="p">(</span>
        <span class="n">shift</span><span class="o">=</span><span class="n">read_med</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">read_mad</span><span class="p">,</span>
        <span class="n">lower_lim</span><span class="o">=</span><span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="o">=</span><span class="n">upper_lim</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">trim_rna</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">rsqgl_params</span><span class="p">,</span> <span class="n">trim_rna_params</span><span class="o">=</span><span class="n">DEFAULT_TRIM_RNA_PARAMS</span><span class="p">):</span>
    <span class="n">all_raw_signal</span> <span class="o">=</span> <span class="n">all_raw_signal</span><span class="p">[:</span><span class="n">trim_rna_params</span><span class="o">.</span><span class="n">max_raw_obs</span><span class="p">]</span>
    <span class="n">num_events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">mean_obs_per_event</span><span class="p">)</span>
    <span class="c1"># get stdev over delta-mean events</span>
    <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">valid_cpts_w_cap</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">min_obs_per_base</span><span class="p">,</span>
        <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">num_events</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">window_sds</span> <span class="o">=</span> <span class="n">c_new_mean_stds</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">valid_cpts</span><span class="p">)</span>

    <span class="c1"># now moving window through this array</span>
    <span class="n">n_windows</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_sds</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">trim_rna_params</span><span class="o">.</span><span class="n">moving_window_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s_bytes</span> <span class="o">=</span> <span class="n">window_sds</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">moving_window_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">window_sds</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_windows</span><span class="p">,</span> <span class="n">trim_rna_params</span><span class="o">.</span><span class="n">moving_window_size</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">s_bytes</span><span class="p">,</span> <span class="n">s_bytes</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">moving_window_sds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">trim_rna_params</span><span class="o">.</span><span class="n">thresh_scale</span>

    <span class="n">n_windows</span> <span class="o">=</span> <span class="p">(</span><span class="n">moving_window_sds</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">trim_rna_params</span><span class="o">.</span><span class="n">min_running_values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s_bytes</span> <span class="o">=</span> <span class="n">moving_window_sds</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">running_mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">moving_window_sds</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_windows</span><span class="p">,</span> <span class="n">trim_rna_params</span><span class="o">.</span><span class="n">min_running_values</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">s_bytes</span><span class="p">,</span> <span class="n">s_bytes</span><span class="p">))</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pos_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">running_mins</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">valid_cpts</span><span class="p">[</span><span class="n">pos_index</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">identify_stalls</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">stall_params</span><span class="p">,</span> <span class="n">return_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify locations where bases have stalled in the pore. Two methods</span>
<span class="sd">    availble depending on parameters specified in stall_params.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">compute_running_mean_diffs</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Compute average difference between n_window neighboring window means</span>
<span class="sd">        each of size window_size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">moving_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">)</span>
        <span class="n">moving_average</span><span class="p">[</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">moving_average</span><span class="p">[</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span><span class="p">:]</span> <span class="o">-</span>
            <span class="n">moving_average</span><span class="p">[:</span><span class="o">-</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span><span class="p">])</span>
        <span class="n">moving_average</span> <span class="o">=</span> <span class="n">moving_average</span><span class="p">[</span>
            <span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span>

        <span class="c1"># extract moving window averages at n_window offsets</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">moving_average</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="o">*</span> <span class="n">offset</span><span class="p">):</span>
            <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))]</span>
                   <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
                           <span class="n">moving_average</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="o">*</span> <span class="p">(</span>
                               <span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):],]</span>
        <span class="c1"># compute difference between all pairwise offset</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span><span class="p">)]</span>

        <span class="c1"># compute average over offset differences at each valid position</span>
        <span class="n">diff_sums</span> <span class="o">=</span> <span class="n">diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">diff_i</span> <span class="ow">in</span> <span class="n">diffs</span><span class="p">:</span>
            <span class="n">diff_sums</span> <span class="o">+=</span> <span class="n">diff_i</span>
        <span class="k">return</span> <span class="n">diff_sums</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>


    <span class="c1"># if the raw signal is too short to compute stall metrics</span>
    <span class="k">if</span> <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_metric</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># identify potentially stalled signal from either running window means</span>
    <span class="c1"># or running percentile difference methods</span>
    <span class="n">stall_metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">stall_metric</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">start_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">end_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span>
                  <span class="o">+</span> <span class="n">start_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">lower_pctl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
        <span class="n">stall_params</span><span class="o">.</span><span class="n">upper_pctl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">stall_metric</span><span class="p">[</span><span class="n">start_offset</span><span class="p">:</span><span class="n">end_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_compute_running_pctl_diffs</span><span class="p">(</span>
            <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">lower_pctl</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">upper_pctl</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
          <span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span> <span class="o">==</span>
                <span class="n">stall_params</span><span class="o">.</span><span class="n">mini_window_size</span> <span class="o">*</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">n_windows</span><span class="p">)</span>
        <span class="n">stall_metric</span><span class="p">[</span><span class="n">start_offset</span><span class="p">:</span><span class="n">end_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_running_mean_diffs</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Must provide method specific parameters for stall detection&#39;</span><span class="p">)</span>

    <span class="c1"># identify contiguous windows over threshold for minimal stretches</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">stall_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[[</span><span class="kc">False</span><span class="p">],</span> <span class="n">stall_metric</span> <span class="o">&lt;=</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">threshold</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stall_metric</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
        <span class="n">stall_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">stall_locs</span><span class="p">,</span> <span class="p">[</span><span class="n">stall_metric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">stall_locs</span> <span class="o">=</span> <span class="n">stall_locs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">stall_locs</span> <span class="o">=</span> <span class="n">stall_locs</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stall_locs</span><span class="p">)</span> <span class="o">&gt;</span>
                             <span class="n">stall_params</span><span class="o">.</span><span class="n">min_consecutive_obs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">stall_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_metric</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">stall_metric</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># expand windows out to region that gave result below threshold</span>
    <span class="c1"># since windows are centered (minus edge buffer)</span>
    <span class="n">expand_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">stall_params</span><span class="o">.</span><span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">stall_params</span><span class="o">.</span><span class="n">edge_buffer</span>
    <span class="k">if</span> <span class="n">expand_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">stall_locs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">expand_width</span>
        <span class="n">stall_locs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">expand_width</span>
        <span class="c1"># collapse intervals that now overlap</span>
        <span class="n">merged_stall_locs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_int</span> <span class="o">=</span> <span class="n">stall_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">curr_int</span> <span class="ow">in</span> <span class="n">stall_locs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">curr_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># add previous interval to all intervals</span>
                <span class="n">merged_stall_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_int</span><span class="p">)</span>
                <span class="n">prev_int</span> <span class="o">=</span> <span class="n">curr_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># extend previous interval since these overlap</span>
                <span class="n">prev_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">merged_stall_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev_int</span><span class="p">)</span>
        <span class="n">stall_locs</span> <span class="o">=</span> <span class="n">merged_stall_locs</span>

    <span class="k">if</span> <span class="n">return_metric</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stall_locs</span><span class="p">,</span> <span class="n">stall_metric</span>
    <span class="k">return</span> <span class="n">stall_locs</span>

<div class="viewcode-block" id="calc_kmer_fitted_shift_scale"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.calc_kmer_fitted_shift_scale">[docs]</a><span class="k">def</span> <span class="nf">calc_kmer_fitted_shift_scale</span><span class="p">(</span>
        <span class="n">prev_shift</span><span class="p">,</span> <span class="n">prev_scale</span><span class="p">,</span> <span class="n">r_event_means</span><span class="p">,</span> <span class="n">r_model_means</span><span class="p">,</span>
        <span class="n">r_model_inv_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;theil_sen&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use robust Theil-Sen estimator to compute fitted shift and scale</span>
<span class="sd">    parameters based on read sequence</span>

<span class="sd">    Args:</span>
<span class="sd">        prev_shift (float): previous shift parameter</span>
<span class="sd">        prev_scale (float): previous scale parameter</span>
<span class="sd">        r_ref_means (`np.array::np.float64`): expected base signal levels</span>
<span class="sd">        r_ref_sds (`np.array::np.float64`): expected base signal level sds</span>
<span class="sd">        r_model_inv_vars (`np.array::np.float64`): expected base signal level</span>
<span class="sd">            inverse variances for method of moments (`mom`) computation</span>
<span class="sd">        method (str): one of `theil_sen`, `robust`, or `mom`</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sequence-fitted scaling parameters</span>

<span class="sd">        1) shift parameter (float)</span>
<span class="sd">        2) scale parameter (float)</span>
<span class="sd">        3) shift correction factor; multiply by ``prev_scale`` and add to ``prev_shift`` to get ``shift`` (float)</span>
<span class="sd">        4) scale correction factor; multiply by ``prev_scale`` to get ``scale`` (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;robust&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">read_lad_objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">r_event_means</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                                 <span class="n">r_model_means</span><span class="p">))</span>

        <span class="n">shift_corr_factor</span><span class="p">,</span> <span class="n">scale_corr_factor</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="n">read_lad_objective</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nelder-mead&#39;</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">})</span><span class="o">.</span><span class="n">x</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;theil_sen&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">compute_slopes</span><span class="p">(</span><span class="n">r_event_means</span><span class="p">,</span> <span class="n">r_model_means</span><span class="p">):</span>
            <span class="c1"># despite computing each diff twice this vectorized solution is</span>
            <span class="c1"># about 10X faster than a list comprehension approach</span>
            <span class="n">delta_event</span> <span class="o">=</span> <span class="n">r_event_means</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_event_means</span>
            <span class="n">delta_model</span> <span class="o">=</span> <span class="n">r_model_means</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_model_means</span>
            <span class="k">return</span> <span class="n">delta_model</span><span class="p">[</span><span class="n">delta_event</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">delta_event</span><span class="p">[</span><span class="n">delta_event</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">n_points</span> <span class="o">=</span> <span class="n">r_model_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># potentially sample points for long reads (&gt;1kb)</span>
        <span class="k">if</span> <span class="n">r_model_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_POINTS_FOR_THEIL_SEN</span><span class="p">:</span>
            <span class="n">n_points</span> <span class="o">=</span> <span class="n">MAX_POINTS_FOR_THEIL_SEN</span>
            <span class="n">samp_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">r_model_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">r_model_means</span> <span class="o">=</span> <span class="n">r_model_means</span><span class="p">[</span><span class="n">samp_ind</span><span class="p">]</span>
            <span class="n">r_event_means</span> <span class="o">=</span> <span class="n">r_event_means</span><span class="p">[</span><span class="n">samp_ind</span><span class="p">]</span>
        <span class="c1"># compute Theil-Sen slope estimator</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">c_compute_slopes</span><span class="p">(</span><span class="n">r_event_means</span><span class="p">,</span> <span class="n">r_model_means</span><span class="p">))</span>
        <span class="n">inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r_model_means</span> <span class="o">-</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">r_event_means</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">slope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Read failed sequence-based signal &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;re-scaling parameter estimation.&#39;</span><span class="p">)</span>
        <span class="c1"># convert to shift and scale parameters (e.g. (obs - shift) / scale)</span>
        <span class="n">scale_corr_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">slope</span>
        <span class="n">shift_corr_factor</span> <span class="o">=</span> <span class="o">-</span><span class="n">inter</span> <span class="o">/</span> <span class="n">slope</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mom&#39;</span><span class="p">:</span>
        <span class="n">model_mean_var</span> <span class="o">=</span> <span class="n">r_model_means</span> <span class="o">*</span> <span class="n">r_model_inv_vars</span>
        <span class="c1"># prep kmer model coefficient matrix for the k-mers from this read</span>
        <span class="n">model_mean_var_sum</span> <span class="o">=</span> <span class="n">model_mean_var</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
            <span class="p">(</span><span class="n">r_model_inv_vars</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">model_mean_var_sum</span><span class="p">),</span>
            <span class="p">(</span><span class="n">model_mean_var_sum</span><span class="p">,</span> <span class="p">(</span><span class="n">model_mean_var</span> <span class="o">*</span> <span class="n">r_model_means</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())))</span>

        <span class="c1"># prep dependent values from this reads true events</span>
        <span class="n">r_event_var</span> <span class="o">=</span> <span class="n">r_event_means</span> <span class="o">*</span> <span class="n">r_model_inv_vars</span>
        <span class="n">r_event_var_mean</span> <span class="o">=</span> <span class="n">r_event_var</span> <span class="o">*</span> <span class="n">r_model_means</span>
        <span class="n">dep_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">r_event_var</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">r_event_var_mean</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="n">shift_corr_factor</span><span class="p">,</span> <span class="n">scale_corr_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
            <span class="n">coef_mat</span><span class="p">,</span> <span class="n">dep_vect</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Invalid k-mer fitted normalization parameter method: &#39;</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span>
            <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">Valid methods are &quot;robust&quot; and &quot;mom&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># apply shift and scale values fitted from kmer conditional model</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">prev_shift</span> <span class="o">+</span> <span class="p">(</span><span class="n">shift_corr_factor</span> <span class="o">*</span> <span class="n">prev_scale</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">prev_scale</span> <span class="o">*</span> <span class="n">scale_corr_factor</span>

    <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shift_corr_factor</span><span class="p">,</span> <span class="n">scale_corr_factor</span></div>

<span class="k">def</span> <span class="nf">estimate_global_scale</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="n">NUM_READS_FOR_SCALE</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Estimating global scale parameter.&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">)</span>
    <span class="n">read_mads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_reads</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Total reads processed&#39;</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fast5_fn</span> <span class="ow">in</span> <span class="n">fast5_fns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fast5_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
                <span class="n">all_sig</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)[</span><span class="s1">&#39;Signal&#39;</span><span class="p">][:]</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_sig</span><span class="p">)</span>
            <span class="n">read_mads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_sig</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_mads</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_reads</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_mads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No reads contain raw signal for &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;global scale parameter estimation.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_mads</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_reads</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Few reads contain raw signal for global scale parameter &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;estimation. Results may not be optimal.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">read_mads</span><span class="p">)</span>

<div class="viewcode-block" id="normalize_raw_signal"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.normalize_raw_signal">[docs]</a><span class="k">def</span> <span class="nf">normalize_raw_signal</span><span class="p">(</span>
        <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">read_start_rel_to_raw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">read_obs_len</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">norm_type</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scale_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event_means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_inv_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">const_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply scaling and windsorizing parameters to normalize raw signal.</span>

<span class="sd">    Args:</span>
<span class="sd">        all_raw_signal (`np.array`): raw nanopore signal obervation values</span>
<span class="sd">        read_start_rel_to_raw (int): amount of signal to trim from beginning of</span>
<span class="sd">            the signal (default: 0)</span>
<span class="sd">        read_obs_len (int): length of signal to process from</span>
<span class="sd">            `read_start_rel_to_raw` (default: full length)</span>
<span class="sd">        norm_type (str): normalization type (`median` (default), `none`,</span>
<span class="sd">            `pA_raw`, `pA`, `median_const_scale`, `robust_median`; ignored is</span>
<span class="sd">            ``scale_values`` provided)</span>
<span class="sd">        outlier_thresh (float): windsorizing threshold (MAD units; default: None)</span>
<span class="sd">        channel_info (:class:`tombo.tombo_helper.channelInfo`): channel</span>
<span class="sd">            information (optional; only for `pA` and `pA_raw`)</span>
<span class="sd">        scale_values (:class:`tombo.tombo_helper.scaleValues`): scaling values</span>
<span class="sd">            (optional)</span>
<span class="sd">        event_means (`np.array`): for `pA` fitted scaling parameters (optional)</span>
<span class="sd">        model_means (`np.array`): for `pA` fitted scaling parameters (optional)</span>
<span class="sd">        model_inv_vars (`np.array`): for `pA` fitted scaling parameters</span>
<span class="sd">            (optional)</span>
<span class="sd">        const_scale (float): global scale parameter (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Normalized signal and scaling parameters</span>

<span class="sd">        1) normalized signal observations (`np.array::np.float64`)</span>
<span class="sd">        2) :class:`tombo.tombo_helper.scaleValues`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">read_obs_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">read_obs_len</span> <span class="o">=</span> <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">read_start_rel_to_raw</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NORM_TYPES</span> <span class="ow">and</span> <span class="n">scale_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s1">&#39;Normalization type &#39;</span> <span class="o">+</span> <span class="n">norm_type</span> <span class="o">+</span> <span class="s1">&#39; is not a valid &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;option and shift or scale parameters were not provided.&#39;</span><span class="p">)</span>

    <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">all_raw_signal</span><span class="p">[</span><span class="n">read_start_rel_to_raw</span><span class="p">:</span>
                                <span class="n">read_start_rel_to_raw</span> <span class="o">+</span> <span class="n">read_obs_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">scale_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;pA_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;pA&#39;</span><span class="p">):</span>
            <span class="c1"># correct raw signal as described here:</span>
            <span class="c1">#     https://community.nanoporetech.com</span>
            <span class="c1">#           /posts/squiggle-plot-for-raw-data</span>
            <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">channel_info</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                <span class="n">channel_info</span><span class="o">.</span><span class="n">digitisation</span> <span class="o">/</span> <span class="n">channel_info</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;pA&#39;</span><span class="p">:</span>
                <span class="c1"># perform k-mer model fitted correction as in</span>
                <span class="c1"># nanocorr/nanopolish/albacore(pre-RNN)</span>
                <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calc_kmer_fitted_shift_scale</span><span class="p">(</span>
                    <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">model_means</span><span class="p">,</span> <span class="n">model_inv_vars</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mom&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">raw_signal</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;median_const_scale&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">const_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">const_scale</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;robust_median&#39;</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">ROBUST_QUANTS</span><span class="p">))</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">raw_signal</span> <span class="o">-</span> <span class="n">shift</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">scale_values</span><span class="o">.</span><span class="n">shift</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale_values</span><span class="o">.</span><span class="n">scale</span>

    <span class="n">norm_signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_signal</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>

    <span class="c1"># windsorize the raw signal</span>
    <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">outlier_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">scale_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outlier_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">)</span>
            <span class="n">read_mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm_signal</span> <span class="o">-</span> <span class="n">read_med</span><span class="p">))</span>
            <span class="n">lower_lim</span> <span class="o">=</span> <span class="n">read_med</span> <span class="o">-</span> <span class="p">(</span><span class="n">read_mad</span> <span class="o">*</span> <span class="n">outlier_thresh</span><span class="p">)</span>
            <span class="n">upper_lim</span> <span class="o">=</span> <span class="n">read_med</span> <span class="o">+</span> <span class="p">(</span><span class="n">read_mad</span> <span class="o">*</span> <span class="n">outlier_thresh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_lim</span> <span class="o">=</span> <span class="n">scale_values</span><span class="o">.</span><span class="n">lower_lim</span>
            <span class="n">upper_lim</span> <span class="o">=</span> <span class="n">scale_values</span><span class="o">.</span><span class="n">upper_lim</span>
        <span class="c1"># provided scale values could contain None winsorizing limits still</span>
        <span class="k">if</span> <span class="n">lower_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">upper_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_signal</span> <span class="o">=</span> <span class="n">c_apply_outlier_thresh</span><span class="p">(</span>
                <span class="n">norm_signal</span><span class="p">,</span> <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">norm_signal</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">scaleValues</span><span class="p">(</span>
        <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">,</span> <span class="n">outlier_thresh</span><span class="p">)</span></div>


<span class="c1">#############################</span>
<span class="c1">##### Tombo Model Class #####</span>
<span class="c1">#############################</span>

<div class="viewcode-block" id="TomboModel"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel">[docs]</a><span class="k">class</span> <span class="nc">TomboModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load, store and access Tombo model attributes and sequence-based</span>
<span class="sd">            expected mean and standard deviation levels (median normalization</span>
<span class="sd">            only).</span>

<span class="sd">    .. automethod:: __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_center_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift_corr_factor</span><span class="p">,</span> <span class="n">scale_corr_factor</span><span class="p">):</span>
        <span class="n">centered_means</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">k_mean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">centered_means</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">k_mean</span> <span class="o">*</span> <span class="n">scale_corr_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift_corr_factor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">centered_means</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_make_constant_sd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">med_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">med_sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="TomboModel.write_model"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.write_model">[docs]</a>    <span class="k">def</span> <span class="nf">write_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write TomboModel to specified file</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_fn (str): filename to write TomboModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Explicity use btype string names for py3 compatiblity as well as</span>
        <span class="c1"># pickle-ability of numpy arrays for consistency. See discussion here:</span>
        <span class="c1"># https://github.com/numpy/numpy/issues/2407</span>
        <span class="n">ref_for_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;kmer&#39;</span><span class="p">),</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">)),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ref_for_file</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;central_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STANDARD_MODEL_NAME</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_parse_tombo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a tombo model file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
                <span class="n">ref_raw</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][:]</span>
                <span class="n">central_pos</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;central_pos&#39;</span><span class="p">)</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid Tombo model file provided: &#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="o">!=</span> <span class="n">STANDARD_MODEL_NAME</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Non-standard Tombo model provided.&#39;</span><span class="p">)</span>

        <span class="n">mean_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_std</span> <span class="ow">in</span> <span class="n">ref_raw</span><span class="p">:</span>
            <span class="n">kmer</span> <span class="o">=</span> <span class="n">kmer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">mean_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
            <span class="n">sd_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_std</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model_name</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_parse_text_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a text model file (such as those from nanopolish)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mean_ref</span><span class="p">,</span> <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_sd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_sd</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_sd</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># header or other non-kmer field</span>
                        <span class="k">continue</span>
                    <span class="n">mean_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
                    <span class="n">sd_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_sd</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Invalid text pA model file provided: &#39;</span>
                                       <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">NANOPOLISH_CENTRAL_POS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">STANDARD_MODEL_NAME</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmer_ref</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">):</span>
        <span class="n">mean_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_std</span> <span class="ow">in</span> <span class="n">kmer_ref</span><span class="p">:</span>
            <span class="c1"># reference may or may not be stored as a numpy array</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kmer</span> <span class="o">=</span> <span class="n">kmer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">mean_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
            <span class="n">sd_ref</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_std</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">STANDARD_MODEL_NAME</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_add_invvar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">stdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">stdev</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_default_standard_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">is_sample_rna</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
                    <span class="s1">&#39;Loading default canonical ***** RNA ***** model.&#39;</span><span class="p">)</span>
            <span class="n">std_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">RNA_SAMP_TYPE</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
                    <span class="s1">&#39;Loading default canonical ***** DNA ***** model.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">std_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">DNA_SAMP_TYPE</span><span class="p">]</span>
        <span class="c1"># get full filename path with setuptools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">std_ref_fn</span><span class="p">))</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_default_standard_ref_from_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast5_fns</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">th</span><span class="o">.</span><span class="n">is_sample_rna</span><span class="p">(</span><span class="n">fast5_fns</span><span class="o">=</span><span class="n">fast5_fns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
                    <span class="s1">&#39;Loading default canonical ***** RNA ***** model.&#39;</span><span class="p">)</span>
            <span class="n">std_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">RNA_SAMP_TYPE</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
                    <span class="s1">&#39;Loading default canonical ***** DNA ***** model.&#39;</span><span class="p">)</span>
            <span class="n">std_ref_fn</span> <span class="o">=</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span><span class="n">DNA_SAMP_TYPE</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># get full filename path with setuptools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">std_ref_fn</span><span class="p">))</span>

        <span class="k">return</span>

<div class="viewcode-block" id="TomboModel.__init__"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ref_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_text_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kmer_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">central_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reads_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fast5_fns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minimal_startup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Tombo k-mer model object</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_fn (str): tombo model filename</span>
<span class="sd">            is_text_model (bool): `ref_fn` is text (e.g.</span>
<span class="sd">                https://github.com/nanoporetech/kmer_models/blob/master/r9.4_180mv_450bps_6mer/template_median68pA.model)</span>
<span class="sd">            kmer_ref (list): containing 3-tuples 1) k-mer 2) expected level 3)</span>
<span class="sd">                level SD</span>
<span class="sd">            central_pos (int): base within k-mer to assign signal (only</span>
<span class="sd">                applicable when `kmer_ref` is provided)</span>
<span class="sd">            seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`):</span>
<span class="sd">                sequencing sample type (default: None)</span>
<span class="sd">            reads_index (:class:`tombo.tombo_helper.TomboReads`): For</span>
<span class="sd">                determining `seq_samp_type`</span>
<span class="sd">            fast5_fns (list): fast5 read filenames from which to extract read</span>
<span class="sd">                metadata. For determining `seq_samp_type`</span>
<span class="sd">            minimal_startup (bool): don&#39;t compute inverse variances (default</span>
<span class="sd">                True)</span>

<span class="sd">        Note:</span>

<span class="sd">            Order of priority for initialization when multiple model</span>
<span class="sd">                specifications are provided:</span>
<span class="sd">                1) `ref_fn`</span>
<span class="sd">                2) `kmer_ref` (requires `central_pos`)</span>
<span class="sd">                3) `seq_samp_type`</span>
<span class="sd">                4) `reads_index`</span>
<span class="sd">                5) `fast5_fns`</span>

<span class="sd">            Last 3 options load a default model file included with Tombo. Last</span>
<span class="sd">                2 determine the sample type from read metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ref_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">ref_fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_text_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_text_model</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tombo_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">seq_samp_type</span>
        <span class="k">elif</span> <span class="n">kmer_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">central_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;central_pos must be provided is TomboModel is loaded &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;with a kmer_ref&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">(</span><span class="n">kmer_ref</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">seq_samp_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">seq_samp_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
                    <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">STANDARD_MODELS</span><span class="p">[</span>
                        <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">reads_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_standard_ref</span><span class="p">(</span><span class="n">reads_index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fast5_fns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_standard_ref_from_files</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;Must provide initialization method for TomboModel.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tombo_model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal_startup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_invvar</span><span class="p">()</span></div>

<div class="viewcode-block" id="TomboModel.reverse_sequence_copy"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.reverse_sequence_copy">[docs]</a>    <span class="k">def</span> <span class="nf">reverse_sequence_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of model for processing sequence/signal in reverse</span>
<span class="sd">        (default models are all saved in genome sequence forward (5p to 3p)</span>
<span class="sd">        direction)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rev_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rev_model</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">rev_model</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">kmer</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">kmer_mean</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_mean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">rev_model</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">kmer</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">kmer_sds</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_sds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rev_model</span><span class="o">.</span><span class="n">inv_var</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">kmer</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">kmer_inv_var</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_inv_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">rev_model</span></div>

<div class="viewcode-block" id="TomboModel.get_exp_levels_from_seq"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.get_exp_levels_from_seq">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_levels_from_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">rev_strand</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute expected signal levels for a sequence</span>

<span class="sd">        Args:</span>
<span class="sd">            seq (str): genomic seqeunce to be converted to expected signal</span>
<span class="sd">                levels</span>
<span class="sd">            rev_strand (bool): provided sequence is from reverse strand (so</span>
<span class="sd">                flip return order to genome forward direction)</span>

<span class="sd">        Note:</span>
<span class="sd">            Returned expected signal levels will be trimmed compared to the</span>
<span class="sd">            passed sequence based on the `std_ref.kmer_width` and</span>
<span class="sd">            `std_ref.central_pos`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Expected signal level references</span>
<span class="sd">            1) ref_means (`np.array::np.float64`) expected signal levels</span>
<span class="sd">            2) ref_sds (`np.array::np.float64`) expected signal level sds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_kmers</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_kmers</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">,</span> <span class="n">rev_strand</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
            <span class="n">ref_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid sequence encountered from genome sequence.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span></div>

<div class="viewcode-block" id="TomboModel.get_exp_levels_from_kmers"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.get_exp_levels_from_kmers">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_levels_from_kmers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_kmers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up expected signal levels for a list of k-mers</span>

<span class="sd">        Args:</span>
<span class="sd">            seq_kmers (list): list of k-mers (as returned from</span>
<span class="sd">                :class:`tombo.tombo_helper.get_seq_kmers`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Expected signal level references</span>

<span class="sd">            1) ref_means (`np.array::np.float64`) expected signal levels</span>
<span class="sd">            2) ref_sds (`np.array::np.float64`) expected signal level sds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
            <span class="n">ref_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">seq_kmers</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid sequence encountered from genome sequence.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span></div>

<div class="viewcode-block" id="TomboModel.get_exp_levels_from_seq_with_gaps"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboModel.get_exp_levels_from_seq_with_gaps">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_levels_from_seq_with_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_seq</span><span class="p">,</span> <span class="n">rev_strand</span><span class="p">):</span>
        <span class="c1"># loop over regions without valid sequence (non-ACGT)</span>
        <span class="n">reg_ref_means</span><span class="p">,</span> <span class="n">reg_ref_sds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">reg_ref_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">reg_ref_sds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">prev_ibr_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">inv_base_run_m</span> <span class="ow">in</span> <span class="n">th</span><span class="o">.</span><span class="n">INVALID_BASE_RUNS</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">):</span>
            <span class="n">ibr_start</span><span class="p">,</span> <span class="n">ibr_end</span> <span class="o">=</span> <span class="n">inv_base_run_m</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">inv_base_run_m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="c1"># if valid region is too short continue</span>
            <span class="k">if</span> <span class="n">ibr_start</span> <span class="o">-</span> <span class="n">prev_ibr_end</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">:</span>
                <span class="n">prev_ibr_end</span> <span class="o">=</span> <span class="n">ibr_end</span>
                <span class="k">continue</span>
            <span class="n">subreg_ref_means</span><span class="p">,</span> <span class="n">subreg_ref_sds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span>
                <span class="n">reg_seq</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:</span><span class="n">ibr_start</span><span class="p">])</span>
            <span class="n">reg_ref_means</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:</span>
                          <span class="n">ibr_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subreg_ref_means</span>
            <span class="n">reg_ref_sds</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:</span>
                        <span class="n">ibr_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subreg_ref_sds</span>
            <span class="n">prev_ibr_end</span> <span class="o">=</span> <span class="n">ibr_end</span>

        <span class="c1"># if there is valid sequence at the end of a region include it here</span>
        <span class="k">if</span> <span class="n">prev_ibr_end</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">:</span>
            <span class="n">subreg_ref_means</span><span class="p">,</span> <span class="n">subreg_ref_sds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span>
                <span class="n">reg_seq</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:])</span>
            <span class="n">reg_ref_means</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:]</span> <span class="o">=</span> <span class="n">subreg_ref_means</span>
            <span class="n">reg_ref_sds</span><span class="p">[</span><span class="n">prev_ibr_end</span><span class="p">:]</span> <span class="o">=</span> <span class="n">subreg_ref_sds</span>

        <span class="k">if</span> <span class="n">rev_strand</span><span class="p">:</span>
            <span class="n">reg_ref_means</span> <span class="o">=</span> <span class="n">reg_ref_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">reg_ref_sds</span> <span class="o">=</span> <span class="n">reg_ref_sds</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">reg_ref_means</span><span class="p">,</span> <span class="n">reg_ref_sds</span></div></div>


<div class="viewcode-block" id="AltModel"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel">[docs]</a><span class="k">class</span> <span class="nc">AltModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load, store and access alternate-base Tombo model attributes and</span>
<span class="sd">    sequence-based expected mean and standard deviation levels (median</span>
<span class="sd">    normalization only).</span>

<span class="sd">    .. automethod:: __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AltModel.write_model"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel.write_model">[docs]</a>    <span class="k">def</span> <span class="nf">write_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write AltModel to specified file</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_fn (str): filename to write AltModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Explicity use btype string names for py3 compatiblity as well as</span>
        <span class="c1"># pickle-ability of numpy arrays for consistency. See discussion here:</span>
        <span class="c1"># https://github.com/numpy/numpy/issues/2407</span>
        <span class="n">ref_for_file</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)])</span>
             <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;kmer&#39;</span><span class="p">),</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">)),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)])</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ref_for_file</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;central_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alt_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;motif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">raw_motif</span>
            <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mod_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_make_constant_sd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">med_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">med_sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_parse_alt_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse an alternate-base Tombo model file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ref_fp</span><span class="p">:</span>
                <span class="n">ref_raw</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][:]</span>
                <span class="n">central_pos</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;central_pos&#39;</span><span class="p">)</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="n">alt_base</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alt_base&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alt_base</span> <span class="o">=</span> <span class="n">alt_base</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="n">raw_motif</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;motif&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">raw_motif</span> <span class="o">=</span> <span class="n">raw_motif</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="n">mod_pos</span> <span class="o">=</span> <span class="n">ref_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mod_pos&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid alternate-base tombo model file provided: &#39;</span>
                <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span><span class="p">))</span>

        <span class="n">mean_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_std</span> <span class="ow">in</span> <span class="n">ref_raw</span><span class="p">:</span>
            <span class="n">kmer</span> <span class="o">=</span> <span class="n">kmer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">mean_ref</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
            <span class="n">sd_ref</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kmer_std</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span> <span class="o">=</span> <span class="n">alt_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="n">raw_motif</span><span class="p">,</span> <span class="n">mod_pos</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_load_alt_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt_ref</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">motif</span><span class="p">):</span>
        <span class="n">mean_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sd_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kmer_mean</span><span class="p">,</span> <span class="n">kmer_std</span> <span class="ow">in</span> <span class="n">alt_ref</span><span class="p">:</span>
            <span class="c1"># reference may or may not be stored as a numpy array</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kmer</span> <span class="o">=</span> <span class="n">kmer</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">mean_ref</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kmer_mean</span>
            <span class="n">sd_ref</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span> <span class="o">=</span> <span class="n">kmer_std</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">mean_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sds</span> <span class="o">=</span> <span class="n">sd_ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">=</span> <span class="n">central_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span> <span class="o">=</span> <span class="n">alt_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">motif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">motif</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">motif</span> <span class="o">=</span> <span class="n">motif</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_add_invvar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kmer_pos</span><span class="p">,</span> <span class="n">stdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span><span class="p">[</span><span class="n">kmer_pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">stdev</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>

        <span class="k">return</span>

<div class="viewcode-block" id="AltModel.__init__"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ref_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmer_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">central_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">motif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minimal_startup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Tombo k-mer model object</span>

<span class="sd">        Args:</span>
<span class="sd">            ref_fn (str): tombo model filename</span>
<span class="sd">            kmer_ref (list): containing 3-tuples 1) k-mer 2) expected level 3)</span>
<span class="sd">                level SD</span>
<span class="sd">            central_pos (int): base within k-mer to assign signal (only</span>
<span class="sd">                applicable when `kmer_ref` is provided)</span>
<span class="sd">            alt_base (int): &quot;swap&quot; base within k-mer (only applicable when</span>
<span class="sd">                `kmer_ref` is provided)</span>
<span class="sd">            name (str): model name (only applicable when `kmer_ref` is provided)</span>
<span class="sd">            motif (:class:`tombo.tombo_helper.TomboMotif`): model motif</span>
<span class="sd">                (defaults to alt_base motif; only applicable when `kmer_ref` is</span>
<span class="sd">                provided)</span>
<span class="sd">            minimal_startup (bool): don&#39;t compute inverse variances (default</span>
<span class="sd">                True)</span>

<span class="sd">        Note:</span>

<span class="sd">            ``kmer_ref``, ``central_pos``, ``alt_base``, ``name`` and ``motif``</span>
<span class="sd">                are ignored if ``ref_fn`` is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ref_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">ref_fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_alt_model</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">kmer_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">central_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">alt_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;central_pos and alt_base must be provided if AltModel is &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;loaded with a kmer_ref&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_alt_model</span><span class="p">(</span><span class="n">kmer_ref</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">motif</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Must provide initialization method for AltModel.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">kmer</span> <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inv_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal_startup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_invvar</span><span class="p">()</span></div>

<div class="viewcode-block" id="AltModel.get_exp_level"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel.get_exp_level">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span></div>

<div class="viewcode-block" id="AltModel.get_exp_sd"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel.get_exp_sd">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_sd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sds</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span></div>

<div class="viewcode-block" id="AltModel.get_exp_levels_from_kmers"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.AltModel.get_exp_levels_from_kmers">[docs]</a>    <span class="k">def</span> <span class="nf">get_exp_levels_from_kmers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_kmers</span><span class="p">,</span> <span class="n">rev_strand</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look up expected alternate-base signal levels across a central base.</span>
<span class="sd">        Alternative base to test should be last base in the first k-mer and</span>
<span class="sd">        first base in the last k-mer</span>

<span class="sd">        Args:</span>
<span class="sd">            seq_kmers (list): list of k-mers the same length as the k-mer</span>

<span class="sd">        Returns:</span>
<span class="sd">            Expected signal level references</span>

<span class="sd">            1) ref_means (`np.array::np.float64`) expected signal levels</span>
<span class="sd">            2) ref_sds (`np.array::np.float64`) expected signal level sds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">rev_strand</span> <span class="k">else</span>
                     <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_exp_level</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">seq_kmers</span><span class="p">,</span> <span class="n">pos_range</span><span class="p">)])</span>
            <span class="n">ref_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_exp_sd</span><span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">seq_kmers</span><span class="p">,</span> <span class="n">pos_range</span><span class="p">)])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Invalid sequence encountered from genome sequence.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span></div></div>


<span class="c1">############################</span>
<span class="c1">##### Model Estimation #####</span>
<span class="c1">############################</span>

<span class="k">def</span> <span class="nf">check_valid_alt_models</span><span class="p">(</span><span class="n">alt_refs</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse several alternative tombo model files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">alt_ref</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">!=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="ow">or</span>
            <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">!=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Standard and &#39;</span> <span class="o">+</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">+</span> <span class="s1">&#39; alternative base &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;models must be estimated using the same k-mer positions.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_ref</span><span class="p">,</span> <span class="n">AltModel</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Alternative model &#39;</span> <span class="o">+</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">ref_fn</span> <span class="o">+</span> <span class="s1">&#39; appears to be a &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;standard model and will not be processed.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">alt_refs</span>

<span class="k">def</span> <span class="nf">_print_alt_models</span><span class="p">():</span>
    <span class="n">alt_model_types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">mod_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ALT_MODEL_SEP_CHAR</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">ALTERNATE_MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">alt_seq_samps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alt_model_types</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">alt_mods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alt_model_types</span><span class="p">))[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">row_format</span> <span class="o">=</span><span class="s2">&quot;</span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alt_seq_samps</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">alt_seq_samps</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">alt_mod</span> <span class="ow">in</span> <span class="n">alt_mods</span><span class="p">:</span>
        <span class="n">has_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_mod</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">seq_samp</span> <span class="ow">in</span> <span class="n">alt_seq_samps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">has_mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; X&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">seq_samp</span><span class="p">,</span> <span class="n">alt_mod</span><span class="p">)</span> <span class="ow">in</span> <span class="n">alt_model_types</span>
                           <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">has_mod</span><span class="p">))</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">load_default_alt_ref</span><span class="p">(</span><span class="n">alt_name</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">ALTERNATE_MODELS</span><span class="p">[</span>
            <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">ALT_MODEL_SEP_CHAR</span> <span class="o">+</span> <span class="n">alt_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># get full filename path with setuptools</span>
        <span class="n">alt_model_fn</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
            <span class="s1">&#39;tombo&#39;</span><span class="p">,</span> <span class="s1">&#39;tombo_models/&#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Tombo default model for &#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39; in &#39;</span> <span class="o">+</span>
            <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; does not exists.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">AltModel</span><span class="p">(</span><span class="n">ref_fn</span><span class="o">=</span><span class="n">alt_model_fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_alt_refs</span><span class="p">(</span><span class="n">alt_model_fns</span><span class="p">,</span> <span class="n">alt_names</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
                  <span class="n">seq_samp_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">alt_refs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">alt_model_fns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># load alternative models from filenames</span>
        <span class="k">for</span> <span class="n">alt_model_fn</span> <span class="ow">in</span> <span class="n">alt_model_fns</span><span class="p">:</span>
            <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">AltModel</span><span class="p">(</span><span class="n">alt_model_fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                    <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; alternative model found in more than &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;one model file. Ignoring: &#39;</span> <span class="o">+</span> <span class="n">alt_model_fn</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">alt_refs</span><span class="p">[</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_ref</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># load alternative models from internal defaults</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">:</span>
            <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">load_default_alt_ref</span><span class="p">(</span><span class="n">alt_name</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alt_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">alt_refs</span><span class="p">[</span><span class="n">alt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">alt_ref</span>

    <span class="n">check_valid_alt_models</span><span class="p">(</span><span class="n">alt_refs</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_refs</span>

<span class="k">def</span> <span class="nf">load_valid_models</span><span class="p">(</span>
        <span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">plot_default_stnd</span><span class="p">,</span> <span class="n">alt_model_fn</span><span class="p">,</span>
        <span class="n">plot_default_alt</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">ctrl_fast5s_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># if no model was requested</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plot_default_stnd</span> <span class="ow">and</span>
        <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plot_default_alt</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">ref_fn</span><span class="o">=</span><span class="n">tb_model_fn</span><span class="p">,</span> <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">AltModel</span><span class="p">(</span><span class="n">ref_fn</span><span class="o">=</span><span class="n">alt_model_fn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_default_alt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">seq_samp_type</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
        <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">load_default_alt_ref</span><span class="p">(</span><span class="n">plot_default_alt</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alt_ref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">ctrl_fast5s_dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tb_model_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Both a second set of FAST5s and a tombo model were &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;provided. Two samples with model plotting is not &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;currently available. Models requested will be ignored.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_ref</span>

<span class="k">def</span> <span class="nf">calc_med_sd</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to compute median and standard deviation from a</span>
<span class="sd">    numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_region_kmer_levels</span><span class="p">(</span>
        <span class="n">reg_data</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span>
        <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">motif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_poss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute mean or median and standard deviation for each k-mer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cs_cov_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># sample reads until requested mean depth of coverage is achieved</span>
        <span class="n">cs_num_bases_thresh</span> <span class="o">=</span> <span class="n">region_size</span> <span class="o">*</span> <span class="n">cs_cov_thresh</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span>
        <span class="n">cumm_num_bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_num_reads</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cumm_num_bases</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">cs_num_bases_thresh</span><span class="p">))</span>
            <span class="n">reg_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reads</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">[:</span><span class="n">cs_num_reads</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># if threshold is not met use all reads from region</span>
            <span class="k">pass</span>
    <span class="c1"># TODO convert this to the intervalData method get_base_levels function</span>
    <span class="c1"># involves a bit of logical refactoring below (which should be much simpler)</span>
    <span class="n">base_events</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_reads_events</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># get intervals within the region where coverage is high enough</span>
    <span class="c1"># for model estimation</span>
    <span class="n">reg_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">base_events</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">base_events</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span><span class="p">)])</span>
    <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[[</span><span class="kc">False</span><span class="p">],</span> <span class="n">reg_cov</span> <span class="o">&gt;</span> <span class="n">cov_thresh</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reg_cov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cov_thresh</span><span class="p">:</span>
        <span class="c1"># if valid coverage goes until end of coverage, add the last</span>
        <span class="c1"># interval endpoint</span>
        <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">cov_intervals</span><span class="p">,</span> <span class="p">[</span><span class="n">region_size</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">cov_intervals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">cov_intervals</span> <span class="o">=</span> <span class="n">cov_intervals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">kmer_width</span> <span class="o">=</span> <span class="n">upstrm_bases</span> <span class="o">+</span> <span class="n">dnstrm_bases</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">motif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">((</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="n">i_offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i_offset</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">find_mod_poss</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)))</span>

    <span class="c1"># upstream and downstream changes the sequence selection</span>
    <span class="c1"># depending on the strand</span>
    <span class="c1"># TODO this will miss motif hits at region boundaries when the motif is</span>
    <span class="c1"># longer than either end of the k-me relative to the central position</span>
    <span class="n">bb</span><span class="p">,</span> <span class="n">ab</span> <span class="o">=</span> <span class="p">(</span><span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">)</span> <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> \
             <span class="p">(</span><span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cov_start</span><span class="p">,</span> <span class="n">cov_end</span> <span class="ow">in</span> <span class="n">cov_intervals</span><span class="p">:</span>
        <span class="c1"># get region sequence from expanded region to include k-mer lookups</span>
        <span class="n">int_seq</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">cov_start</span> <span class="o">-</span> <span class="n">bb</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">cov_end</span> <span class="o">+</span> <span class="n">ab</span><span class="p">)</span><span class="o">.</span><span class="n">add_seq</span><span class="p">()</span><span class="o">.</span><span class="n">seq</span>
        <span class="n">int_len</span> <span class="o">=</span> <span class="n">cov_end</span> <span class="o">-</span> <span class="n">cov_start</span>

        <span class="c1"># get valid positions to include in extracted levels</span>
        <span class="c1"># for standard extraction fill with None relative position</span>
        <span class="k">if</span> <span class="n">valid_poss</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">motif</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_poss</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">int_len</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="c1"># for motif/position extraction record relative modified position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get modified base position relative to coverage interval</span>
            <span class="k">if</span> <span class="n">valid_poss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_poss</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">reg_mod_poss</span> <span class="o">=</span> <span class="p">(</span><span class="n">valid_poss</span><span class="p">[(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span> <span class="o">-</span>
                                <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">cov_start</span><span class="p">)</span>
                <span class="n">reg_mod_poss</span> <span class="o">=</span> <span class="n">reg_mod_poss</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">reg_mod_poss</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">reg_mod_poss</span><span class="p">,</span> <span class="n">int_len</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">reg_mod_poss</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bb</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">int_seq</span><span class="p">)</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bb</span> <span class="o">&lt;</span> <span class="n">int_len</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reg_mod_poss</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="n">bb</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">rev_comp_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">int_seq</span><span class="p">)</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="n">bb</span>
                        <span class="o">&lt;</span> <span class="n">int_len</span><span class="p">]</span>

            <span class="c1"># record relative mod positions within k-mers</span>
            <span class="n">int_poss</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="n">i_offset</span> <span class="o">+</span> <span class="n">bb</span><span class="p">,</span> <span class="n">i_offset</span> <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span>
                 <span class="k">else</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="n">i_offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mod_pos</span> <span class="ow">in</span> <span class="n">reg_mod_poss</span> <span class="k">for</span> <span class="n">i_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmer_width</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">mod_pos</span> <span class="o">-</span> <span class="n">i_offset</span> <span class="o">+</span> <span class="n">bb</span> <span class="o">&lt;</span> <span class="n">int_len</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">int_poss</span><span class="p">:</span>
            <span class="n">pos_kmer</span> <span class="o">=</span> <span class="n">int_seq</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="n">kmer_width</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">pos_kmer</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">pos_kmer</span><span class="p">)</span>
            <span class="c1">#print(pos_kmer, offset,</span>
            <span class="c1">#      pos + reg_data.start + cov_start, reg_data.strand,</span>
            <span class="c1">#      reg_data.start + cov_start - bb,</span>
            <span class="c1">#      reg_data.start + cov_end + ab)</span>
            <span class="n">kmer_key</span> <span class="o">=</span> <span class="n">pos_kmer</span> <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">pos_kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">est_mean</span><span class="p">:</span>
                    <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_mean_std</span><span class="p">(</span>
                        <span class="n">base_events</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">cov_start</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_med_sd</span><span class="p">(</span>
                        <span class="n">base_events</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">cov_start</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">reg_kmer_levels</span>

<span class="k">def</span> <span class="nf">_est_kmer_model_worker</span><span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span>
        <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
        <span class="n">motif</span><span class="p">,</span> <span class="n">valid_poss</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span> <span class="o">=</span> <span class="n">region_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># sometimes throws false empty error with get(block=False)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">region_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="k">continue</span>
            <span class="k">break</span>

        <span class="n">reg_data</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="n">chrm</span><span class="o">=</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">,</span>
            <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span><span class="o">.</span><span class="n">add_reads</span><span class="p">(</span><span class="n">reads_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">get_region_kmer_levels</span><span class="p">(</span>
            <span class="n">reg_data</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
            <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">motif</span><span class="p">,</span> <span class="n">valid_poss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reg_kmer_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
        <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_EST_REF</span><span class="p">:</span>
    <span class="n">_est_kmer_model_wrapper</span> <span class="o">=</span> <span class="n">_est_kmer_model_worker</span>
    <span class="k">def</span> <span class="nf">_est_kmer_model_worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_est_kmer_model_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;est_kmer_model.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">extract_kmer_levels</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
        <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">motif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_poss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">region_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">kmer_level_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">progress_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">num_regions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span> <span class="ow">in</span> <span class="n">reads_index</span><span class="o">.</span><span class="n">iter_cov_regs</span><span class="p">(</span>
            <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">region_size</span><span class="p">):</span>
        <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">))</span>
        <span class="n">num_regions</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">est_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span>
        <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span>
        <span class="n">motif</span><span class="p">,</span> <span class="n">valid_poss</span><span class="p">)</span>
    <span class="n">est_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_est_kmer_model_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">est_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">est_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Extracting average k-mer levels.&#39;</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_reg_kmer_levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">est_ps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">all_reg_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iter_proc</span> <span class="o">=</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_proc</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="c1"># clear rest of queue</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">reg_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_reg_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">iter_proc</span> <span class="o">=</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_proc</span><span class="p">)</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No genomic positions contain --minimum-test-reads. Consider &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;setting this option to a lower value.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_reg_kmer_levels</span>

<span class="k">def</span> <span class="nf">tabulate_kmer_levels</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Tabulating k-mer model statistics.&#39;</span><span class="p">)</span>
    <span class="n">all_kmer_mean_sds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">_DEBUG_EST_NUM_KMER_SAVE</span><span class="p">)</span>
    <span class="n">kmer_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">):</span>
        <span class="n">kmer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kmer_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="k">for</span> <span class="n">reg_kmer_levels</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;At least one k-mer is not covered at any poitions by &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;--minimum-test-reads.</span><span class="se">\n\t\t</span><span class="s1">Consider fitting to a smaller &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;k-mer via the --upstream-bases and --downstream-bases, &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;or lowering --minimum-test-reads.</span><span class="se">\n\t\t</span><span class="s1">Note that this may &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;result in a lower quality model.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kmer_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_kmer_obs</span><span class="p">:</span>
            <span class="n">min_obs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_levs</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)])</span>
                    <span class="k">for</span> <span class="n">reg_levs</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">motif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">motif</span><span class="o">.</span><span class="n">matches_seq</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)))</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;K-mers represeneted in fewer observations than &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;requested in the provided reads. Consider a shorter &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;k-mer or providing more reads.</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; observations found in least common kmer.&#39;</span><span class="p">)</span>
        <span class="n">all_kmer_mean_sds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
            <span class="n">kmer_kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span>
                <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">bw_method</span><span class="o">=</span><span class="n">_DEBUG_EST_BW</span> <span class="o">/</span> <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">kmer_dens</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">save_x</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;debug_est_standard_ref.density.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Kmer</span><span class="se">\t</span><span class="s1">Signal</span><span class="se">\t</span><span class="s1">Density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                               <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens</span>
                               <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">dens_i</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_kmer_mean_sds</span>

<span class="c1"># methods needed for (re-squiggle) segmentation are also needed here for</span>
<span class="c1"># RNA event-based scaling (for model scale centering)</span>
<div class="viewcode-block" id="load_resquiggle_parameters"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.load_resquiggle_parameters">[docs]</a><span class="k">def</span> <span class="nf">load_resquiggle_parameters</span><span class="p">(</span>
        <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">sig_aln_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seg_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_save_bandwidth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load parameters for re-squiggle algorithm</span>

<span class="sd">    Args:</span>
<span class="sd">        seq_samp_type (:class:`tombo.tombo_helper.seqSampleType`): sequencing</span>
<span class="sd">            sample type</span>
<span class="sd">        sig_aln_params (tuple): signal alignment parameters (optional; default:</span>
<span class="sd">            load seq_samp_type defaults)</span>
<span class="sd">        seg_params (tuple): segmentation parameters (optional; default: load</span>
<span class="sd">            seq_samp_type defaults)</span>
<span class="sd">        use_save_bandwidth (bool): load larger &quot;save&quot; bandwidth</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`tombo.tombo_helper.resquiggleParams`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sig_aln_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">match_evalue</span><span class="p">,</span> <span class="n">skip_pen</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">save_bandwidth</span><span class="p">,</span> <span class="n">max_half_z_score</span><span class="p">,</span>
         <span class="n">band_bound_thresh</span><span class="p">,</span> <span class="n">start_bw</span><span class="p">,</span> <span class="n">start_save_bw</span><span class="p">,</span>
         <span class="n">start_n_bases</span><span class="p">)</span> <span class="o">=</span> <span class="n">ALGN_PARAMS_TABLE</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># unpack signal alignment parameters</span>
        <span class="p">(</span><span class="n">match_evalue</span><span class="p">,</span> <span class="n">skip_pen</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">save_bandwidth</span><span class="p">,</span>
         <span class="n">max_half_z_score</span><span class="p">,</span> <span class="n">band_bound_thresh</span><span class="p">,</span> <span class="n">start_bw</span><span class="p">,</span> <span class="n">start_save_bw</span><span class="p">,</span>
         <span class="n">start_n_bases</span><span class="p">)</span> <span class="o">=</span> <span class="n">sig_aln_params</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span>
        <span class="n">save_bandwidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">save_bandwidth</span><span class="p">)</span>
        <span class="n">band_bound_thresh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">band_bound_thresh</span><span class="p">)</span>
        <span class="n">start_bw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_bw</span><span class="p">)</span>
        <span class="n">start_save_bw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_save_bw</span><span class="p">)</span>
        <span class="n">start_n_bases</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_n_bases</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_save_bandwidth</span><span class="p">:</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">save_bandwidth</span>

    <span class="k">if</span> <span class="n">seg_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">,</span> <span class="n">raw_min_obs_per_base</span><span class="p">,</span>
         <span class="n">mean_obs_per_event</span><span class="p">)</span> <span class="o">=</span> <span class="n">SEG_PARAMS_TABLE</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">(</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">,</span> <span class="n">raw_min_obs_per_base</span><span class="p">,</span>
         <span class="n">mean_obs_per_event</span><span class="p">)</span> <span class="o">=</span> <span class="n">seg_params</span>

    <span class="n">z_shift</span><span class="p">,</span> <span class="n">stay_pen</span> <span class="o">=</span> <span class="n">get_dynamic_prog_params</span><span class="p">(</span><span class="n">match_evalue</span><span class="p">)</span>

    <span class="n">rsqgl_params</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">resquiggleParams</span><span class="p">(</span>
        <span class="n">match_evalue</span><span class="p">,</span> <span class="n">skip_pen</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">max_half_z_score</span><span class="p">,</span>
        <span class="n">running_stat_width</span><span class="p">,</span> <span class="n">min_obs_per_base</span><span class="p">,</span> <span class="n">raw_min_obs_per_base</span><span class="p">,</span>
        <span class="n">mean_obs_per_event</span><span class="p">,</span> <span class="n">z_shift</span><span class="p">,</span> <span class="n">stay_pen</span><span class="p">,</span>
        <span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="n">band_bound_thresh</span><span class="p">,</span>
        <span class="n">start_bw</span><span class="p">,</span> <span class="n">start_save_bw</span><span class="p">,</span> <span class="n">start_n_bases</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rsqgl_params</span></div>

<div class="viewcode-block" id="compute_num_events"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.compute_num_events">[docs]</a><span class="k">def</span> <span class="nf">compute_num_events</span><span class="p">(</span>
        <span class="n">signal_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mean_obs_per_event</span><span class="p">,</span>
        <span class="n">min_event_to_seq_ratio</span><span class="o">=</span><span class="n">MIN_EVENT_TO_SEQ_RATIO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute number of events to find for this read</span>

<span class="sd">    Args:</span>
<span class="sd">        signal_len (int): length of raw signal</span>
<span class="sd">        seq_len (int): length of sequence</span>
<span class="sd">        mean_obs_per_base (int): mean raw observations per genome base</span>
<span class="sd">        min_event_to_seq_ratio (float): minimum event to sequence ratio</span>
<span class="sd">            (optional)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of events to find for this read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">signal_len</span> <span class="o">//</span> <span class="n">mean_obs_per_event</span><span class="p">,</span>
               <span class="nb">int</span><span class="p">(</span><span class="n">seq_len</span> <span class="o">*</span> <span class="n">min_event_to_seq_ratio</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">remove_stall_cpts</span><span class="p">(</span><span class="n">stall_ints</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stall_ints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid_cpts</span>

    <span class="c1"># RNA data contains stall regions that can cause problems for</span>
    <span class="c1"># banded dynamic programming so they are removed here</span>
    <span class="n">stall_int_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">stall_ints</span><span class="p">)</span>
    <span class="n">curr_stall_int</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">stall_int_iter</span><span class="p">)</span>
    <span class="n">non_stall_cpts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># loop over valid cpts</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_cpts</span><span class="p">):</span>
        <span class="c1"># iterate through stall intervals until the current interval end</span>
        <span class="c1"># is greater than the cpt to check against</span>
        <span class="k">while</span> <span class="n">cpt</span> <span class="o">&gt;</span> <span class="n">curr_stall_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curr_stall_int</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">stall_int_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">curr_stall_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cpt</span> <span class="o">&lt;</span> <span class="n">curr_stall_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">non_stall_cpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_cpts</span><span class="p">[</span><span class="n">non_stall_cpts</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">center_model_to_median_norm</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">init_ref</span><span class="p">,</span> <span class="n">max_reads</span><span class="o">=</span><span class="n">NUM_READS_TO_ADJUST_MODEL</span><span class="p">):</span>
    <span class="n">upstrm_bases</span> <span class="o">=</span> <span class="n">init_ref</span><span class="o">.</span><span class="n">central_pos</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">init_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">init_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">get_event_scale_values</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">r_len</span><span class="p">):</span>
        <span class="n">rsqgl_params</span> <span class="o">=</span> <span class="n">load_resquiggle_parameters</span><span class="p">(</span>
            <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="n">num_events</span> <span class="o">=</span> <span class="n">compute_num_events</span><span class="p">(</span>
            <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_len</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">mean_obs_per_event</span><span class="p">,</span> <span class="n">MIN_EVENT_TO_SEQ_RATIO</span><span class="p">)</span>
        <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">valid_cpts_w_cap_t_test</span><span class="p">(</span>
            <span class="n">all_raw_signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">min_obs_per_base</span><span class="p">,</span>
            <span class="n">rsqgl_params</span><span class="o">.</span><span class="n">running_stat_width</span><span class="p">,</span> <span class="n">num_events</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">COLLAPSE_RNA_STALLS</span><span class="p">:</span>
            <span class="n">valid_cpts</span> <span class="o">=</span> <span class="n">remove_stall_cpts</span><span class="p">(</span>
                <span class="n">identify_stalls</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">DEFAULT_STALL_PARAMS</span><span class="p">),</span>
                <span class="n">valid_cpts</span><span class="p">)</span>
        <span class="n">scale_values</span> <span class="o">=</span> <span class="n">get_scale_values_from_events</span><span class="p">(</span>
            <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">valid_cpts</span><span class="p">,</span> <span class="n">OUTLIER_THRESH</span><span class="p">,</span>
            <span class="n">num_events</span><span class="o">=</span><span class="n">RNA_SCALE_NUM_EVENTS</span><span class="p">,</span>
            <span class="n">max_frac_events</span><span class="o">=</span><span class="n">RNA_SCALE_MAX_FRAC_EVENTS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalize_raw_signal</span><span class="p">(</span>
            <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">scale_values</span><span class="o">=</span><span class="n">scale_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_read_corr_factors</span><span class="p">(</span><span class="n">r_data</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">all_raw_signal</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)[</span><span class="s1">&#39;Signal&#39;</span><span class="p">][:]</span>
            <span class="n">event_starts</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">),</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">rna</span><span class="p">:</span>
            <span class="n">all_raw_signal</span> <span class="o">=</span> <span class="n">all_raw_signal</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">USE_RNA_EVENT_SCALE</span><span class="p">:</span>
                <span class="n">norm_signal</span><span class="p">,</span> <span class="n">scale_values</span> <span class="o">=</span> <span class="n">get_event_scale_values</span><span class="p">(</span>
                    <span class="n">all_raw_signal</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use raw signal median normalization</span>
                <span class="n">norm_signal</span><span class="p">,</span> <span class="n">scale_values</span> <span class="o">=</span> <span class="n">normalize_raw_signal</span><span class="p">(</span>
                    <span class="n">all_raw_signal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm_signal</span><span class="p">,</span> <span class="n">scale_values</span> <span class="o">=</span> <span class="n">normalize_raw_signal</span><span class="p">(</span><span class="n">all_raw_signal</span><span class="p">)</span>

        <span class="n">event_starts</span> <span class="o">=</span> <span class="n">event_starts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">rsrtr</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">read_start_rel_to_raw</span> <span class="o">+</span> <span class="n">event_starts</span><span class="p">[</span><span class="n">upstrm_bases</span><span class="p">]</span>
        <span class="c1"># since the last segment end wasn&#39;t extracted the events are already</span>
        <span class="c1"># clipped by one, so deal with event boundary clipping here</span>
        <span class="k">if</span> <span class="n">dnstrm_bases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">event_starts</span> <span class="o">=</span> <span class="n">event_starts</span><span class="p">[</span><span class="n">upstrm_bases</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">dnstrm_bases</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">dnstrm_bases</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;Must have at least one upstream and downstream base for &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;a Tombo model.&#39;</span><span class="p">)</span>
            <span class="n">event_starts</span> <span class="o">=</span> <span class="n">event_starts</span><span class="p">[</span><span class="n">upstrm_bases</span><span class="p">:]</span>
        <span class="c1"># reset event starts to 0</span>
        <span class="n">event_starts</span> <span class="o">-=</span> <span class="n">event_starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">norm_signal</span> <span class="o">=</span> <span class="n">norm_signal</span><span class="p">[</span><span class="n">rsrtr</span><span class="p">:</span><span class="n">rsrtr</span> <span class="o">+</span> <span class="n">event_starts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">init_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span>

        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">shift_corr_factor</span><span class="p">,</span>
         <span class="n">scale_corr_factor</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_kmer_fitted_shift_scale</span><span class="p">(</span>
             <span class="n">scale_values</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">scale_values</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
             <span class="n">compute_base_means</span><span class="p">(</span><span class="n">norm_signal</span><span class="p">,</span> <span class="n">event_starts</span><span class="p">),</span> <span class="n">r_ref_means</span><span class="p">,</span>
             <span class="n">method</span><span class="o">=</span><span class="s1">&#39;theil_sen&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shift_corr_factor</span><span class="p">,</span> <span class="n">scale_corr_factor</span>


    <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Centering model to normalized signal&#39;</span><span class="p">)</span>
    <span class="n">all_shift_corr_factors</span><span class="p">,</span> <span class="n">all_scale_corr_factors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">all_reads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reads_index</span><span class="o">.</span><span class="n">iter_reads</span><span class="p">())</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">all_reads</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_shift_corr_factor</span><span class="p">,</span> <span class="n">r_scale_corr_factor</span> <span class="o">=</span> <span class="n">get_read_corr_factors</span><span class="p">(</span>
                <span class="n">r_data</span><span class="p">)</span>
            <span class="n">all_shift_corr_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_shift_corr_factor</span><span class="p">)</span>
            <span class="n">all_scale_corr_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_scale_corr_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_shift_corr_factors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_reads</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_shift_corr_factors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_reads</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_shift_corr_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;No reads succcessfully processed for sequence-based &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;normalization parameter re-fitting.&#39;</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Fewer reads succcessfully processed for sequence-based &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;normalization parameter re-fitting than requested.&#39;</span><span class="p">)</span>

    <span class="c1"># compute median shift and scale correction factors</span>
    <span class="c1"># scale parameter should be taken in log space, but median performs</span>
    <span class="c1"># the same computation</span>
    <span class="n">med_shift_corr_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_shift_corr_factors</span><span class="p">)</span>
    <span class="n">med_scale_corr_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_scale_corr_factors</span><span class="p">)</span>

    <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Shift and scale adjustments to match model to &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;median normalization: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">med_shift_corr_factor</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">med_scale_corr_factor</span><span class="p">))</span>
    <span class="n">init_ref</span><span class="o">.</span><span class="n">_center_model</span><span class="p">(</span><span class="n">med_shift_corr_factor</span><span class="p">,</span> <span class="n">med_scale_corr_factor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">init_ref</span>

<span class="k">if</span> <span class="n">_PROFILE_CENTER_REF</span><span class="p">:</span>
    <span class="n">center_model_to_median_norm_wrapper</span> <span class="o">=</span> <span class="n">center_model_to_median_norm</span>
    <span class="k">def</span> <span class="nf">center_model_to_median_norm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span>
            <span class="s1">&#39;center_model_to_median_norm_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;center_kmer_model.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">estimate_kmer_model</span><span class="p">(</span>
        <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
        <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">,</span>
        <span class="n">kmer_specific_sd</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate a standard tombo k-mer model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">)</span>
    <span class="n">all_reg_kmer_levels</span> <span class="o">=</span> <span class="n">extract_kmer_levels</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
        <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>

    <span class="n">all_kmer_mean_sds</span> <span class="o">=</span> <span class="n">tabulate_kmer_levels</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">)</span>

    <span class="c1"># adjust model to match median normalization best via Theil-Sen optimizer</span>
    <span class="c1"># fit this will increase the accuracy of median normalized re-squiggle</span>
    <span class="c1"># results and should reduce the need for (or number of) iterative</span>
    <span class="c1"># re-squiggle runs</span>
    <span class="n">init_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">kmer_ref</span><span class="o">=</span><span class="n">all_kmer_mean_sds</span><span class="p">,</span> <span class="n">central_pos</span><span class="o">=</span><span class="n">upstrm_bases</span><span class="p">)</span>

    <span class="n">centered_ref</span> <span class="o">=</span> <span class="n">center_model_to_median_norm</span><span class="p">(</span><span class="n">reads_index</span><span class="p">,</span> <span class="n">init_ref</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">kmer_specific_sd</span><span class="p">:</span>
        <span class="n">centered_ref</span><span class="o">.</span><span class="n">_make_constant_sd</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">centered_ref</span>


<span class="c1">########################################</span>
<span class="c1">##### Alternative Model Estimation #####</span>
<span class="c1">########################################</span>

<span class="k">def</span> <span class="nf">_parse_base_levels_worker</span><span class="p">(</span>
        <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">kmer_width</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">):</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r_fn</span><span class="p">,</span> <span class="n">corr_slot</span> <span class="o">=</span> <span class="n">reads_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># sometimes throws false empty exception with get(block=False)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reads_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="k">continue</span>
            <span class="k">break</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">corr_slot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">(</span><span class="n">r_seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">kmer_width</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">r_means</span><span class="p">[</span><span class="n">central_pos</span><span class="p">:</span><span class="o">-</span><span class="n">dnstrm_bases</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">completed_kmers</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">proc_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">get_batch_kmer_levels</span><span class="p">(</span>
        <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">all_reads</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">no_more_reads</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parse_levels_batch_size</span><span class="p">):</span>
            <span class="n">r_data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
            <span class="n">reads_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="n">no_more_reads</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">base_lev_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">,</span>
                     <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">)</span>
    <span class="n">base_lev_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_parse_base_levels_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">base_lev_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">base_lev_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">batch_kmer_levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">base_lev_ps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">batch_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">proc_kmer_levels</span> <span class="o">=</span> <span class="n">kmer_level_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">batch_kmer_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_kmer_levels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_kmer_levels</span><span class="p">,</span> <span class="n">no_more_reads</span>

<span class="k">def</span> <span class="nf">parse_base_levels</span><span class="p">(</span>
        <span class="n">all_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span>
        <span class="n">max_kmer_obs</span><span class="p">,</span> <span class="n">min_kmer_obs_to_est</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse base levels and store grouped by k-mer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reads_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">kmer_level_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="n">all_kmer_levels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">))</span>
    <span class="c1"># store set of k-mers with enough observations to save on memory footprint</span>
    <span class="c1"># while filling more rare k-mers</span>
    <span class="n">completed_kmers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">all_reads_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_reads</span><span class="p">),</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Number of total reads used&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">min_kmer_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;K-mer with fewest observations&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">curr_min_kmer_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_reads</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">batch_kmer_levels</span><span class="p">,</span> <span class="n">no_more_reads</span> <span class="o">=</span> <span class="n">get_batch_kmer_levels</span><span class="p">(</span>
            <span class="n">reads_q</span><span class="p">,</span> <span class="n">kmer_level_q</span><span class="p">,</span> <span class="n">all_reads</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span>
            <span class="n">std_ref</span><span class="p">,</span> <span class="n">completed_kmers</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>

        <span class="c1"># only add observations for k-mers that have not been seen enough times</span>
        <span class="c1"># save memory for abundent k-mers</span>
        <span class="n">batch_total_kmers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_kmer_levels</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">completed_kmers</span><span class="p">):</span>
            <span class="n">all_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span>
                <span class="n">kmer_level</span> <span class="k">for</span> <span class="n">proc_kmer_levels</span> <span class="ow">in</span> <span class="n">batch_kmer_levels</span>
                <span class="k">for</span> <span class="n">kmer_level</span> <span class="ow">in</span> <span class="n">proc_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
            <span class="n">batch_total_kmers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_kmer_levels</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">batch_total_kmers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_kmer_obs</span><span class="p">:</span>
                <span class="n">completed_kmers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no_more_reads</span><span class="p">:</span>
                <span class="n">all_reads_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">all_reads_bar</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">all_reads_bar</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_reads_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parse_levels_batch_size</span><span class="p">)</span>
            <span class="n">new_min_kmer_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_total_kmers</span><span class="p">)</span>
            <span class="n">min_kmer_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_min_kmer_count</span> <span class="o">-</span> <span class="n">curr_min_kmer_count</span><span class="p">)</span>
            <span class="n">curr_min_kmer_count</span> <span class="o">=</span> <span class="n">new_min_kmer_count</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_min_kmer_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_total_kmers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curr_min_kmer_count</span> <span class="o">&gt;</span> <span class="n">kmer_obs_thresh</span> <span class="ow">or</span> <span class="n">no_more_reads</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">n_batches</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">all_reads_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">min_kmer_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">fewest_kmer_obs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">)</span> <span class="k">for</span> <span class="n">kmer_levels</span> <span class="ow">in</span>
                          <span class="n">all_kmer_levels</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">fewest_kmer_obs</span> <span class="o">&lt;</span> <span class="n">kmer_obs_thresh</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fewest_kmer_obs</span> <span class="o">&lt;</span> <span class="n">min_kmer_obs_to_est</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Too few minimal k-mer observations to continue to &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;alternative estimation. Minimal k-mer has &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">fewest_kmer_obs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; total observations and &#39;</span> <span class="o">+</span>
                <span class="n">unicode</span><span class="p">(</span><span class="n">min_kmer_obs_to_est</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; observations per k-mer are required.&#39;</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Requested minimal k-mer observations not found in all reads. &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;Continuing to estimation using a k-mer with &#39;</span> <span class="o">+</span>
            <span class="n">unicode</span><span class="p">(</span><span class="n">fewest_kmer_obs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; total observations&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_kmer_levels</span>

<span class="k">def</span> <span class="nf">write_kmer_densities_file</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">,</span> <span class="n">kmer_dens</span><span class="p">,</span> <span class="n">save_x</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Kmer</span><span class="se">\t</span><span class="s1">Signal</span><span class="se">\t</span><span class="s1">Density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                           <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">dens_i</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">parse_kmer_densities_file</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">):</span>
    <span class="n">kmer_dens_raw</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dens_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">dens_fp</span><span class="p">:</span>
        <span class="c1"># read in header</span>
        <span class="n">dens_fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dens_fp</span><span class="p">:</span>
            <span class="n">kmer</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dens_i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">kmer_dens_raw</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dens_i</span><span class="p">))</span>

    <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">first_len</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens_raw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">first_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">first_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">first_len</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Density file is valid.&#39;</span><span class="p">)</span>
        <span class="n">kmer_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens_i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kmer_dens</span>

<span class="k">def</span> <span class="nf">est_kernel_density</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span>
        <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">alt_or_stnd_name</span><span class="o">=</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span>
        <span class="n">parse_levels_batch_size</span><span class="o">=</span><span class="n">ALT_EST_BATCH</span><span class="p">,</span> <span class="n">max_kmer_obs</span><span class="o">=</span><span class="n">MAX_KMER_OBS</span><span class="p">,</span>
        <span class="n">min_kmer_obs_to_est</span><span class="o">=</span><span class="n">MIN_KMER_OBS_TO_EST</span><span class="p">):</span>
    <span class="n">all_reads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reads_index</span><span class="o">.</span><span class="n">iter_reads</span><span class="p">())</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">all_reads</span><span class="p">)</span>
    <span class="n">base_levels</span> <span class="o">=</span> <span class="n">parse_base_levels</span><span class="p">(</span>
        <span class="n">all_reads</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">parse_levels_batch_size</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span>
        <span class="n">max_kmer_obs</span><span class="p">,</span> <span class="n">min_kmer_obs_to_est</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Fitting kernel densities for k-mer levels.&#39;</span><span class="p">)</span>
    <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">norm_levels</span> <span class="ow">in</span> <span class="n">base_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">norm_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">norm_levels</span><span class="p">)</span>
        <span class="n">kmer_kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span>
            <span class="n">norm_levels</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">kernel_dens_bw</span> <span class="o">/</span> <span class="n">norm_levels</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">kmer_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmer_kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">save_x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">density_basename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">write_kmer_densities_file</span><span class="p">(</span>
            <span class="n">density_basename</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_or_stnd_name</span> <span class="o">+</span> <span class="s1">&#39;_density.txt&#39;</span><span class="p">,</span>
            <span class="n">kmer_dens</span><span class="p">,</span> <span class="n">save_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kmer_dens</span>

<span class="k">def</span> <span class="nf">estimate_kmer_densities</span><span class="p">(</span>
        <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">ctrl_fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
        <span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">)</span>
    <span class="n">ctrl_reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="n">ctrl_fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Parsing standard model file.&#39;</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">ref_fn</span><span class="o">=</span><span class="n">standard_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
                         <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Parsing base levels from alternative reads.&#39;</span><span class="p">)</span>
    <span class="n">alt_dens</span> <span class="o">=</span> <span class="n">est_kernel_density</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">save_x</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="s1">&#39;alternate&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Parsing base levels from standard reads.&#39;</span><span class="p">)</span>
    <span class="n">std_dens</span> <span class="o">=</span> <span class="n">est_kernel_density</span><span class="p">(</span>
        <span class="n">ctrl_reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
        <span class="n">save_x</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span>

<span class="k">def</span> <span class="nf">load_kmer_densities</span><span class="p">(</span>
        <span class="n">alt_dens_fn</span><span class="p">,</span> <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
        <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Parsing standard model file.&#39;</span><span class="p">)</span>
    <span class="n">reads_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">std_ref_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fast5s_dirs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Must provide a FAST5s directory, a canonical model &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;file or spcify the biological sample type.&#39;</span><span class="p">)</span>
        <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span><span class="n">ref_fn</span><span class="o">=</span><span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
                         <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Parsing density files.&#39;</span><span class="p">)</span>
    <span class="n">alt_dens</span> <span class="o">=</span> <span class="n">parse_kmer_densities_file</span><span class="p">(</span><span class="n">alt_dens_fn</span><span class="p">)</span>
    <span class="n">std_dens</span> <span class="o">=</span> <span class="n">parse_kmer_densities_file</span><span class="p">(</span><span class="n">std_dens_fn</span><span class="p">)</span>
    <span class="n">num_dens_points</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">alt_dens</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_dens_points</span> <span class="o">!=</span> <span class="nb">next</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">std_dens</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Alternative and standard density &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;estimates do not correspond.&#39;</span><span class="p">)</span>

    <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">num_dens_points</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span>

<span class="k">def</span> <span class="nf">isolate_alt_density</span><span class="p">(</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">calc_mean</span><span class="p">(</span><span class="n">dens</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">save_x</span><span class="p">[</span><span class="n">dens</span><span class="o">&gt;</span><span class="mf">1e-10</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">dens</span><span class="p">[</span><span class="n">dens</span><span class="o">&gt;</span><span class="mf">1e-10</span><span class="p">])</span>


    <span class="c1"># estimate density shift from k-mers without the alternate base</span>
    <span class="n">no_alt_std_means</span><span class="p">,</span> <span class="n">no_alt_mean_diffs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">std_dens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alt_base</span> <span class="ow">in</span> <span class="n">kmer</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">no_alt_std_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span>
        <span class="n">kmer_alt_mean</span> <span class="o">=</span> <span class="n">calc_mean</span><span class="p">(</span><span class="n">alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
        <span class="n">no_alt_mean_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmer_alt_mean</span> <span class="o">-</span> <span class="n">no_alt_std_means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">calc_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">no_alt_std_means</span><span class="p">,</span> <span class="n">no_alt_mean_diffs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">save_x_unit</span> <span class="o">=</span> <span class="n">save_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">save_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">shifted_alt_dens</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">kmer_alt_dens</span> <span class="ow">in</span> <span class="n">alt_dens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">est_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">calc_offset</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]))</span> <span class="o">/</span> <span class="n">save_x_unit</span><span class="p">)</span>
        <span class="c1"># if std density mean is estimated to be greater</span>
        <span class="k">if</span> <span class="n">est_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># shift alt dens to the right</span>
            <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,]</span> <span class="o">*</span> <span class="o">-</span><span class="n">est_offset</span><span class="p">,</span> <span class="n">kmer_alt_dens</span><span class="p">[:</span><span class="n">est_offset</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># else shift alt dens to the left</span>
            <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="n">est_offset</span><span class="p">:],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,]</span> <span class="o">*</span> <span class="n">est_offset</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_peak_frac</span><span class="p">(</span><span class="n">kmer_std_dens</span><span class="p">,</span> <span class="n">kmer_alt_dens</span><span class="p">):</span>
        <span class="c1"># find highest peak in standard density</span>
        <span class="n">std_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kmer_std_dens</span><span class="p">)</span>

        <span class="c1"># find closest peak in alternative density</span>
        <span class="n">alt_local_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="p">[</span><span class="kc">False</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kmer_alt_dens</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">,]]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">matched_alt_peak</span> <span class="o">=</span> <span class="n">alt_local_peaks</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alt_local_peaks</span> <span class="o">-</span> <span class="n">std_peak</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">kmer_alt_dens</span><span class="p">[</span><span class="n">matched_alt_peak</span><span class="p">]</span> <span class="o">/</span> <span class="n">kmer_std_dens</span><span class="p">[</span><span class="n">std_peak</span><span class="p">]</span>


    <span class="c1"># estimate the alternative base incorporation rate</span>
    <span class="n">std_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span>
        <span class="n">get_peak_frac</span><span class="p">(</span><span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">],</span> <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">std_dens</span> <span class="k">if</span> <span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="n">alt_frac_pctl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Alternative base incorporation rate estimate: &#39;</span> <span class="o">+</span>
            <span class="n">unicode</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">std_frac</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">std_frac</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
            <span class="s1">&#39;Alternative base incorporation rate &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;estimate is approximately 0. Consider lowering &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;--alt-fraction-percentile.&#39;</span><span class="p">)</span>

    <span class="c1"># get mean model SD. most models will be constant, but use mean in case</span>
    <span class="n">model_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">sds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="c1"># subtract off fraction of standard density from alt density</span>
    <span class="c1"># to estimate mean of isolated alternative distribution</span>
    <span class="n">alt_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">std_level</span> <span class="ow">in</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">means</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># assuming random incorporation the prortion of standard base</span>
        <span class="c1"># observations at this k-mer is the standard fraction raised</span>
        <span class="c1"># to the number of alt_base occurences in the k-mer</span>
        <span class="n">kmer_std_frac</span> <span class="o">=</span> <span class="n">std_frac</span><span class="o">**</span><span class="n">kmer</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alt_base</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">diff_dens</span> <span class="o">=</span> <span class="n">shifted_alt_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">std_dens</span><span class="p">[</span><span class="n">kmer</span><span class="p">]</span> <span class="o">*</span> <span class="n">kmer_std_frac</span><span class="p">)</span>
            <span class="n">diff_dens</span><span class="p">[</span><span class="n">diff_dens</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">alt_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">diff_dens</span><span class="p">)</span>
        <span class="c1"># add alt mean for each alt base position within the kmer</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">alt_base</span><span class="p">,</span> <span class="n">kmer</span><span class="p">):</span>
            <span class="n">alt_ref</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">alt_level</span><span class="p">,</span> <span class="n">model_sd</span><span class="p">))</span>

    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">AltModel</span><span class="p">(</span>
        <span class="n">kmer_ref</span><span class="o">=</span><span class="n">alt_ref</span><span class="p">,</span> <span class="n">central_pos</span><span class="o">=</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="n">alt_base</span><span class="o">=</span><span class="n">alt_base</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_ref</span>

<span class="k">def</span> <span class="nf">estimate_alt_model</span><span class="p">(</span>
        <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">ctrl_fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
        <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span>
        <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span> <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">alt_dens_fn</span><span class="p">,</span>
        <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">num_dens_points</span><span class="o">=</span><span class="n">NUM_DENS_POINTS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate an alternative model from a sample with a single,</span>
<span class="sd">    known, randomly-incorporated alternative base</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alt_dens_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">std_dens_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">num_dens_points</span><span class="p">)</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span> <span class="o">=</span> <span class="n">estimate_kmer_densities</span><span class="p">(</span>
            <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">ctrl_fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
            <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">kmer_obs_thresh</span><span class="p">,</span> <span class="n">density_basename</span><span class="p">,</span>
            <span class="n">kernel_dens_bw</span><span class="p">,</span> <span class="n">save_x</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span> <span class="o">=</span> <span class="n">load_kmer_densities</span><span class="p">(</span>
            <span class="n">alt_dens_fn</span><span class="p">,</span> <span class="n">std_dens_fn</span><span class="p">,</span> <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span>
            <span class="n">std_ref_fn</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Isolating alternative base distribtuions.&#39;</span><span class="p">)</span>
    <span class="c1"># perform alternative density isolation algorithm</span>
    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">isolate_alt_density</span><span class="p">(</span>
        <span class="n">alt_dens</span><span class="p">,</span> <span class="n">std_dens</span><span class="p">,</span> <span class="n">alt_base</span><span class="p">,</span> <span class="n">alt_frac_pctl</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">save_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alt_ref</span>

<span class="k">if</span> <span class="n">_PROFILE_ALT_EST</span><span class="p">:</span>
    <span class="n">_est_alt_wrapper</span> <span class="o">=</span> <span class="n">estimate_alt_model</span>
    <span class="k">def</span> <span class="nf">estimate_alt_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_est_alt_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;est_alt_model.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">tabulate_mod_kmer_levels</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">,</span> <span class="n">motif</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Tabulating k-mer model statistics.&#39;</span><span class="p">)</span>
    <span class="n">all_kmer_mean_sds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="n">kmer_dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">KERNEL_DENSITY_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">_DEBUG_EST_NUM_KMER_SAVE</span><span class="p">)</span>
    <span class="n">kmer_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">all_reg_kmer_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">find_mod_poss</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">))]:</span>
        <span class="n">kmer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kmer_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">reg_kmer_levels</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">reg_kmer_levels</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_kmer_levels</span><span class="p">[(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;At least one modified k-mer is not covered at any poitions &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;by --minimum-test-reads.</span><span class="se">\n\t\t</span><span class="s1">Consider fitting to a smaller &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;k-mer via the --upstream-bases and --downstream-bases, &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;or lowering --minimum-test-reads.</span><span class="se">\n\t\t</span><span class="s1">Note that this may &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;result in a lower quality model.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kmer_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_kmer_obs</span><span class="p">:</span>
            <span class="n">min_obs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reg_levs</span><span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">),</span> <span class="n">i_offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
                    <span class="k">for</span> <span class="n">reg_levs</span> <span class="ow">in</span> <span class="n">all_reg_kmer_levels</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kmer</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">DNA_BASES</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">kmer_width</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i_offset</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">find_mod_poss</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kmer</span><span class="p">)))</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;K-mers represeneted in fewer observations than &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;requested in the provided reads. Consider a shorter &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;k-mer or providing more reads.</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="n">min_obs</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; observations found in least common kmer.&#39;</span><span class="p">)</span>
        <span class="n">all_kmer_mean_sds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
            <span class="n">kmer_kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span>
                <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">bw_method</span><span class="o">=</span><span class="n">_DEBUG_EST_BW</span> <span class="o">/</span> <span class="n">kmer_levels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">kmer_dens</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">kmer_kde</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">save_x</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">_DEBUG_EST_STD</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;debug_est_motif_alt_ref.density.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Kmer</span><span class="se">\t</span><span class="s1">Offset</span><span class="se">\t</span><span class="s1">Signal</span><span class="se">\t</span><span class="s1">Density</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span>
                               <span class="k">for</span> <span class="n">kmer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dens_i</span> <span class="ow">in</span> <span class="n">kmer_dens</span>
                               <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">save_x</span><span class="p">,</span> <span class="n">dens_i</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_kmer_mean_sds</span>

<span class="k">def</span> <span class="nf">estimate_motif_alt_model</span><span class="p">(</span>
        <span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">,</span> <span class="n">motif_desc</span><span class="p">,</span>
        <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span> <span class="n">valid_locs_fn</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">,</span>
        <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate a motif-centered alternate-base tombo k-mer model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span><span class="n">fast5s_dirs</span><span class="p">,</span> <span class="n">corr_grp</span><span class="p">,</span> <span class="n">bc_subgrps</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">raw_motif</span><span class="p">,</span> <span class="n">mod_pos</span> <span class="o">=</span> <span class="n">motif_desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Invalid motif decription format.&#39;</span><span class="p">)</span>
    <span class="n">motif</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboMotif</span><span class="p">(</span><span class="n">raw_motif</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mod_pos</span><span class="p">))</span>
    <span class="n">valid_poss</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">valid_locs_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">th</span><span class="o">.</span><span class="n">parse_locs_file</span><span class="p">(</span>
        <span class="n">valid_locs_fn</span><span class="p">)</span>

    <span class="n">all_reg_kmer_levels</span> <span class="o">=</span> <span class="n">extract_kmer_levels</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">upstrm_bases</span><span class="p">,</span> <span class="n">dnstrm_bases</span><span class="p">,</span>
        <span class="n">cs_cov_thresh</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">motif</span><span class="p">,</span> <span class="n">valid_poss</span><span class="p">)</span>

    <span class="c1"># process motif kmers with relative position stored</span>
    <span class="n">all_mod_kmer_mean_sds</span> <span class="o">=</span> <span class="n">tabulate_mod_kmer_levels</span><span class="p">(</span>
        <span class="n">all_reg_kmer_levels</span><span class="p">,</span> <span class="n">min_kmer_obs</span><span class="p">,</span> <span class="n">motif</span><span class="p">)</span>

    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">AltModel</span><span class="p">(</span>
        <span class="n">kmer_ref</span><span class="o">=</span><span class="n">all_mod_kmer_mean_sds</span><span class="p">,</span> <span class="n">central_pos</span><span class="o">=</span><span class="n">upstrm_bases</span><span class="p">,</span>
        <span class="n">alt_base</span><span class="o">=</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_base</span><span class="p">,</span> <span class="n">motif</span><span class="o">=</span><span class="n">motif</span><span class="p">)</span>

    <span class="n">alt_ref</span><span class="o">.</span><span class="n">_make_constant_sd</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">alt_ref</span>

<span class="k">if</span> <span class="n">_PROFILE_MOTIF_ALT_EST</span><span class="p">:</span>
    <span class="n">_est_motif_alt_wrapper</span> <span class="o">=</span> <span class="n">estimate_motif_alt_model</span>
    <span class="k">def</span> <span class="nf">estimate_motif_alt_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_est_motif_alt_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;est_motif_alt_model.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="c1">####################################</span>
<span class="c1">##### Core Statistical Testing #####</span>
<span class="c1">####################################</span>

<span class="k">def</span> <span class="nf">p_value_to_z_score</span><span class="p">(</span><span class="n">pvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to convert p-value to z-score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">z_score_to_p_value</span><span class="p">(</span><span class="n">zscore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to convert z-score to p-value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">correct_multiple_testing</span><span class="p">(</span><span class="n">pvals</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use FDR Benjamini-Hochberg multiple testing correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>

    <span class="n">pvals_sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">pvals_sorted</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">pvals_sortind</span><span class="p">]</span>
    <span class="n">sortrevind</span> <span class="o">=</span> <span class="n">pvals_sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

    <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">ecdffcator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nobs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nobs</span>
    <span class="c1"># ignore underflow values</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">pvals_corrected_raw</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">ecdffcator</span>
    <span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span>
        <span class="n">pvals_corrected_raw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">pvals_corrected_raw</span>
    <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">pvals_corrected</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">pvals_corrected</span><span class="p">[</span><span class="n">sortrevind</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">calc_vectorized_fm_pvals</span><span class="p">(</span><span class="n">split_pvals</span><span class="p">,</span> <span class="n">filter_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Fisher&#39;s Method p-values in a vectorized fashion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_nan</span><span class="p">:</span>
        <span class="n">chi_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">)]))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
        <span class="n">chi_shapes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chi_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_pvals</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>
        <span class="n">chi_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                     <span class="k">for</span> <span class="n">base_pvals</span> <span class="ow">in</span> <span class="n">split_pvals</span><span class="p">]</span>

    <span class="n">f_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">chi_stats</span><span class="p">,</span> <span class="n">chi_shapes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_pvals</span>

<span class="k">def</span> <span class="nf">calc_window_fishers_method</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Fisher&#39;s Method over a moving window across a set of p-values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Invalid p-value window provided.&#39;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s2">&quot;P-values vector too short for Fisher&#39;s Method &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;window compuation.&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">SMALLEST_PVAL</span><span class="p">)</span>
    <span class="n">log_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pvals</span><span class="p">),</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">pvals</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span> <span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pvals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">f_pvals</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">f_pvals</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">lag</span><span class="p">:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">log_sums</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f_pvals</span>

<span class="k">def</span> <span class="nf">calc_window_means</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute mean over a moving window across a set of statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Invalid window provided.&#39;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
            <span class="s2">&quot;Statistics vector too short for window mean compuation.&quot;</span><span class="p">)</span>
    <span class="n">m_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">m_stats</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">m_stats</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">lag</span><span class="p">:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m_stats</span>

<span class="k">def</span> <span class="nf">calc_window_z_transform</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">ref_means</span><span class="p">,</span> <span class="n">ref_sds</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Stouffer&#39;s Z-transformation across a read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_means</span> <span class="o">-</span> <span class="n">ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">ref_sds</span>
    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">window_z_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">z_scores</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">z_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="p">),</span>
        <span class="n">strides</span><span class="o">=</span><span class="n">z_scores</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">z_scores</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="n">window_z_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">]</span> <span class="o">*</span> <span class="n">lag</span><span class="p">),</span>
                                     <span class="n">window_z_trans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">]</span> <span class="o">*</span> <span class="n">lag</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">window_z_trans</span>

<span class="k">def</span> <span class="nf">calc_mann_whitney_z_score</span><span class="p">(</span><span class="n">samp1</span><span class="p">,</span> <span class="n">samp2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute Mann-Whitney z-scores comparing two samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1_len</span> <span class="o">=</span> <span class="n">samp1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2_len</span> <span class="o">=</span> <span class="n">samp2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tot_len</span> <span class="o">=</span> <span class="n">s1_len</span> <span class="o">+</span> <span class="n">s2_len</span>

    <span class="n">all_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">samp1</span><span class="p">,</span> <span class="n">samp2</span><span class="p">])</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">tot_len</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">ranks</span><span class="p">[</span><span class="n">all_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tot_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">s1_ranks_sum</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[:</span><span class="n">s1_len</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1">#s2_ranks_sum = ranks[s1_len:].sum()</span>

    <span class="n">u1</span> <span class="o">=</span> <span class="n">s1_ranks_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1">#u2 = s2_ranks_sum - (s2_len * (s2_len + 1)) / 2</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">s1_len</span> <span class="o">*</span> <span class="n">s2_len</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">rhou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1_len</span> <span class="o">*</span> <span class="n">s2_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1_len</span> <span class="o">+</span> <span class="n">s2_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">rhou</span>

    <span class="k">return</span> <span class="n">z</span>

<div class="viewcode-block" id="get_read_seg_score"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.get_read_seg_score">[docs]</a><span class="k">def</span> <span class="nf">get_read_seg_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute expected to observed signal matching score</span>

<span class="sd">    Args:</span>
<span class="sd">        r_means (`np.array::np.float64`): observed base signal levels</span>
<span class="sd">        r_ref_means (`np.array::np.float64`): expected base signal levels</span>
<span class="sd">        r_ref_sds (`np.array::np.float64`): expected base signal level sds</span>

<span class="sd">    Returns:</span>
<span class="sd">        Mean half z-score for observed versus expected signal levels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">r_means</span> <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_ref_sds</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">score_valid_bases</span><span class="p">(</span><span class="n">read_tb</span><span class="p">,</span> <span class="n">event_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute expected to observed signal matching score for bases not deleted</span>
<span class="sd">    in dynamic programming</span>

<span class="sd">    Args:</span>
<span class="sd">        read_tb (`np.array::np.int32`): event changepoints</span>
<span class="sd">        r_means (`np.array::np.float64`): observed base signal levels</span>
<span class="sd">        r_ref_means (`np.array::np.float64`): expected base signal levels</span>
<span class="sd">        r_ref_sds (`np.array::np.float64`): expected base signal level sds</span>

<span class="sd">    Returns:</span>
<span class="sd">        Mean half z-score for observed versus expected signal levels (for valid</span>
<span class="sd">            bases)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_bases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">read_tb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_bases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Invalid path through read start&#39;</span><span class="p">)</span>
    <span class="n">valid_ref_means</span><span class="p">,</span> <span class="n">valid_ref_sds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">r_ref_means</span><span class="p">[</span><span class="n">valid_bases</span><span class="p">],</span> <span class="n">r_ref_sds</span><span class="p">[</span><span class="n">valid_bases</span><span class="p">])</span>
    <span class="n">base_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">event_means</span><span class="p">[</span><span class="n">b_start</span><span class="p">:</span><span class="n">b_end</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">read_tb</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">read_tb</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                           <span class="k">if</span> <span class="n">b_start</span> <span class="o">!=</span> <span class="n">b_end</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">get_read_seg_score</span><span class="p">(</span><span class="n">base_means</span><span class="p">,</span> <span class="n">valid_ref_means</span><span class="p">,</span> <span class="n">valid_ref_sds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_dynamic_prog_params</span><span class="p">(</span><span class="n">match_evalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute dynamic programming shift parameters from an expected match</span>
<span class="sd">    expected value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_shift</span> <span class="o">=</span> <span class="n">HALF_NORM_EXPECTED_VAL</span> <span class="o">+</span> <span class="n">match_evalue</span>
    <span class="n">stay_pen</span> <span class="o">=</span> <span class="n">match_evalue</span>
    <span class="k">return</span> <span class="n">z_shift</span><span class="p">,</span> <span class="n">stay_pen</span>


<span class="c1">##########################</span>
<span class="c1">##### Statistics I/O #####</span>
<span class="c1">##########################</span>

<span class="k">def</span> <span class="nf">compute_auc</span><span class="p">(</span><span class="n">tp_rate</span><span class="p">,</span> <span class="n">fp_rate</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tp_rate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">fp_rate</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">fp_rate</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">compute_mean_avg_precison</span><span class="p">(</span><span class="n">tp_rate</span><span class="p">,</span> <span class="n">precision</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">tp_rate</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,]]),)</span> <span class="o">*</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">precision</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,]])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">compute_accuracy_rates</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">,</span> <span class="n">num_plot_points</span><span class="o">=</span><span class="n">ROC_PLOT_POINTS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list or numpy array of true/false values, function returns</span>
<span class="sd">    num_plot_point evenly spaced values along the true positive, false positive</span>
<span class="sd">    and precision arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tp_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">)</span>
    <span class="n">tp_rate</span> <span class="o">=</span> <span class="n">tp_cumsum</span> <span class="o">/</span> <span class="n">tp_cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fp_cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">))</span>
    <span class="n">fp_rate</span> <span class="o">=</span> <span class="n">fp_cumsum</span> <span class="o">/</span> <span class="n">fp_cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">tp_cumsum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat_has_mod</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># trim to number of requested points</span>
    <span class="n">tp_rate</span> <span class="o">=</span> <span class="n">tp_rate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tp_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">num_plot_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>
    <span class="n">fp_rate</span> <span class="o">=</span> <span class="n">fp_rate</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fp_rate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">num_plot_points</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">precision</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">num_plot_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">tp_rate</span><span class="p">,</span> <span class="n">fp_rate</span><span class="p">,</span> <span class="n">precision</span>

<span class="k">def</span> <span class="nf">_compute_motif_stats</span><span class="p">(</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
        <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">all_motif_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">before_bases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span>
        <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="k">for</span> <span class="n">motif</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">after_bases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span>
                       <span class="k">for</span> <span class="n">motif</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">total_num_stats</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">block_stats</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">seq_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">before_bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">seq_end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">after_bases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">after_bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">seq_end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">before_bases</span>

        <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="n">seq_end</span><span class="p">,</span> <span class="n">error_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># TODO potentially keep all mod sites when they are extremely rare</span>
        <span class="c1"># randomly sub-sample per-read stats here</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stats_per_block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">block_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stats_per_block</span><span class="p">):</span>
            <span class="n">block_stats</span> <span class="o">=</span> <span class="n">block_stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="n">block_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stats_per_block</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">total_num_stats</span> <span class="o">+=</span> <span class="n">block_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r_pos_stat</span> <span class="ow">in</span> <span class="n">block_stats</span><span class="p">:</span>
            <span class="c1"># extract position sequence</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_pos_seq</span> <span class="o">=</span> <span class="n">reg_seq</span><span class="p">[</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">-</span> <span class="n">before_bases</span><span class="p">:</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">+</span> <span class="n">after_bases</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_pos_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">[</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">-</span> <span class="n">after_bases</span><span class="p">:</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">seq_start</span> <span class="o">+</span> <span class="n">before_bases</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># add statistic and whether the sequence matches each motif</span>
            <span class="k">for</span> <span class="n">motif</span><span class="p">,</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">motif_descs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r_pos_seq</span><span class="p">[</span><span class="n">before_bases</span><span class="p">]</span> <span class="o">!=</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_base</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">all_motif_stats</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">],</span>
                    <span class="nb">bool</span><span class="p">(</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                        <span class="n">r_pos_seq</span><span class="p">[</span><span class="n">before_bases</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]))))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">total_stats_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">total_num_stats</span> <span class="o">&gt;=</span> <span class="n">total_stats_limit</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">all_motif_stats</span>

<span class="k">def</span> <span class="nf">_compute_ground_truth_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">ground_truth_locs</span><span class="p">):</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mod_locs</span><span class="p">,</span> <span class="n">unmod_locs</span><span class="p">,</span> <span class="n">mod_name</span> <span class="o">=</span> <span class="n">ground_truth_locs</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">block_stats</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_mod_locs</span> <span class="o">=</span> <span class="n">mod_locs</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cs_mod_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_unmod_locs</span> <span class="o">=</span> <span class="n">unmod_locs</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cs_unmod_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">block_mod_locs</span> <span class="o">=</span> <span class="n">cs_mod_locs</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">cs_mod_locs</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">cs_mod_locs</span><span class="p">,</span> <span class="n">end</span><span class="p">))]</span>
        <span class="n">block_unmod_locs</span> <span class="o">=</span> <span class="n">cs_unmod_locs</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">cs_unmod_locs</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">cs_unmod_locs</span><span class="p">,</span> <span class="n">end</span><span class="p">))]</span>
        <span class="n">block_valid_locs</span> <span class="o">=</span> <span class="n">block_stats</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="n">block_mod_locs</span><span class="p">,</span> <span class="n">block_unmod_locs</span><span class="p">]))]</span>
        <span class="n">all_stats</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">block_valid_locs</span><span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">block_valid_locs</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">block_mod_locs</span><span class="p">)))</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">mod_name</span><span class="p">:</span><span class="n">all_stats</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">_compute_ctrl_motif_stats</span><span class="p">(</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">ctrl_stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
        <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">all_motif_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">before_bases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span>
        <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="k">for</span> <span class="n">motif</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">after_bases</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span>
                       <span class="k">for</span> <span class="n">motif</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">motif_descs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">total_num_stats</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">block_stats</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">seq_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">before_bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">seq_end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">after_bases</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">after_bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">seq_end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">before_bases</span>

        <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">seq_start</span><span class="p">,</span> <span class="n">seq_end</span><span class="p">,</span> <span class="n">error_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ctrl_block_stats</span> <span class="o">=</span> <span class="n">ctrl_stats</span><span class="o">.</span><span class="n">get_reg_stats</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">motif</span><span class="p">,</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="n">motif_descs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">mod_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)])</span> <span class="o">+</span> <span class="n">seq_start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">motif</span><span class="o">.</span><span class="n">rev_comp_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)])</span> <span class="o">+</span> <span class="n">seq_start</span>

            <span class="c1"># TODO possibly use stats_per_block here, but motif stats are</span>
            <span class="c1"># less common, so probably not as useful here</span>
            <span class="k">for</span> <span class="n">r_pos_stat</span> <span class="ow">in</span> <span class="n">block_stats</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">mod_poss</span><span class="p">)]:</span>
                <span class="n">all_motif_stats</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">r_pos_stat</span><span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
                <span class="n">total_num_stats</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ctrl_block_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r_pos_stat</span> <span class="ow">in</span> <span class="n">ctrl_block_stats</span><span class="p">[</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ctrl_block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">mod_poss</span><span class="p">)]:</span>
                    <span class="n">all_motif_stats</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">r_pos_stat</span><span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
                    <span class="n">total_num_stats</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">total_stats_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">total_num_stats</span> <span class="o">&gt;=</span> <span class="n">total_stats_limit</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">all_motif_stats</span>

<span class="k">def</span> <span class="nf">calc_damp_fraction</span><span class="p">(</span><span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">fracs</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute dampened fraction of un-modified reads using provided modified</span>
<span class="sd">    and un-modified pseudo-counts from cov_damp_counts</span>

<span class="sd">    See https://nanoporetech.github.io/tombo/text_output.html?highlight=dampened#text-output-browser-files for more details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">damp_fracs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">fracs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">damp_fracs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">non_mod_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fracs</span> <span class="o">*</span> <span class="n">valid_cov</span><span class="p">)</span>
    <span class="c1"># compute dampened fraction of modified reads by adding psuedo-counts</span>
    <span class="c1"># to the modified and un-modified counts (equivalent to a beta prior</span>
    <span class="c1"># on the fraction estimation as a binomial variable)</span>
    <span class="n">damp_fracs</span> <span class="o">=</span> <span class="p">(</span><span class="n">non_mod_counts</span> <span class="o">+</span> <span class="n">cov_damp_counts</span><span class="p">[</span><span class="s1">&#39;unmod&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">valid_cov</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cov_damp_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="k">return</span> <span class="n">damp_fracs</span>

<div class="viewcode-block" id="ModelStats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats">[docs]</a><span class="k">class</span> <span class="nc">ModelStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse and retrieve relevant information from a standard (per-genomic</span>
<span class="sd">    base) Tombo statistics file.</span>

<span class="sd">    .. automethod:: __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO add attributes</span>
    <span class="k">def</span> <span class="nf">_parse_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Statistics file not provided or provided file does not exist.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stat_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_size&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">[</span><span class="n">STAT_BLOCKS_H5_NAME</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blocks_index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">block_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">blocks_index</span><span class="p">[</span>
                <span class="p">(</span><span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">))][</span>
                    <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">block_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">blocks_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">COV_THRESH_H5_NAME</span><span class="p">)</span>
        <span class="n">most_signif_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">[</span><span class="n">MOST_SIGNIF_H5_NAME</span><span class="p">]</span>
        <span class="c1"># read full most significant array into memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_stats</span> <span class="o">=</span> <span class="n">most_signif_grp</span><span class="p">[</span><span class="n">MOST_SIGNIF_H5_NAME</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_chrm_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">most_signif_grp</span><span class="p">[</span><span class="s1">&#39;chrm_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="c1"># LevelStats doesn&#39;t have damp counts</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">[</span>
                <span class="n">COV_DAMP_COUNTS_H5_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_create_new_stats_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># try to remove file for overwriting old results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># open file for writing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># save attributes to file and open stats blocks group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">STAT_BLOCKS_H5_NAME</span><span class="p">)</span>

        <span class="c1"># save coverage damp counts and threshold attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">COV_THRESH_H5_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
            <span class="n">COV_DAMP_COUNTS_H5_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span>
            <span class="s1">&#39;unmod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span><span class="p">[</span><span class="s1">&#39;unmod&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span>
            <span class="s1">&#39;mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span>

        <span class="c1"># storage for most significant stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">MOST_SIGNIF_H5_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_most_signif</span><span class="p">,),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;damp_frac&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;control_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;valid_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">),</span> <span class="s1">&#39;S1&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="c1"># store a queue of completed stat batches to be concatenated and stored</span>
        <span class="c1"># as a group to avoid too many array copy and sorting ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># store chromosomes names in dict for storing most signif array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_chrm_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrm_id_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_sites</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;chrm_ids&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span>

<div class="viewcode-block" id="ModelStats.__init__"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cov_damp_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">most_signif_num_batches</span><span class="o">=</span><span class="n">MOST_SIGNIF_NUM_BATCHES_DEFAULT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse or open for writing a standard (per-genomic base) Tombo</span>
<span class="sd">        statistics file.</span>

<span class="sd">        Example::</span>

<span class="sd">            stats = tombo_stats.TomboStats(&#39;path/to/stats.file&#39;)</span>
<span class="sd">            for chrm, strand, pos, frac, damp_frac, valid_cov in \</span>
<span class="sd">                    stats.iter_most_signif_sites():</span>
<span class="sd">                # do stuff</span>

<span class="sd">        Args:</span>
<span class="sd">            stats_fn (str): filename for previously saved tombo stats</span>
<span class="sd">            stat_type (str): type of statistic (model_compare, de_novo, or</span>
<span class="sd">                sample_compare); only applicable for new file writing</span>
<span class="sd">            region_size (int): size of chunked storage blocks; only applicable</span>
<span class="sd">                for new file writing</span>
<span class="sd">            cov_damp_counts (tuple): pseudo-counts for modified and un-modified</span>
<span class="sd">                reads to compute ``damp_frac``</span>
<span class="sd">            cov_thresh (int): only sites with coverage greater than or equal to</span>
<span class="sd">                this value will be stored</span>
<span class="sd">            num_most_signif (int): number of most significant sites to be stored</span>
<span class="sd">                for faster access</span>
<span class="sd">            most_signif_num_batches (int): number of region batches to store</span>
<span class="sd">                before re-computing the most significant array (default: 10)</span>

<span class="sd">        Warning:</span>

<span class="sd">            If all arguments are provided the current file&#39;s contents will be</span>
<span class="sd">               deleted.</span>

<span class="sd">            Intended to open a fresh ``ModelStats`` file for writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span> <span class="o">=</span> <span class="n">stats_fn</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="p">,</span>
                                       <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_for_writing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># open file for reading</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_stats</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;Invalid statistics file provided. Try running &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;tombo/scripts/convert_stats.py if this stats file &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;was created before Tombo v1.3.1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_for_writing</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># set class attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="n">stat_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="n">region_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;unmod&#39;</span><span class="p">,</span> <span class="s1">&#39;mod&#39;</span><span class="p">),</span> <span class="n">cov_damp_counts</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_thresh</span> <span class="o">=</span> <span class="n">cov_thresh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_most_signif</span> <span class="o">=</span> <span class="n">num_most_signif</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_num_batches</span> <span class="o">=</span> <span class="n">most_signif_num_batches</span>
            <span class="c1"># open file for writing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_stats_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PER_READ_STATS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="ow">in</span> <span class="n">LEVEL_STATS_TXTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;This appears to be a group-comparison stats file. Open &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;with tombo_stats.LevelStats.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;This file is not a valid ModelStats file. `stat_type` &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;listed as &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_model_stats</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;damp_frac&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s1">&#39;Est. Frac. Alternate: </span><span class="si">{0:.2g}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_update_most_signif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tmp_most_signif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">,]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span><span class="p">)</span>
        <span class="n">tmp_most_signif</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span> <span class="o">=</span> <span class="n">tmp_most_signif</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_most_signif</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_add_to_most_signif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_stats</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chrm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span><span class="p">[</span><span class="n">chrm</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_chrm_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_chrm_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_fields</span><span class="p">(</span>
            <span class="n">base</span><span class="o">=</span><span class="n">reg_stats</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">)),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span><span class="p">[</span><span class="n">chrm</span><span class="p">],</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                  <span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))),</span>
            <span class="n">dtypes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;u4&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_num_batches</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_most_signif</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_write_stat_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_stats</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write region statistics block to file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
                <span class="s1">&#39;Block_&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span><span class="s1">&#39;Statistics file not opened for writing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">chrm</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">strand</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">start</span>

        <span class="n">damp_frac</span> <span class="o">=</span> <span class="n">calc_damp_fraction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">reg_frac_standard_base</span><span class="p">,</span>
            <span class="n">reg_stats</span><span class="o">.</span><span class="n">valid_cov</span><span class="p">)</span>
        <span class="n">reg_stats_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pos_stats</span> <span class="k">for</span> <span class="n">pos_stats</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">damp_frac</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">reg_frac_standard_base</span><span class="p">,</span>
                <span class="n">reg_stats</span><span class="o">.</span><span class="n">reg_poss</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">reg_cov</span><span class="p">,</span>
                <span class="n">reg_stats</span><span class="o">.</span><span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">valid_cov</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;damp_frac&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;control_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;valid_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">)])</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;block_stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">reg_stats_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_most_signif</span><span class="p">(</span><span class="n">reg_stats_arr</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_stats</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

        <span class="c1">#self._fp.flush()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_close_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># process any remaining batches</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_most_signif</span><span class="p">()</span>
        <span class="c1"># trim the array if necessary</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># not as many signif sites were stored as requested so trim array</span>
            <span class="n">first_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">[</span>
                <span class="p">:</span><span class="n">first_nan</span><span class="p">,]</span>
        <span class="c1"># add dataset to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_sites</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="n">MOST_SIGNIF_H5_NAME</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
        <span class="c1"># and add chrm ids map to file (store in reverse order of useful dict,</span>
        <span class="c1"># since int&#39;s can&#39;t be hdf5 keys</span>
        <span class="k">for</span> <span class="n">chrm_name</span><span class="p">,</span> <span class="n">chrm_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chrm_id_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">chrm_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">chrm_id</span>

        <span class="k">return</span>

<div class="viewcode-block" id="ModelStats.close"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close open HDF5 file and write most significant sites if open for</span>
<span class="sd">        writing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_for_writing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_write</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>


    <span class="c1"># Reading functions</span>
    <span class="k">def</span> <span class="nf">_get_chrm_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_stat</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_chrm_map</span><span class="p">[</span><span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]]</span>

<div class="viewcode-block" id="ModelStats.iter_stat_seqs"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.iter_stat_seqs">[docs]</a>    <span class="k">def</span> <span class="nf">iter_stat_seqs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span> <span class="n">before_bases</span><span class="p">,</span> <span class="n">after_bases</span><span class="p">,</span> <span class="n">include_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through most significant genomic sites returning the genomic</span>
<span class="sd">        sequence surrounding each position.</span>

<span class="sd">        Args:</span>
<span class="sd">            genome_index (:class:`tombo.tombo_helper.Fasta`): genome index</span>
<span class="sd">                object</span>
<span class="sd">            before_bases (int): number of sequence bases before positions to</span>
<span class="sd">                include</span>
<span class="sd">            after_bases (int): number of sequence bases after positions to</span>
<span class="sd">                include</span>
<span class="sd">            include_pos (bool): yeild (pos_seq, chrm, strand, start, end) for</span>
<span class="sd">                each site (default: True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos_stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_stats</span><span class="p">:</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_chrm_name</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">),</span>
                                 <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                                 <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">before_bases</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">after_bases</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stat_seq</span> <span class="o">=</span> <span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">after_bases</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">before_bases</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stat_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">genome_index</span><span class="o">.</span><span class="n">get_seq</span><span class="p">(</span>
                        <span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">include_pos</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">stat_seq</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">stat_seq</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="ModelStats.iter_most_signif_sites"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.iter_most_signif_sites">[docs]</a>    <span class="k">def</span> <span class="nf">iter_most_signif_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through statistics table yeilding (chrm, strand, pos, stat).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos_stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_stats</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_chrm_name</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">),</span> <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]))</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="ModelStats.get_most_signif_regions"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.get_most_signif_regions">[docs]</a>    <span class="k">def</span> <span class="nf">get_most_signif_regions</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">unique_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">prepend_loc_to_text</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select regions centered on locations with the largest fraction of</span>
<span class="sd">        modified bases</span>

<span class="sd">        Args:</span>
<span class="sd">            num_bases (int): number of bases to output</span>
<span class="sd">            num_regions (int): number of regions to output</span>
<span class="sd">            unique_pos (bool): get only unique positions (optional; default</span>
<span class="sd">                True) intervals may overlap, but identified significant</span>
<span class="sd">                position is outside other intervals</span>
<span class="sd">            prepend_loc_to_text (bool): pre-prend most significant location to</span>
<span class="sd">               the region text (can be off for interval near start/end of</span>
<span class="sd">               sequence records)</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of :class:`tombo.tombo_helper.intervalData` objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_regs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">used_intervals</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos_stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">most_signif_stats</span><span class="p">):</span>
            <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_bases</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
            <span class="n">chrm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_chrm_name</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">)</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">unique_pos</span> <span class="ow">or</span>
                <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_intervals</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]):</span>
                <span class="n">used_intervals</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">int_start</span><span class="p">,</span> <span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">))</span>
                <span class="n">int_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span><span class="p">(</span><span class="n">pos_stat</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">prepend_loc_to_text</span><span class="p">:</span>
                    <span class="n">int_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1:d}</span><span class="s1">:</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">chrm</span><span class="p">,</span> <span class="n">pos_stat</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">int_text</span>
                <span class="n">selected_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
                    <span class="n">chrm</span><span class="o">=</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">int_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">int_start</span> <span class="o">+</span> <span class="n">num_bases</span><span class="p">,</span>
                    <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">,</span> <span class="n">reg_id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                    <span class="n">reg_text</span><span class="o">=</span><span class="n">int_text</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_regs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_regions</span><span class="p">:</span> <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_regs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;No locations identified. Most likely an empty &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;statistics file.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_regs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_regions</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Fewer unique significant locations more than &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;[--num-bases]/2 apart were identified. Continuing with &#39;</span> <span class="o">+</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_regs</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; unique locations. Must raise &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;--num-most-significant-stored in order to see more most &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;significant stats.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">selected_regs</span></div>

<div class="viewcode-block" id="ModelStats.compute_motif_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.compute_motif_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and whether this site represents a</span>
<span class="sd">        match to the provided motifs</span>

<span class="sd">        Args:</span>
<span class="sd">            motif_descs (list; see</span>
<span class="sd">                :class:`tombo.tombo_helper.parse_motif_descs`): containing</span>
<span class="sd">                tuples with :class:`tombo.tombo_helper.TomboMotif` and</span>
<span class="sd">                motif/modification names</span>
<span class="sd">            genome_index (:class:`tombo.tombo_helper.Fasta`): genome index</span>
<span class="sd">            stats_per_block (int): statistics to include in calculations</span>
<span class="sd">                per-block (`--multiprocess-region-size`)</span>
<span class="sd">            total_stats_limit (int): maximum total statistics to include in</span>
<span class="sd">               computation (Default: include all stats)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean motif match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span> <span class="n">stats_per_block</span><span class="o">=</span><span class="n">stats_per_block</span><span class="p">,</span>
            <span class="n">total_stats_limit</span><span class="o">=</span><span class="n">total_stats_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelStats.compute_ground_truth_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.compute_ground_truth_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ground_truth_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_locs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and ground truth modification</span>
<span class="sd">        status (boolean)</span>

<span class="sd">        Args:</span>
<span class="sd">            ground_truth_locs: list containing tuples of 1) modified locations</span>
<span class="sd">                (from :class:`tombo.tombo_helper.parse_locs_file`), 2)</span>
<span class="sd">                unmodified locations and mod names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean motif match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_ground_truth_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_locs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelStats.compute_ctrl_motif_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.compute_ctrl_motif_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ctrl_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ctrl_stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and whether this site represents a</span>
<span class="sd">        match to the provided motifs</span>

<span class="sd">        Args:</span>
<span class="sd">            ctrl_stats (:class:`tombo.tombo_stats.ModelStats`): control</span>
<span class="sd">                statistics</span>
<span class="sd">            motif_descs (list; see</span>
<span class="sd">                :class:`tombo.tombo_helper.parse_motif_descs`): containing</span>
<span class="sd">                tuples with :class:`tombo.tombo_helper.TomboMotif` and</span>
<span class="sd">                motif/modification names</span>
<span class="sd">            genome_index (:class:`tombo.tombo_helper.Fasta`): genome index</span>
<span class="sd">            stats_per_block (int): statistics to include in calculations</span>
<span class="sd">                per-block (`--multiprocess-region-size`)</span>
<span class="sd">            total_stats_limit (int): maximum total statistics to include in</span>
<span class="sd">                computation (Default: include all stats)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean native or control</span>
<span class="sd">            sample stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_ctrl_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ctrl_stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="n">stats_per_block</span><span class="p">,</span>
            <span class="n">total_stats_limit</span><span class="o">=</span><span class="n">total_stats_limit</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator over all statistics blocks, yeilding chrm, strand, start,</span>
<span class="sd">        end, block_stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_start</span><span class="p">,</span> <span class="n">next_block_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># move to next chromosome and strand</span>
            <span class="c1"># this will raise a second StopIteration</span>
            <span class="c1"># when the end of the blocks is hit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">next_start</span><span class="p">,</span> <span class="n">next_block_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span><span class="p">)</span>

        <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="p">[</span><span class="n">next_block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:])</span>

    <span class="c1"># for python2 compatibility</span>
<div class="viewcode-block" id="ModelStats.next"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return next statistics block from file including (chrm, strand,</span>
<span class="sd">        block start, block end and statistics table ``numpy structured array``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModelStats.get_pos_stat"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.get_pos_stat">[docs]</a>    <span class="k">def</span> <span class="nf">get_pos_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">missing_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract statistic value from the requested genomic position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pos_block_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span>
            <span class="c1"># TODO: blocks may have missing data (consider full sized blocks</span>
            <span class="c1"># for random disk access to single or range of elements)</span>
            <span class="c1">#block_pos = np.remainder(pos, self.region_size)</span>
            <span class="n">block_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)][</span><span class="n">pos_block_start</span><span class="p">]</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:]</span>
            <span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">block_data</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">KeyError</span>
            <span class="n">pos_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span><span class="p">(</span><span class="n">block_data</span><span class="p">[</span><span class="n">pos_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">pos_stat</span> <span class="o">=</span> <span class="n">missing_value</span>

        <span class="k">return</span> <span class="n">pos_stat</span></div>

<div class="viewcode-block" id="ModelStats.get_reg_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.ModelStats.get_reg_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_reg_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">reg_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># if this is an overlapping block</span>
            <span class="k">if</span> <span class="n">reg_start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="c1"># extract stats overlapping this region</span>
                <span class="n">reg_stats_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:]</span>
                <span class="n">reg_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">end</span><span class="p">))])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reg_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LevelStats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.LevelStats">[docs]</a><span class="k">class</span> <span class="nc">LevelStats</span><span class="p">(</span><span class="n">ModelStats</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_create_new_stats_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># try to remove file for overwriting old results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># open file for writing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># save attributes to file and open stats blocks group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">STAT_BLOCKS_H5_NAME</span><span class="p">)</span>

        <span class="c1"># save coverage damp counts and threshold attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">COV_THRESH_H5_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_thresh</span>

        <span class="c1"># storage for most significant stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">MOST_SIGNIF_H5_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_most_signif</span><span class="p">,),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;control_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">),</span> <span class="s1">&#39;S1&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_most_signif_sites</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="c1"># store a queue of completed stat batches to be concatenated and stored</span>
        <span class="c1"># as a group to avoid too many array copy and sorting ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queued_stat_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># store chromosomes names in dict for storing most signif array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_chrm_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrm_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrm_id_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_sites</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;chrm_ids&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cov_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">most_signif_num_batches</span><span class="o">=</span><span class="n">MOST_SIGNIF_NUM_BATCHES_DEFAULT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse or open for writing a standard (per-genomic base) Tombo</span>
<span class="sd">        statistics file.</span>

<span class="sd">        Example::</span>

<span class="sd">            stats = tombo_stats.TomboStats(&#39;path/to/stats.file&#39;)</span>
<span class="sd">            for chrm, strand, pos, nl_pval in \</span>
<span class="sd">                    stats.iter_most_signif_sites():</span>
<span class="sd">                # do stuff</span>

<span class="sd">        Args:</span>
<span class="sd">            stats_fn (str): filename for previously saved tombo stats</span>
<span class="sd">            stat_type (str): type of statistic (ks, ttest, utest); only</span>
<span class="sd">                applicable for new file writing</span>
<span class="sd">            region_size (int): size of chunked storage blocks; only applicable</span>
<span class="sd">                for new file writing</span>
<span class="sd">            cov_thresh (int): only sites with coverage greater than or equal to</span>
<span class="sd">                this value will be stored</span>
<span class="sd">            num_most_signif (int): number of most significant sites to be stored</span>
<span class="sd">                for faster access</span>
<span class="sd">            most_signif_num_batches (int): number of region batches to store</span>
<span class="sd">                before re-computing the most significant array (default: 10)</span>

<span class="sd">        Warning:</span>

<span class="sd">            If all arguments are provided the current file&#39;s contents will be</span>
<span class="sd">               deleted.</span>

<span class="sd">            Intended to open a fresh ``ModelStats`` file for writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_fn</span> <span class="o">=</span> <span class="n">stats_fn</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_for_writing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># open file for reading</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_stats</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;Invalid statistics file provided. Try running &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;tombo/scripts/convert_stats.py if this stats file &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;was created before Tombo v1.3.1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_for_writing</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># set class attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="n">stat_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="n">region_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_thresh</span> <span class="o">=</span> <span class="n">cov_thresh</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_most_signif</span> <span class="o">=</span> <span class="n">num_most_signif</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">most_signif_num_batches</span> <span class="o">=</span> <span class="n">most_signif_num_batches</span>
            <span class="c1"># open file for writing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_stats_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LEVEL_STATS_TXTS</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="ow">in</span> <span class="n">PER_READ_STATS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                    <span class="s1">&#39;This appears to be a model-based comparison stats &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;file. Open with tombo_stats.ModelStats.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;This file is not a valid LevelStats file. `stat_type` &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;listed as &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">)</span>

        <span class="c1"># set values to access statistics consistently</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_model_stats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KS_TEST_TXT</span><span class="p">,</span> <span class="n">U_TEST_TXT</span><span class="p">,</span> <span class="n">T_TEST_TXT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s1">&#39;-log10(p-value): </span><span class="si">{0:.2g}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                <span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">==</span> <span class="n">KS_STAT_TEST_TXT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s1">&#39;D Statistic: </span><span class="si">{0:.2g}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">==</span> <span class="n">U_STAT_TEST_TXT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s1">&#39;Common Language Marginal Effect: </span><span class="si">{0:.2g}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="o">-</span><span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">==</span> <span class="n">T_STAT_TEST_TXT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s2">&quot;Cohen&#39;s D: </span><span class="si">{0:.2g}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="o">-</span><span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Unknown statistic type.&#39;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_write_stat_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grp_stats</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write region group statistics block to file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_blocks</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
                <span class="s1">&#39;Block_&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span><span class="s1">&#39;Statistics file not opened for writing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">chrm</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">strand</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">start</span>

        <span class="n">grp_stats_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pos_stats</span> <span class="k">for</span> <span class="n">pos_stats</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">grp_stats</span><span class="o">.</span><span class="n">reg_stats</span><span class="p">,</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">reg_poss</span><span class="p">,</span>
                <span class="n">grp_stats</span><span class="o">.</span><span class="n">reg_cov</span><span class="p">,</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">ctrl_cov</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;control_cov&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">)])</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;block_stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">grp_stats_arr</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_most_signif</span><span class="p">(</span>
            <span class="n">grp_stats_arr</span><span class="p">,</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">grp_stats</span><span class="o">.</span><span class="n">strand</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="TomboStats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.TomboStats">[docs]</a><span class="k">def</span> <span class="nf">TomboStats</span><span class="p">(</span><span class="n">stat_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load per-reference location Tombo statistics. Safe method to load statistics for read-only purposes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either :class:`tombo.tombo_stats.ModelStats` or :class:`tombo.tombo_stats.LevelStats` depending on the type of Tombo statistics file provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">ModelStats</span><span class="p">(</span><span class="n">stat_fn</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">LevelStats</span><span class="p">(</span><span class="n">stat_fn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="PerReadStats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats">[docs]</a><span class="k">class</span> <span class="nc">PerReadStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store and accses per-read modified base testing statistics</span>

<span class="sd">    .. automethod:: __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO add attributes</span>
    <span class="k">def</span> <span class="nf">_parse_per_read_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stat_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_size&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="p">[</span><span class="n">STAT_BLOCKS_H5_NAME</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blocks_index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">block_name</span><span class="p">,</span> <span class="n">block_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">blocks_index</span><span class="p">[</span>
                <span class="p">(</span><span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chrm&#39;</span><span class="p">),</span> <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strand&#39;</span><span class="p">))][</span>
                    <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">block_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">blocks_index</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_create_new_per_read_stats_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># try to remove file for overwriting old results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">per_read_stats_fn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># open file for writing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># save attributes to file and open stats blocks group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;block_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">STAT_BLOCKS_H5_NAME</span><span class="p">)</span>

        <span class="k">return</span>

<div class="viewcode-block" id="PerReadStats.__init__"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_read_stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open per-read statistics file.</span>

<span class="sd">        Examples::</span>

<span class="sd">            per_read_stats = tombo_stats.PerReadStats(\</span>
<span class="sd">                &#39;path/to/sample.tombo.per_read_stats&#39;)</span>
<span class="sd">            int_data = tombo_helper.intervalData(</span>
<span class="sd">                chrm=&#39;chr20&#39;, start=10000, end=10100, strand=&#39;+&#39;)</span>
<span class="sd">            reg_per_read_stats = per_read_stats.get_region_per_read_stats(</span>
<span class="sd">                int_data, num_reads=10)</span>

<span class="sd">        Args:</span>

<span class="sd">            per_read_stats_fn (str): filename containing (or to write) per-read</span>
<span class="sd">                Tombo statistics</span>
<span class="sd">            stat_type (str): type of statistic (model_compare, de_novo, or</span>
<span class="sd">                sample_compare); only applicable for new file writing</span>
<span class="sd">            region_size (int): size of chunked storage blocks; only applicable</span>
<span class="sd">                for new file writing</span>

<span class="sd">        Warning:</span>

<span class="sd">            If ``stat_type`` and ``region_size`` are provided the current</span>
<span class="sd">            file&#39;s contents will be deleted.</span>

<span class="sd">            Intended to open a fresh ``PerReadStats`` file for writing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_read_stats_fn</span> <span class="o">=</span> <span class="n">per_read_stats_fn</span>
        <span class="k">if</span> <span class="n">stat_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">region_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># open file for reading</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_per_read_stats</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                    <span class="s1">&#39;Non-existent or invalid per-read statistics file &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;provided.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set class attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">=</span> <span class="n">stat_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="n">region_size</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_per_read_stats_file</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">are_pvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat_type</span> <span class="o">!=</span> <span class="n">ALT_MODEL_TXT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_text</span> <span class="o">=</span> <span class="s1">&#39;-log10(p-value): </span><span class="si">{0:.2g}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stat_transform</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pos_stat</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
            <span class="n">pos_stat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">])</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_write_per_read_block</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">per_read_block</span><span class="p">,</span> <span class="n">read_id_lookup</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write region statistics block to file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span>
                <span class="s1">&#39;Block_&#39;</span> <span class="o">+</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_block_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Per-read statistics file not opened for writing.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;chrm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chrm</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strand</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;block_stats&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">per_read_block</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
        <span class="c1"># add lookup dict for read_id slot stored in table to save space and</span>
        <span class="c1"># avoid memory leak due to vlen slots in h5py datasets</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">(</span><span class="n">vlen</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">read_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">read_id_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">read_ids_ds</span> <span class="o">=</span> <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;read_ids&#39;</span><span class="p">,</span> <span class="n">read_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
        <span class="n">read_ids_ds</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_ids</span>
        <span class="n">block_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
            <span class="s1">&#39;read_id_vals&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">read_id_lookup</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span>

<div class="viewcode-block" id="PerReadStats.get_region_per_read_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.get_region_per_read_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_region_per_read_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_data</span><span class="p">,</span> <span class="n">num_reads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract per-read statistics over the specifed interval.</span>

<span class="sd">        Args:</span>

<span class="sd">            interval_data (:class:`tombo.tombo_helper.intervalData`):</span>
<span class="sd">                genomic interval</span>
<span class="sd">            num_reads (int): randomly select this many reads (default: inlcude</span>
<span class="sd">                all reads)</span>

<span class="sd">        Returns:</span>
<span class="sd">            `np.array` structured array containing ``pos``, ``stat`` and</span>
<span class="sd">            ``read_id`` for per-read stats over requested interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cs_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[(</span>
                <span class="n">interval_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">strand</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">int_block_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">block_start</span><span class="p">,</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">cs_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">interval_data</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">block_start</span> <span class="ow">or</span>
                <span class="n">interval_data</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">block_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c1"># extract stats from FAST5</span>
            <span class="n">block_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:]</span>
            <span class="n">reg_poss</span> <span class="o">=</span> <span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">reg_read_stats</span> <span class="o">=</span> <span class="n">block_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stat_slot</span><span class="p">]</span>
            <span class="c1"># extract and convert read_ids back into strings</span>
            <span class="k">if</span> <span class="s1">&#39;read_id_vals&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">]:</span>
                <span class="n">block_read_id_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">read_id_val</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">read_id</span><span class="p">,</span> <span class="n">read_id_val</span> <span class="ow">in</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;read_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;read_id_vals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># read_ids previously stored (inefficiently) as attributes</span>
                <span class="c1"># so parse read_ids attributes for backwards compatibility</span>
                <span class="n">block_read_id_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">read_id_val</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">read_id</span><span class="p">,</span> <span class="n">read_id_val</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;read_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="n">reg_read_ids</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">block_read_id_lookup</span><span class="p">[</span><span class="n">r_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_id</span> <span class="ow">in</span> <span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]]</span>
            <span class="n">int_block_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">,</span> <span class="n">reg_read_stats</span><span class="p">,</span> <span class="n">reg_read_ids</span><span class="p">)),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">),</span> <span class="nb">object</span><span class="p">)]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">int_block_stats</span> <span class="o">=</span> <span class="n">int_block_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_block_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">int_block_stats</span><span class="p">)</span>

        <span class="n">all_int_stats</span> <span class="o">=</span> <span class="n">int_block_stats</span><span class="p">[</span>
            <span class="p">(</span><span class="n">int_block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">int_block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>

        <span class="n">read_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_reads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_reads</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_ids</span><span class="p">):</span>
            <span class="n">int_plot_reads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">read_ids</span><span class="p">,</span> <span class="n">num_reads</span><span class="p">))</span>
            <span class="n">all_int_stats</span> <span class="o">=</span> <span class="n">all_int_stats</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">read_id</span> <span class="ow">in</span> <span class="n">int_plot_reads</span>
                          <span class="k">for</span> <span class="n">read_id</span> <span class="ow">in</span> <span class="n">all_int_stats</span><span class="p">[</span><span class="s1">&#39;read_id&#39;</span><span class="p">]])]</span>

        <span class="k">return</span> <span class="n">all_int_stats</span></div>

<div class="viewcode-block" id="PerReadStats.compute_motif_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.compute_motif_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and whether this site represents a</span>
<span class="sd">        match to the provided motifs</span>

<span class="sd">        Args:</span>
<span class="sd">            motif_descs (list; see</span>
<span class="sd">                :class:`tombo.tombo_helper.parse_motif_descs`): containing</span>
<span class="sd">                tuples with :class:`tombo.tombo_helper.TomboMotif` and</span>
<span class="sd">                motif/modification names</span>
<span class="sd">            genome_index (:class:`tombo.tombo_helper.Fasta`): genome index</span>
<span class="sd">            stats_per_block (int): statistics to include in calculations</span>
<span class="sd">                per-block (`--multiprocess-region-size`)</span>
<span class="sd">            total_stats_limit (int): maximum total statistics to include in</span>
<span class="sd">                computation (Default: include all stats)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean motif match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span> <span class="n">stats_per_block</span><span class="o">=</span><span class="n">stats_per_block</span><span class="p">,</span>
            <span class="n">total_stats_limit</span><span class="o">=</span><span class="n">total_stats_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerReadStats.compute_ground_truth_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.compute_ground_truth_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ground_truth_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_locs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and ground truth modification</span>
<span class="sd">        status (boolean)</span>

<span class="sd">        Args:</span>
<span class="sd">            ground_truth_locs: list containing tuples of 1) modified locations</span>
<span class="sd">                (from :class:`tombo.tombo_helper.parse_locs_file`), 2)</span>
<span class="sd">                unmodified locations and mod names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean motif match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_ground_truth_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_locs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerReadStats.compute_ctrl_motif_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.compute_ctrl_motif_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ctrl_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">pr_ctrl_stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total_stats_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute lists of statistic values and whether this site represents a</span>
<span class="sd">        match to the provided motifs</span>

<span class="sd">        Args:</span>
<span class="sd">            pr_ctrl_stats (:class:`tombo.tombo_stats.PerReadStats`): control</span>
<span class="sd">                per-read statistics</span>
<span class="sd">            motif_descs (list; see</span>
<span class="sd">                :class:`tombo.tombo_helper.parse_motif_descs`): containing</span>
<span class="sd">                tuples with :class:`tombo.tombo_helper.TomboMotif` and</span>
<span class="sd">                motif/modification names</span>
<span class="sd">            genome_index (:class:`tombo.tombo_helper.Fasta`): genome index</span>
<span class="sd">            stats_per_block (int): statistics to include in calculations</span>
<span class="sd">                per-block (`--multiprocess-region-size`)</span>
<span class="sd">            total_stats_limit (int): maximum total statistics to include in</span>
<span class="sd">                computation (Default: include all stats)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with (key) motif/modification name and (value) list of</span>
<span class="sd">            tuples containing statistic value and boolean native or control</span>
<span class="sd">            sample stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_compute_ctrl_motif_stats</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">pr_ctrl_stats</span><span class="p">,</span> <span class="n">motif_descs</span><span class="p">,</span> <span class="n">genome_index</span><span class="p">,</span>
            <span class="n">stats_per_block</span><span class="o">=</span><span class="n">stats_per_block</span><span class="p">,</span>
            <span class="n">total_stats_limit</span><span class="o">=</span><span class="n">total_stats_limit</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator over all statistics blocks, yeilding chrm, strand,</span>
<span class="sd">        start, end, block_stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_start</span><span class="p">,</span> <span class="n">next_block_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c1"># move to next chromosome and strand</span>
            <span class="c1"># this will raise a second StopIteration</span>
            <span class="c1"># when the end of the blocks is hit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_all_cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">next_start</span><span class="p">,</span> <span class="n">next_block_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs_blocks</span><span class="p">)</span>

        <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_curr_cs</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span><span class="n">next_block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:])</span>

    <span class="c1"># for python2 compatibility</span>
<div class="viewcode-block" id="PerReadStats.next"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return next per-read statistics block from file including (chrm,</span>
<span class="sd">        strand, block start, block end and per-read statistics table</span>
<span class="sd">        ``numpy structured array``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span></div>

<div class="viewcode-block" id="PerReadStats.close"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close HDF5 file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="PerReadStats.get_reg_stats"><a class="viewcode-back" href="../../tombo.html#tombo.tombo_stats.PerReadStats.get_reg_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_reg_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">reg_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocks_index</span><span class="p">[(</span><span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">)]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># if this is an overlapping block</span>
            <span class="k">if</span> <span class="n">reg_start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="c1"># extract stats overlapping this region</span>
                <span class="n">reg_stats_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_read_blocks</span><span class="p">[</span>
                    <span class="n">block_name</span><span class="p">][</span><span class="s1">&#39;block_stats&#39;</span><span class="p">][:]</span>
                <span class="n">reg_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">reg_stats_block</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">end</span><span class="p">))])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reg_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span></div></div>


<span class="c1">################################</span>
<span class="c1">##### Base-by-base Testing #####</span>
<span class="c1">################################</span>

<span class="k">def</span> <span class="nf">compute_posterior_samp_dists</span><span class="p">(</span>
        <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">prior_weights</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">):</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">gnm_begin_lag</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="k">if</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">dnstrm_bases</span><span class="p">)</span>
    <span class="n">gnm_end_lag</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dnstrm_bases</span> <span class="k">if</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">)</span>
    <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">gnm_begin_lag</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">gnm_end_lag</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span><span class="o">.</span><span class="n">add_seq</span><span class="p">()</span><span class="o">.</span><span class="n">seq</span>
    <span class="k">if</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">reg_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">rev_comp</span><span class="p">(</span><span class="n">reg_seq</span><span class="p">)</span>

    <span class="n">reg_ref_means</span><span class="p">,</span> <span class="n">reg_ref_sds</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_seq_with_gaps</span><span class="p">(</span>
        <span class="n">reg_seq</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="c1"># compute vectorized weighted means for new mean and sd estimates</span>
    <span class="n">post_ref_means</span> <span class="o">=</span> <span class="p">((</span>
        <span class="p">(</span><span class="n">prior_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">reg_ref_means</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ctrl_cov</span> <span class="o">*</span> <span class="n">ctrl_means</span><span class="p">))</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">prior_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ctrl_cov</span><span class="p">))</span>
    <span class="n">post_ref_sds</span> <span class="o">=</span> <span class="p">((</span>
        <span class="p">(</span><span class="n">prior_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">reg_ref_sds</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ctrl_cov</span> <span class="o">*</span> <span class="n">ctrl_sds</span><span class="p">))</span> <span class="o">/</span>
                    <span class="p">(</span><span class="n">prior_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ctrl_cov</span><span class="p">))</span>

    <span class="c1"># This bit should work, but the SD estimates seem to be incorrect</span>
    <span class="c1"># and the computation is likely far too much for likely very similar</span>
    <span class="c1"># results from a weighted average with the prior SD.</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # compute posterior sds; see example formula here:</span>
<span class="sd">    # https://www.statlect.com/fundamentals-of-statistics/\</span>
<span class="sd">    #     normal-distribution-Bayesian-estimation</span>
<span class="sd">    # optimizations to matrix ops applied here</span>
<span class="sd">    def compute_mean_diff_factor(event_means, ref_mean):</span>
<span class="sd">        valid_indices = ~np.isnan(event_means)</span>
<span class="sd">        num_valid_indices = sum(valid_indices)</span>
<span class="sd">        if num_valid_indices &lt; min_test_reads:</span>
<span class="sd">            return np.NAN</span>
<span class="sd">        n = float(num_valid_indices + prior_weights[0])</span>
<span class="sd">        c1 = (n - 1) / n</span>
<span class="sd">        c2 = -1 / n</span>
<span class="sd">        mean_diffs = event_means[valid_indices] - ref_mean</span>
<span class="sd">        mds_sum = mean_diffs.sum()</span>
<span class="sd">        return sum(((i_md * c1) + (mds_sum - i_md) * c2) * i_md</span>
<span class="sd">                   for i, i_md in enumerate(mean_diffs))</span>
<span class="sd">    mean_diff_factors = np.array([</span>
<span class="sd">        compute_mean_diff_factor(b_events, ref_mean)</span>
<span class="sd">        for b_events, ref_mean in zip(ctrl_base_events, reg_ref_means)])</span>
<span class="sd">    post_ref_sds = np.sqrt((</span>
<span class="sd">        mean_diff_factors + (prior_weights[1] * np.square(reg_ref_sds))) / (</span>
<span class="sd">            ctrl_cov + prior_weights[1]))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">post_ref_means</span><span class="p">,</span> <span class="n">post_ref_sds</span>

<span class="k">def</span> <span class="nf">get_reads_ref</span><span class="p">(</span>
        <span class="n">reg_data</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prior_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">est_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get mean and standard deviation of levels from a sample across the genome</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">central_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span> <span class="k">if</span> <span class="n">est_mean</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span>
    <span class="n">reg_size</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">fm_offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">level_means</span><span class="p">,</span> <span class="n">level_sds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">reg_size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">reg_size</span><span class="p">)</span>
    <span class="n">level_means</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">level_sds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

    <span class="c1"># expand region to include fm_offset</span>
    <span class="n">bases_levels</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span><span class="o">.</span><span class="n">get_base_levels</span><span class="p">()</span>
    <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bases_levels</span><span class="p">))</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cov_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">),</span> <span class="p">[</span><span class="kc">False</span><span class="p">,]])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_regs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">level_means</span><span class="p">,</span> <span class="n">level_sds</span><span class="p">,</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cov_start</span><span class="p">,</span> <span class="n">cov_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cov_regs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">cov_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">level_means</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">central_func</span><span class="p">(</span><span class="n">b_levels</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">[</span><span class="n">cov_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_levels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bases_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">])])</span>
        <span class="n">level_sds</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">b_levels</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">[</span><span class="n">cov_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b_levels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bases_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">])])</span>

    <span class="k">if</span> <span class="n">std_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prior_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prior_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">MEAN_PRIOR_CONST</span><span class="p">,</span> <span class="n">SD_PRIOR_CONST</span><span class="p">)</span>
        <span class="n">level_means</span><span class="p">,</span> <span class="n">level_sds</span> <span class="o">=</span> <span class="n">compute_posterior_samp_dists</span><span class="p">(</span>
            <span class="n">level_means</span><span class="p">,</span> <span class="n">level_sds</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
            <span class="n">prior_weights</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>

    <span class="c1"># convert coverage to a dict for later lookup</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">,</span>
                         <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">),</span> <span class="n">cov</span><span class="p">))</span>

    <span class="c1"># mask regions with 0 estimated SD (likely very low coverage)</span>
    <span class="n">zero_sd_sites</span> <span class="o">=</span> <span class="n">level_sds</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">level_means</span><span class="p">[</span><span class="n">zero_sd_sites</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="n">level_sds</span><span class="p">[</span><span class="n">zero_sd_sites</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>

    <span class="k">return</span> <span class="n">level_means</span><span class="p">,</span> <span class="n">level_sds</span><span class="p">,</span> <span class="n">cov</span>

<span class="k">def</span> <span class="nf">compute_sample_compare_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">fm_offset</span><span class="o">=</span><span class="n">FM_OFFSET_DEFAULT</span><span class="p">,</span>
        <span class="n">reg_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute signficance statistics using comparison of two sequenceing</span>
<span class="sd">    samples method for a single read within a specified genomic region.</span>

<span class="sd">    Args:</span>

<span class="sd">        r_data (:class:`tombo.tombo_helper.readData`): read data</span>
<span class="sd">        ctrl_means (`np.array::np.float64`): mean level values from control set</span>
<span class="sd">            of reads</span>
<span class="sd">        ctrl_sds (`np.array::np.float64`): level SD values from control set of</span>
<span class="sd">            reads</span>
<span class="sd">        fm_offset (int): Fisher&#39;s Method offset for computing locally combined</span>
<span class="sd">            p-values (optional; default: 1)</span>
<span class="sd">        reg_data (:class:`tombo.tombo_helper.intervalData`): region to test</span>
<span class="sd">            (default: test whole read)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Read testing results, positions tested and the read_id</span>

<span class="sd">        1) r_pvals (`np.array::np.float64`): p-values for testing over specified region</span>
<span class="sd">        2) r_poss (`np.array::np.int64`): genomic positions for returned p-values</span>
<span class="sd">        3) read_id (str): read identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reg_start</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
    <span class="n">reg_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">comp_clip_and_flip</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_single_slot_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain re-squiggled level means.&#39;</span><span class="p">)</span>

        <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
        <span class="k">if</span> <span class="n">read_start</span> <span class="o">+</span> <span class="n">fm_offset</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">read_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">read_end</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_end</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span><span class="p">)</span>
            <span class="n">read_end</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span> <span class="o">+</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>

        <span class="c1"># flip means to match genomic positions</span>
        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span>

    <span class="k">def</span> <span class="nf">get_read_comp_z_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">):</span>
        <span class="n">r_z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">r_means</span> <span class="o">-</span> <span class="n">ctrl_means</span><span class="p">[</span><span class="n">read_start</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">:</span>
                                 <span class="n">read_end</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">])</span> <span class="o">/</span> <span class="n">ctrl_sds</span><span class="p">[</span>
                                     <span class="n">read_start</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">:</span>
                                     <span class="n">read_end</span> <span class="o">-</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">r_z_scores</span>

    <span class="k">def</span> <span class="nf">get_pvals</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">):</span>
        <span class="c1"># mask out nan z-scores for efficient CDF computation</span>
        <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">r_z_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">r_pvals</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="n">valid_r_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">r_z_scores</span><span class="p">[</span><span class="n">r_poss</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_r_pvals</span>

        <span class="k">return</span> <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span>

    <span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">comp_clip_and_flip</span><span class="p">()</span>
    <span class="n">r_z_scores</span> <span class="o">=</span> <span class="n">get_read_comp_z_score</span><span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;No valid z-scores in read.&#39;</span><span class="p">)</span>
    <span class="n">r_pvals</span><span class="p">,</span> <span class="n">r_poss</span> <span class="o">=</span> <span class="n">get_pvals</span><span class="p">(</span><span class="n">r_z_scores</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">calc_window_fishers_method</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>
        <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">r_pvals</span><span class="p">[</span><span class="n">r_poss</span><span class="p">]</span>

    <span class="n">r_poss</span> <span class="o">+=</span> <span class="n">read_start</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">SAMP_COMP_TXT</span><span class="p">:</span><span class="n">r_pvals</span><span class="p">},</span> <span class="p">{</span><span class="n">SAMP_COMP_TXT</span><span class="p">:</span><span class="n">r_poss</span><span class="p">},</span> <span class="n">read_id</span>

<span class="k">def</span> <span class="nf">compute_de_novo_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">fm_offset</span><span class="o">=</span><span class="n">FM_OFFSET_DEFAULT</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute signficance statistics using de novo comparison to a canonical</span>
<span class="sd">    model method for a single read within a specified genomic region.</span>

<span class="sd">    Args:</span>

<span class="sd">        r_data (:class:`tombo.tombo_helper.readData`): read data</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical expected</span>
<span class="sd">           signal level model</span>
<span class="sd">        fm_offset (int): Fisher&#39;s Method offset for computing locally combined</span>
<span class="sd">            p-values (optional; default: 1)</span>
<span class="sd">        reg_data (:class:`tombo.tombo_helper.intervalData`): region to test</span>
<span class="sd">            (default: test whole read)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Read testing results, positions tested and the read_id</span>

<span class="sd">        1) r_pvals (`np.array::np.float64`): p-values for testing over specified region</span>
<span class="sd">        2) r_poss (`np.array::np.int64`): genomic positions for returned p-values</span>
<span class="sd">        3) read_id (str): read identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reg_start</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
    <span class="n">reg_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="n">dnstrm_bases</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">gnm_begin_lag</span> <span class="o">=</span> <span class="p">(</span><span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span> <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span>
                     <span class="n">dnstrm_bases</span><span class="p">)</span>
    <span class="n">gnm_end_lag</span> <span class="o">=</span> <span class="p">(</span><span class="n">dnstrm_bases</span> <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="k">else</span>
                   <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">de_novo_clip_and_flip</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain valid re-squiggled data.&#39;</span><span class="p">)</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>
        <span class="c1"># clip read if it extends outside the current genomic region, so</span>
        <span class="c1"># stats are only computed within this region</span>
        <span class="k">if</span> <span class="n">read_start</span> <span class="o">+</span> <span class="n">gnm_begin_lag</span> <span class="o">+</span> <span class="n">fm_offset</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">read_start</span> <span class="o">+</span> <span class="n">gnm_begin_lag</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span>
            <span class="n">read_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="n">gnm_begin_lag</span> <span class="o">-</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_start_clip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">read_end</span> <span class="o">-</span> <span class="n">gnm_end_lag</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_end</span> <span class="o">-</span> <span class="n">gnm_end_lag</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span><span class="p">)</span>
            <span class="n">read_end</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">+</span> <span class="n">reg_size</span> <span class="o">+</span> <span class="n">gnm_end_lag</span> <span class="o">+</span> <span class="n">fm_offset</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>
                <span class="n">r_seq</span> <span class="o">=</span> <span class="n">r_seq</span><span class="p">[</span><span class="n">num_end_clip</span><span class="p">:]</span>

        <span class="c1"># if this read does not cover enough of this region for stat</span>
        <span class="c1"># computation raise an error to be handled below</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain information in this region.&#39;</span><span class="p">)</span>

        <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_seq</span><span class="p">(</span>
            <span class="n">r_seq</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="c1"># reverse means to match genomic order</span>
            <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># clip means that don&#39;t have testing model data</span>
        <span class="c1"># note that this is still extended by fm_offset</span>
        <span class="n">r_means</span> <span class="o">=</span> <span class="n">r_means</span><span class="p">[</span><span class="n">gnm_begin_lag</span><span class="p">:</span><span class="o">-</span><span class="n">gnm_end_lag</span><span class="p">]</span>
        <span class="n">read_start</span> <span class="o">+=</span> <span class="n">gnm_begin_lag</span>
        <span class="n">read_end</span> <span class="o">-=</span> <span class="n">gnm_end_lag</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span> <span class="n">read_start</span><span class="p">,</span>
                <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span>


    <span class="p">(</span><span class="n">r_means</span><span class="p">,</span> <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span><span class="p">,</span>
     <span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">,</span> <span class="n">read_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">de_novo_clip_and_flip</span><span class="p">()</span>

    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_means</span> <span class="o">-</span> <span class="n">r_ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_ref_sds</span>
    <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">z_scores</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="k">if</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">calc_window_fishers_method</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>

    <span class="c1"># ignore errors in max over NAN values if fisher&#39;s method was used</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">r_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_pvals</span><span class="p">,</span> <span class="n">SMALLEST_PVAL</span><span class="p">)</span>

    <span class="n">r_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">read_start</span><span class="p">,</span> <span class="n">read_end</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">DE_NOVO_TXT</span><span class="p">:</span><span class="n">r_pvals</span><span class="p">},</span> <span class="p">{</span><span class="n">DE_NOVO_TXT</span><span class="p">:</span><span class="n">r_poss</span><span class="p">},</span> <span class="n">read_id</span>

<span class="k">def</span> <span class="nf">calc_llh_ratio</span><span class="p">(</span>
        <span class="n">reg_means</span><span class="p">,</span> <span class="n">reg_ref_means</span><span class="p">,</span> <span class="n">reg_ref_vars</span><span class="p">,</span> <span class="n">reg_alt_means</span><span class="p">,</span> <span class="n">reg_alt_vars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute log likelihood ratio. This is about 10X slower than the cython</span>
<span class="sd">    version in tombo._c_helper, but has been kept for debugging purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute log likelihood ratio</span>
    <span class="c1"># positive value means standard base fits data better</span>
    <span class="c1"># negative value means alternative base fits data better</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reg_means</span> <span class="o">-</span> <span class="n">reg_alt_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">reg_alt_vars</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">reg_alt_vars</span><span class="p">)))</span> <span class="o">-</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reg_means</span> <span class="o">-</span> <span class="n">reg_ref_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">reg_ref_vars</span><span class="p">)</span> <span class="o">+</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">reg_ref_vars</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">trim_seq_and_means</span><span class="p">(</span>
        <span class="n">seq</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">r_start</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_end</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span>
        <span class="n">kmer_width</span><span class="p">,</span> <span class="n">central_pos</span><span class="p">,</span> <span class="n">max_motif_bb</span><span class="p">,</span> <span class="n">max_motif_ab</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return trimmed arrays to the genomic region specified.</span>

<span class="sd">    Args:</span>
<span class="sd">       seq: read genomic sequence (read-centric for rev strand)</span>
<span class="sd">       means: read base level means</span>
<span class="sd">       r_start: genomic start position</span>
<span class="sd">       reg_start: genomic region start</span>
<span class="sd">       reg_end: genomic region end</span>
<span class="sd">       strand: read mapped strand</span>
<span class="sd">       kmer_width: standard and alt k-mer width</span>
<span class="sd">       central_pos: central position within standard k-mer</span>
<span class="sd">       max_motif_bb: maximum (over alt models) bases required upstream for</span>
<span class="sd">           motif search</span>
<span class="sd">       max_motif_ab: maximum (over alt models) bases required downstream for</span>
<span class="sd">           motif search</span>

<span class="sd">    Arrays are:</span>
<span class="sd">        1) read centric k-mers (for expected level lookup)</span>
<span class="sd">        2) read-centric k-mer model-able means</span>
<span class="sd">        3) genome-centric alt test-able start</span>
<span class="sd">        4) motif search seq</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r_end</span> <span class="o">=</span> <span class="n">r_start</span> <span class="o">+</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># save un-clipped motif search seq</span>
    <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="n">seq</span>

    <span class="c1"># clip read if it extends outside the current genomic region, so</span>
    <span class="c1"># stats are only computed within this region</span>
    <span class="n">num_start_clip</span><span class="p">,</span> <span class="n">num_end_clip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">r_start</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">reg_start</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">r_start</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">r_start</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">r_start</span> <span class="o">=</span> <span class="n">reg_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r_end</span> <span class="o">-</span> <span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">reg_end</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">num_end_clip</span> <span class="o">=</span> <span class="n">r_end</span> <span class="o">-</span> <span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">reg_end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_start_clip</span> <span class="o">=</span> <span class="n">r_end</span> <span class="o">-</span> <span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">reg_end</span>

    <span class="c1"># clip sequence to that required for expected level lookups</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">num_start_clip</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">num_end_clip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[:</span><span class="o">-</span><span class="n">num_end_clip</span><span class="p">]</span>

    <span class="c1"># clip extra bits from means to test-able means</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">num_start_clip</span> <span class="o">+</span> <span class="n">central_pos</span><span class="p">:]</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">means</span><span class="p">[:</span><span class="o">-</span><span class="p">(</span><span class="n">num_end_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="n">central_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># if this read does not cover enough of this region for stat</span>
    <span class="c1"># alternate stat computation raise an error to be handled below</span>
    <span class="k">if</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kmer_width</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Read sequence too short in this region.&#39;</span><span class="p">)</span>

    <span class="n">kmers</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_kmers</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">kmer_width</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kmers</span><span class="p">)</span> <span class="o">!=</span> <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Mismatching k-mer and mean levels.&#39;</span><span class="p">)</span>

    <span class="c1"># shift r_start to first alt test-able position</span>
    <span class="n">r_start</span> <span class="o">+=</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># clip and/or pad sequence for motif searching</span>
    <span class="k">if</span> <span class="n">num_start_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_bb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="n">motif_search_seq</span><span class="p">[</span>
            <span class="n">num_start_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_bb</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span> <span class="o">*</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">num_start_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_bb</span><span class="p">)</span> <span class="o">+</span> <span class="n">motif_search_seq</span>
    <span class="k">if</span> <span class="n">num_end_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_ab</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="n">motif_search_seq</span><span class="p">[</span>
            <span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">num_end_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_ab</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="n">motif_search_seq</span> <span class="o">+</span> <span class="s1">&#39;N&#39;</span> <span class="o">*</span> <span class="o">-</span><span class="p">(</span>
            <span class="n">num_end_clip</span> <span class="o">+</span> <span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">max_motif_ab</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motif_search_seq</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_motif_bb</span> <span class="o">-</span> <span class="n">max_motif_bb</span> <span class="o">!=</span>
        <span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">kmer_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)):</span>
        <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Motif search sequence not correct length.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kmers</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">r_start</span><span class="p">,</span> <span class="n">motif_search_seq</span>

<span class="k">def</span> <span class="nf">compute_alt_model_read_stats</span><span class="p">(</span>
        <span class="n">r_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="p">,</span> <span class="n">use_standard_llhr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute signficance statistics using comparison of read signal to</span>
<span class="sd">    canonical and alternative models method for a single read within a</span>
<span class="sd">    specified genomic region.</span>

<span class="sd">    Args:</span>
<span class="sd">        r_data (:class:`tombo.tombo_helper.readData`): read data</span>
<span class="sd">        std_ref (:class:`tombo.tombo_stats.TomboModel`): canonical expected</span>
<span class="sd">            signal level model</span>
<span class="sd">        alt_refs (list of :class:`tombo.tombo_stats.AltModel`): alternative</span>
<span class="sd">            expected signal level models</span>
<span class="sd">        use_standard_llhr (bool): compute standard likelihood ratio; for details</span>
<span class="sd">            see https://nanoporetech.github.io/tombo/modified_base_detection.html#alternative-model-method</span>
<span class="sd">            (optional; default: False)</span>
<span class="sd">        reg_data (:class:`tombo.tombo_helper.intervalData`): region to test</span>
<span class="sd">            (default: test whole read)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Read testing results, positions tested and the read_id</span>

<span class="sd">        1) r_llhrs (`np.array::np.float64`): log-likelihood ratios (or psuedo-llhrs) for testing over specified region</span>
<span class="sd">        2) r_poss (`np.array::np.int64`): genomic positions for returned p-values</span>
<span class="sd">        3) read_id (str): read identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reg_start</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span>
    <span class="n">reg_end</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="k">if</span> <span class="n">reg_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">r_data</span><span class="o">.</span><span class="n">end</span>

    <span class="c1"># number of sequence positions to keep in order to look up both motif hits</span>
    <span class="c1"># and expected levels</span>
    <span class="n">max_motif_bb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span>
        <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">alt_ref</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="p">])</span>
    <span class="n">max_motif_ab</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span>
        <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">alt_ref</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">alt_clip_and_flip</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Get read information in order to test requested region of this read</span>

<span class="sd">        base means, seq, k-mers, genomic start and read id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">r_data</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fast5_data</span><span class="p">:</span>
            <span class="n">r_means</span><span class="p">,</span> <span class="n">r_seq</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_multiple_slots_read_centric</span><span class="p">(</span>
                <span class="n">fast5_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">],</span> <span class="n">r_data</span><span class="o">.</span><span class="n">corr_group</span><span class="p">)</span>
            <span class="n">read_id</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_raw_read_slot</span><span class="p">(</span><span class="n">fast5_data</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_means</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                <span class="s1">&#39;Read does not contain valid re-squiggled data.&#39;</span><span class="p">)</span>
        <span class="n">r_seq</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_seq</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">r_kmers</span><span class="p">,</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">r_start</span><span class="p">,</span> <span class="n">motif_search_seq</span> <span class="o">=</span> <span class="n">trim_seq_and_means</span><span class="p">(</span>
            <span class="n">r_seq</span><span class="p">,</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_start</span><span class="p">,</span> <span class="n">reg_end</span><span class="p">,</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span>
            <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">central_pos</span><span class="p">,</span> <span class="n">max_motif_bb</span><span class="p">,</span> <span class="n">max_motif_ab</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r_kmers</span><span class="p">,</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">motif_search_seq</span><span class="p">,</span> <span class="n">r_start</span><span class="p">,</span> <span class="n">read_id</span>


    <span class="n">r_kmers</span><span class="p">,</span> <span class="n">r_means</span><span class="p">,</span> <span class="n">motif_search_seq</span><span class="p">,</span> <span class="n">r_start</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">alt_clip_and_flip</span><span class="p">()</span>
    <span class="n">testable_len</span> <span class="o">=</span> <span class="n">r_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">r_ref_means</span><span class="p">,</span> <span class="n">r_ref_sds</span> <span class="o">=</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_kmers</span><span class="p">(</span><span class="n">r_kmers</span><span class="p">)</span>
    <span class="n">r_ref_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">r_ref_sds</span><span class="p">)</span>

    <span class="n">all_poss</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_llhrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alt_ref</span> <span class="ow">in</span> <span class="n">alt_refs</span><span class="p">:</span>
        <span class="n">alt_base_poss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_lh_ratios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># note search space is clipped since all k-mers covering the position</span>
        <span class="c1"># of interest must be valid</span>
        <span class="n">alt_i_motif_search_seq</span> <span class="o">=</span> <span class="n">motif_search_seq</span><span class="p">[</span>
            <span class="n">max_motif_bb</span> <span class="o">-</span> <span class="p">(</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):]</span>
        <span class="k">if</span> <span class="n">max_motif_ab</span> <span class="o">-</span> <span class="p">(</span><span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alt_i_motif_search_seq</span> <span class="o">=</span> <span class="n">alt_i_motif_search_seq</span><span class="p">[</span>
                <span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">max_motif_ab</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_len</span> <span class="o">-</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">mod_pos</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">alt_m</span> <span class="ow">in</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">motif</span><span class="o">.</span><span class="n">motif_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">alt_i_motif_search_seq</span><span class="p">):</span>
            <span class="n">alt_pos</span> <span class="o">=</span> <span class="n">alt_m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r_data</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">alt_base_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_start</span> <span class="o">+</span> <span class="n">alt_pos</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alt_base_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_start</span> <span class="o">+</span> <span class="n">testable_len</span> <span class="o">-</span> <span class="n">alt_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">r_pos_alt_means</span><span class="p">,</span> <span class="n">r_pos_alt_sds</span> <span class="o">=</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">get_exp_levels_from_kmers</span><span class="p">(</span>
                <span class="n">r_kmers</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">alt_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">])</span>
            <span class="n">pos_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_means</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">],</span>
                        <span class="n">r_ref_means</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">],</span>
                        <span class="n">r_pos_alt_means</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">CONST_SD_MODEL</span><span class="p">:</span>
                <span class="n">const_var</span> <span class="o">=</span> <span class="n">r_ref_vars</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">use_standard_llhr</span><span class="p">:</span>
                    <span class="n">pos_lh_ratio</span> <span class="o">=</span> <span class="n">c_calc_llh_ratio_const_var</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">(</span><span class="n">pos_args</span> <span class="o">+</span> <span class="n">const_var</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pos_lh_ratio</span> <span class="o">=</span> <span class="n">c_calc_scaled_llh_ratio_const_var</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">(</span><span class="n">pos_args</span> <span class="o">+</span> <span class="p">[</span><span class="n">const_var</span><span class="p">,</span> <span class="n">OCLLHR_SCALE</span><span class="p">,</span>
                                      <span class="n">OCLLHR_HEIGHT</span><span class="p">,</span> <span class="n">OCLLHR_POWER</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_standard_llhr</span><span class="p">:</span>
                    <span class="n">pos_lh_ratio</span> <span class="o">=</span> <span class="n">c_calc_llh_ratio</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">(</span><span class="n">pos_args</span> <span class="o">+</span> <span class="p">[</span>
                            <span class="n">r_ref_vars</span><span class="p">[</span><span class="n">alt_pos</span><span class="p">:</span><span class="n">alt_pos</span> <span class="o">+</span> <span class="n">std_ref</span><span class="o">.</span><span class="n">kmer_width</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">r_pos_alt_sds</span><span class="p">)]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span>
                        <span class="s1">&#39;Variable SD scaled likelihood ratio not implemented.&#39;</span><span class="p">)</span>
            <span class="n">log_lh_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_lh_ratio</span><span class="p">)</span>

        <span class="n">all_llhrs</span><span class="p">[</span><span class="n">alt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">log_lh_ratios</span><span class="p">)</span>
        <span class="n">all_poss</span><span class="p">[</span><span class="n">alt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alt_base_poss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_llhrs</span><span class="p">,</span> <span class="n">all_poss</span><span class="p">,</span> <span class="n">read_id</span>

<span class="k">def</span> <span class="nf">apply_per_read_thresh</span><span class="p">(</span>
        <span class="n">reg_base_stats</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
        <span class="n">stat_locs</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">reg_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">lower_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># filter base statistics that fall between the upper and lower</span>
        <span class="c1"># stat threshold for the log likelihood statistic</span>
        <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">base_stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">base_stats</span> <span class="o">&lt;=</span> <span class="n">lower_thresh</span><span class="p">,</span>
                                     <span class="n">base_stats</span> <span class="o">&gt;=</span> <span class="n">single_read_thresh</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">]</span>
        <span class="n">valid_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
        <span class="c1"># filter base statistics that fall between the upper and lower</span>
        <span class="c1"># stat threshold for the log likelihood statistic</span>
        <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">base_stats</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">single_read_thresh</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">]</span>
        <span class="n">valid_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_cov</span> <span class="o">=</span> <span class="n">reg_cov</span>

    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctrl_cov</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">ctrl_cov</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">stat_locs</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># convert to list since python2 repeat objects can&#39;t be pickled</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stat_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">reg_frac_std_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span>
            <span class="n">base_stats</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">base_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
        <span class="k">for</span> <span class="n">base_stats</span> <span class="ow">in</span> <span class="n">reg_base_stats</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">reg_frac_std_base</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span>

<span class="k">def</span> <span class="nf">collate_reg_stats</span><span class="p">(</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">stat_locs</span><span class="p">,</span> <span class="n">read_ids</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span>
        <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">stat_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stat_locs</span><span class="p">)</span>
    <span class="c1"># remove nans possibly introduced by fisher&#39;s method calculcations</span>
    <span class="n">valid_poss</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">stat_locs</span> <span class="o">=</span> <span class="n">stat_locs</span><span class="p">[</span><span class="n">valid_poss</span><span class="p">]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">valid_poss</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">stat_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">stat_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">per_read_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valid_read_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">rep_r_id</span> <span class="k">for</span> <span class="n">rep_r_id</span><span class="p">,</span> <span class="n">is_valid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="n">rep_r_id</span> <span class="k">for</span> <span class="n">r_id</span><span class="p">,</span> <span class="n">r_len</span> <span class="ow">in</span> <span class="n">read_ids</span>
                 <span class="k">for</span> <span class="n">rep_r_id</span> <span class="ow">in</span> <span class="n">repeat</span><span class="p">(</span><span class="n">r_id</span><span class="p">,</span> <span class="n">r_len</span><span class="p">)],</span> <span class="n">valid_poss</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_valid</span><span class="p">]</span>
        <span class="n">read_id_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span>
            <span class="p">(</span><span class="n">read_id</span><span class="p">,</span> <span class="n">read_id_val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">read_id_val</span><span class="p">,</span> <span class="n">read_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">valid_read_ids</span><span class="p">))))</span>
        <span class="n">conv_read_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">read_id_lookup</span><span class="p">[</span><span class="n">r_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">r_id</span> <span class="ow">in</span> <span class="n">valid_read_ids</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">conv_read_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stat_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">per_read_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stat_locs</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">conv_read_ids</span><span class="p">)),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;read_id&#39;</span><span class="p">),</span> <span class="s1">&#39;u4&#39;</span><span class="p">)])</span>
        <span class="n">per_read_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span>
            <span class="n">stat_name</span><span class="p">,</span> <span class="p">(</span><span class="n">per_read_block</span><span class="p">,</span> <span class="n">read_id_lookup</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span>
                        <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">)))</span>

    <span class="c1"># get order of all bases from position array</span>
    <span class="n">as_stat_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">stat_locs</span><span class="p">)</span>
    <span class="c1"># sort all positions from all reads</span>
    <span class="n">stat_locs</span> <span class="o">=</span> <span class="n">stat_locs</span><span class="p">[</span><span class="n">as_stat_locs</span><span class="p">]</span>
    <span class="c1"># get unique tested genomic positions across all reads</span>
    <span class="n">us_stat_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stat_locs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stat_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;No valid positions in this region.&#39;</span><span class="p">)</span>

    <span class="c1"># then sort the stats array by genomic position and</span>
    <span class="c1"># split into stats by genomic base position</span>
    <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">as_stat_locs</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stat_locs</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">reg_frac_std_base</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span> <span class="o">=</span> <span class="n">apply_per_read_thresh</span><span class="p">(</span>
        <span class="n">reg_base_stats</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span>
        <span class="n">stat_type</span><span class="p">,</span> <span class="n">stat_locs</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">th</span><span class="o">.</span><span class="n">regionStats</span><span class="p">(</span>
        <span class="n">reg_frac_std_base</span><span class="p">,</span> <span class="n">us_stat_locs</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span>
        <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_reg_stats</span><span class="p">(</span>
        <span class="n">reg_data</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span>
        <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span>
        <span class="n">alt_refs</span><span class="p">,</span> <span class="n">use_standard_llhr</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">prior_weights</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
        <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="n">get_reads_ref</span><span class="p">(</span>
            <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">prior_weights</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO get region sequence and expected levels/sds here</span>
        <span class="c1"># instead of for each read</span>
        <span class="c1"># after that add per-read stat computation to API</span>
        <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># store multiple alt references lists (default to stat_type for de novo or</span>
    <span class="c1"># sample comp testing)</span>
    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat_type</span><span class="p">,]</span> <span class="k">if</span> <span class="n">stat_type</span> <span class="o">!=</span> <span class="n">ALT_MODEL_TXT</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alt_refs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reg_read_stats</span><span class="p">,</span> <span class="n">stat_locs</span><span class="p">,</span> <span class="n">reg_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">((</span><span class="n">stat_name</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">stat_name</span> <span class="ow">in</span> <span class="n">stat_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">r_data</span> <span class="ow">in</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">SAMP_COMP_TXT</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_sample_compare_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">ctrl_means</span><span class="p">,</span> <span class="n">ctrl_sds</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">DE_NOVO_TXT</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_de_novo_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_stats</span><span class="p">,</span> <span class="n">r_poss</span><span class="p">,</span> <span class="n">read_id</span> <span class="o">=</span> <span class="n">compute_alt_model_read_stats</span><span class="p">(</span>
                    <span class="n">r_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="p">,</span> <span class="n">use_standard_llhr</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_r_stats</span> <span class="ow">in</span> <span class="n">r_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">reg_read_stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_r_stats</span><span class="p">)</span>
            <span class="n">reg_ids</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">read_id</span><span class="p">,</span> <span class="n">stat_r_stats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">stat_locs</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_poss</span><span class="p">[</span><span class="n">stat_name</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stat_reg_read_stats</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">stat_reg_read_stats</span> <span class="ow">in</span> <span class="n">reg_read_stats</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Reads contains no statistics in this region.&#39;</span><span class="p">)</span>

    <span class="n">reg_stats</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">stat_name</span><span class="p">,</span> <span class="n">collate_reg_stats</span><span class="p">(</span>
            <span class="n">stat_name_stats</span><span class="p">,</span> <span class="n">stat_locs</span><span class="p">[</span><span class="n">stat_name</span><span class="p">],</span> <span class="n">reg_ids</span><span class="p">[</span><span class="n">stat_name</span><span class="p">],</span>
            <span class="n">per_read_q</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
            <span class="n">stat_name</span><span class="p">,</span>  <span class="n">ctrl_cov</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">stat_name</span><span class="p">,</span> <span class="n">stat_name_stats</span> <span class="ow">in</span> <span class="n">reg_read_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">reg_stats</span>


<span class="c1">###################################</span>
<span class="c1">########## Level Testing ##########</span>
<span class="c1">###################################</span>

<span class="k">def</span> <span class="nf">compute_ks_tests</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">,</span> <span class="n">return_stat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute_pos_ks_test</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute effect size statistic or p-value of two-sample</span>
<span class="sd">        Kolmogorov-Smirnov test</span>

<span class="sd">        Using definition from</span>
<span class="sd">        https://github.com/scipy/scipy/blob/v0.14.0/scipy/stats/stats.py#L3886</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samp_n</span><span class="p">,</span> <span class="n">ctrl_n</span> <span class="o">=</span> <span class="n">pos_samp_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_ctrl_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos_all_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">])</span>
        <span class="n">samp_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span>
            <span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_all_levels</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">samp_n</span>
        <span class="n">ctrl_cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span>
            <span class="n">pos_ctrl_levels</span><span class="p">,</span> <span class="n">pos_all_levels</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">ctrl_n</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">samp_cdf</span> <span class="o">-</span> <span class="n">ctrl_cdf</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">return_stat</span><span class="p">:</span>
            <span class="c1"># subtract 1 so most significant are smallest values</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span>
        <span class="n">en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">samp_n</span> <span class="o">*</span> <span class="n">ctrl_n</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">samp_n</span> <span class="o">+</span> <span class="n">ctrl_n</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">kstwobign</span><span class="o">.</span><span class="n">sf</span><span class="p">((</span><span class="n">en</span> <span class="o">+</span> <span class="mf">0.12</span> <span class="o">+</span> <span class="mf">0.11</span> <span class="o">/</span> <span class="n">en</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>


    <span class="n">samp_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">))</span>
    <span class="n">ctrl_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ctrl_base_levels</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_pos_ks_test</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">[</span><span class="n">samp_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_ctrl_levels</span><span class="p">[</span><span class="n">ctrl_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                             <span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">))])</span>

<span class="k">def</span> <span class="nf">compute_u_tests</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">,</span> <span class="n">return_stat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute_pos_u_test</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute effect size statistic or p-value of two-sample u-test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samp_n</span><span class="p">,</span> <span class="n">ctrl_n</span> <span class="o">=</span> <span class="n">pos_samp_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_ctrl_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tot_comps</span> <span class="o">=</span> <span class="n">samp_n</span> <span class="o">*</span> <span class="n">ctrl_n</span>
        <span class="n">pos_all_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">])</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">samp_n</span> <span class="o">+</span> <span class="n">ctrl_n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">ranks</span><span class="p">[</span><span class="n">pos_all_levels</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">samp_n</span> <span class="o">+</span> <span class="n">ctrl_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">samp_ranks_sum</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[:</span><span class="n">samp_n</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1">#ctrl_ranks_sum = ranks[samp_n:].sum()</span>

        <span class="n">u1</span> <span class="o">=</span> <span class="n">samp_ranks_sum</span> <span class="o">-</span> <span class="p">(</span><span class="n">samp_n</span> <span class="o">*</span> <span class="p">(</span><span class="n">samp_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1">#u2 = ctrl_ranks_sum - (ctrl_n * (ctrl_n + 1)) / 2</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">tot_comps</span> <span class="o">-</span> <span class="n">u1</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">tot_comps</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">return_stat</span><span class="p">:</span>
            <span class="c1"># this will be negative (flip sign for stat transform)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">mu</span>

        <span class="n">rhou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_comps</span> <span class="o">*</span> <span class="p">(</span><span class="n">tot_comps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">rhou</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>


    <span class="n">samp_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">))</span>
    <span class="n">ctrl_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ctrl_base_levels</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_pos_u_test</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">[</span><span class="n">samp_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_ctrl_levels</span><span class="p">[</span><span class="n">ctrl_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                             <span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">))])</span>

<span class="k">def</span> <span class="nf">compute_t_tests</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">,</span> <span class="n">return_stat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute_pos_t_test</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute effect size statistic or p-value of two-sample t-test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samp_n</span><span class="p">,</span> <span class="n">ctrl_n</span> <span class="o">=</span> <span class="n">pos_samp_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos_ctrl_levels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tot_comps</span> <span class="o">=</span> <span class="n">samp_n</span> <span class="o">*</span> <span class="n">ctrl_n</span>

        <span class="n">samp_mean</span><span class="p">,</span> <span class="n">samp_sd</span> <span class="o">=</span> <span class="n">c_mean_std</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">)</span>
        <span class="n">ctrl_mean</span><span class="p">,</span> <span class="n">ctrl_sd</span> <span class="o">=</span> <span class="n">c_mean_std</span><span class="p">(</span><span class="n">pos_ctrl_levels</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_stat</span><span class="p">:</span>
            <span class="c1"># this will be negative (flip sign for stat transform)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samp_mean</span> <span class="o">-</span> <span class="n">ctrl_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">((</span><span class="n">samp_sd</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ctrl_sd</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((((</span><span class="n">samp_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">samp_sd</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
                      <span class="p">(</span><span class="n">ctrl_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ctrl_sd</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
                     <span class="p">(</span><span class="n">samp_n</span> <span class="o">+</span> <span class="n">ctrl_n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samp_mean</span> <span class="o">-</span> <span class="n">ctrl_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">sp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">samp_n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ctrl_n</span><span class="p">)))</span>

        <span class="c1"># t dist with samp_n + ctrl_n - 2 d.o.f.</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">samp_n</span> <span class="o">+</span> <span class="n">ctrl_n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span>


    <span class="n">samp_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">))</span>
    <span class="n">ctrl_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ctrl_base_levels</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">compute_pos_t_test</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">[</span><span class="n">samp_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_ctrl_levels</span><span class="p">[</span><span class="n">ctrl_valid_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pos_samp_levels</span><span class="p">,</span> <span class="n">pos_ctrl_levels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                             <span class="n">samp_base_levels</span><span class="p">,</span> <span class="n">ctrl_base_levels</span><span class="p">))])</span>

<span class="k">def</span> <span class="nf">compute_group_reg_stats</span><span class="p">(</span>
        <span class="n">reg_data</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">):</span>
    <span class="n">samp_base_levels</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span><span class="o">.</span><span class="n">get_base_levels</span><span class="p">()</span>
    <span class="n">ctrl_base_levels</span> <span class="o">=</span> <span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">end</span><span class="o">=</span><span class="n">ctrl_reg_data</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">fm_offset</span><span class="p">)</span><span class="o">.</span><span class="n">get_base_levels</span><span class="p">()</span>

    <span class="c1"># get regions with coverage greater than min_test_reads</span>
    <span class="n">samp_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samp_base_levels</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ctrl_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ctrl_base_levels</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cov_regs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="kc">False</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">samp_cov</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">)),</span> <span class="p">[</span><span class="kc">False</span><span class="p">,]])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_regs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">reg_stats</span><span class="p">,</span> <span class="n">reg_poss</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">reg_ctrl_cov</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cov_start</span><span class="p">,</span> <span class="n">cov_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cov_regs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">cov_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">cov_end</span> <span class="o">-</span> <span class="n">cov_start</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fm_offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KS_TEST_TXT</span><span class="p">,</span> <span class="n">KS_STAT_TEST_TXT</span><span class="p">):</span>
            <span class="n">cov_reg_stats</span> <span class="o">=</span> <span class="n">compute_ks_tests</span><span class="p">(</span>
                <span class="n">samp_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">ctrl_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">stat_type</span> <span class="o">==</span> <span class="n">KS_STAT_TEST_TXT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">U_TEST_TXT</span><span class="p">,</span> <span class="n">U_STAT_TEST_TXT</span><span class="p">):</span>
            <span class="n">cov_reg_stats</span> <span class="o">=</span> <span class="n">compute_u_tests</span><span class="p">(</span>
                <span class="n">samp_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">ctrl_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">stat_type</span> <span class="o">==</span> <span class="n">U_STAT_TEST_TXT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_TEST_TXT</span><span class="p">,</span> <span class="n">T_STAT_TEST_TXT</span><span class="p">):</span>
            <span class="n">cov_reg_stats</span> <span class="o">=</span> <span class="n">compute_t_tests</span><span class="p">(</span>
                <span class="n">samp_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">ctrl_base_levels</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">],</span>
                <span class="n">stat_type</span> <span class="o">==</span> <span class="n">T_STAT_TEST_TXT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unrecognized test type.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fm_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KS_TEST_TXT</span><span class="p">,</span> <span class="n">U_TEST_TXT</span><span class="p">,</span> <span class="n">T_TEST_TXT</span><span class="p">):</span>
                <span class="n">cov_reg_stats</span> <span class="o">=</span> <span class="n">calc_window_fishers_method</span><span class="p">(</span>
                    <span class="n">cov_reg_stats</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov_reg_stats</span> <span class="o">=</span> <span class="n">calc_window_means</span><span class="p">(</span><span class="n">cov_reg_stats</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">)</span>
        <span class="n">reg_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov_reg_stats</span><span class="p">)</span>
        <span class="n">reg_poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">+</span> <span class="n">cov_start</span><span class="p">,</span>
                                  <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">fm_offset</span> <span class="o">+</span> <span class="n">cov_end</span><span class="p">))</span>
        <span class="n">reg_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samp_cov</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">])</span>
        <span class="n">reg_ctrl_cov</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctrl_cov</span><span class="p">[</span><span class="n">cov_start</span><span class="p">:</span><span class="n">cov_end</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">[(</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">groupStats</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">),</span>
        <span class="n">reg_data</span><span class="o">.</span><span class="n">chrm</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_cov</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reg_ctrl_cov</span><span class="p">))),]</span>


<span class="c1">##############################################</span>
<span class="c1">########## Testing Multi-processing ##########</span>
<span class="c1">##############################################</span>

<span class="k">def</span> <span class="nf">_test_signif_worker</span><span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">ctrl_reads_index</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="p">,</span> <span class="n">use_standard_llhr</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">prior_weights</span><span class="p">):</span>
    <span class="n">ctrl_reg_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reg_data</span> <span class="o">=</span> <span class="n">region_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># sometimes throws false empty error with get(block=False)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">region_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> <span class="k">continue</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">ctrl_reads_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctrl_reg_data</span> <span class="o">=</span> <span class="n">reg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">add_reads</span><span class="p">(</span><span class="n">ctrl_reads_index</span><span class="p">)</span>
        <span class="n">reg_data</span><span class="o">.</span><span class="n">add_reads</span><span class="p">(</span><span class="n">reads_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_data</span><span class="o">.</span><span class="n">reads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ALT_MODEL_TXT</span><span class="p">,</span> <span class="n">DE_NOVO_TXT</span><span class="p">,</span> <span class="n">SAMP_COMP_TXT</span><span class="p">):</span>
                <span class="n">stat_type_reg_stats</span> <span class="o">=</span> <span class="n">compute_reg_stats</span><span class="p">(</span>
                    <span class="n">reg_data</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span>
                    <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="p">,</span>
                    <span class="n">use_standard_llhr</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">prior_weights</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stat_type_reg_stats</span> <span class="o">=</span> <span class="n">compute_group_reg_stats</span><span class="p">(</span>
                    <span class="n">reg_data</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span>
                    <span class="n">stat_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">:</span>
            <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">stat_type_i_reg_stats</span> <span class="ow">in</span> <span class="n">stat_type_reg_stats</span><span class="p">:</span>
            <span class="n">stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">stat_type_i_reg_stats</span><span class="p">)</span>
        <span class="n">progress_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_SIGNIF</span><span class="p">:</span>
    <span class="n">_test_signif_wrapper</span> <span class="o">=</span> <span class="n">_test_signif_worker</span>
    <span class="k">def</span> <span class="nf">_test_signif_worker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_test_signif_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_signif.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">_get_stats_queue</span><span class="p">(</span>
        <span class="n">stats_q</span><span class="p">,</span> <span class="n">stats_conn</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">stats_file_bn</span><span class="p">,</span>
        <span class="n">stat_type</span><span class="p">,</span> <span class="n">alt_names</span><span class="p">,</span> <span class="n">reg_size</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">):</span>
    <span class="c1"># multiple files with alt_names</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">:</span>
            <span class="n">all_stats</span><span class="p">[</span><span class="n">alt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelStats</span><span class="p">(</span>
                <span class="n">stats_file_bn</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39;.tombo.stats&#39;</span><span class="p">,</span>
                <span class="n">stat_type</span><span class="o">=</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="n">reg_size</span><span class="p">,</span>
                <span class="n">cov_damp_counts</span><span class="o">=</span><span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="o">=</span><span class="n">min_test_reads</span><span class="p">,</span>
                <span class="n">num_most_signif</span><span class="o">=</span><span class="n">num_most_signif</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">DE_NOVO_TXT</span><span class="p">,</span> <span class="n">SAMP_COMP_TXT</span><span class="p">):</span>
        <span class="n">all_stats</span><span class="p">[</span><span class="n">stat_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelStats</span><span class="p">(</span>
            <span class="n">stats_file_bn</span> <span class="o">+</span> <span class="s1">&#39;.tombo.stats&#39;</span><span class="p">,</span>
            <span class="n">stat_type</span><span class="o">=</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="n">reg_size</span><span class="p">,</span>
            <span class="n">cov_damp_counts</span><span class="o">=</span><span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="o">=</span><span class="n">min_test_reads</span><span class="p">,</span>
            <span class="n">num_most_signif</span><span class="o">=</span><span class="n">num_most_signif</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_stats</span><span class="p">[</span><span class="n">stat_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">LevelStats</span><span class="p">(</span>
            <span class="n">stats_file_bn</span> <span class="o">+</span> <span class="s1">&#39;.tombo.stats&#39;</span><span class="p">,</span>
            <span class="n">stat_type</span><span class="o">=</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="n">reg_size</span><span class="p">,</span>
            <span class="n">cov_thresh</span><span class="o">=</span><span class="n">min_test_reads</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="o">=</span><span class="n">num_most_signif</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stat_name</span><span class="p">,</span> <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">all_stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">_write_stat_block</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="c1"># wait for main process to send indicator that all regions</span>
            <span class="c1"># have been processed</span>
            <span class="k">if</span> <span class="n">stats_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="c1"># Clear leftover values from queues</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">stat_name</span><span class="p">,</span> <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">_write_stat_block</span><span class="p">(</span><span class="n">reg_stats</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">stat_name_all_stats</span> <span class="ow">in</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">stat_name_all_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">stats_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_SIGNIF_STATS_OUT</span><span class="p">:</span>
    <span class="n">_get_stats_queue_wrapper</span> <span class="o">=</span> <span class="n">_get_stats_queue</span>
    <span class="k">def</span> <span class="nf">_get_stats_queue</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span><span class="s1">&#39;_get_stats_queue_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_signif_stats_out.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">_get_per_read_queue</span><span class="p">(</span>
        <span class="n">per_read_q</span><span class="p">,</span> <span class="n">per_read_conn</span><span class="p">,</span> <span class="n">per_read_bn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">alt_names</span><span class="p">,</span>
        <span class="n">region_size</span><span class="p">):</span>
    <span class="n">per_read_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">stat_type</span> <span class="o">==</span> <span class="n">ALT_MODEL_TXT</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">alt_name</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">:</span>
            <span class="n">per_read_stats</span><span class="p">[</span><span class="n">alt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">PerReadStats</span><span class="p">(</span>
                <span class="n">per_read_bn</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">alt_name</span> <span class="o">+</span> <span class="s1">&#39;.tombo.per_read_stats&#39;</span><span class="p">,</span>
                <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">per_read_stats</span><span class="p">[</span><span class="n">stat_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">PerReadStats</span><span class="p">(</span>
                <span class="n">per_read_bn</span> <span class="o">+</span> <span class="s1">&#39;.tombo.per_read_stats&#39;</span><span class="p">,</span>
                <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stat_name</span><span class="p">,</span> <span class="n">per_read_block</span> <span class="o">=</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">per_read_stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">_write_per_read_block</span><span class="p">(</span><span class="o">*</span><span class="n">per_read_block</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">per_read_block</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">per_read_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="c1"># Clear leftover values from queues</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">stat_name</span><span class="p">,</span> <span class="n">per_read_block</span> <span class="o">=</span> <span class="n">per_read_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">per_read_stats</span><span class="p">[</span><span class="n">stat_name</span><span class="p">]</span><span class="o">.</span><span class="n">_write_per_read_block</span><span class="p">(</span><span class="o">*</span><span class="n">per_read_block</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">per_read_block</span>
    <span class="k">for</span> <span class="n">stat_name_per_read_stats</span> <span class="ow">in</span> <span class="n">per_read_stats</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">stat_name_per_read_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># indicate that the process has closed</span>
    <span class="n">per_read_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">if</span> <span class="n">_PROFILE_SIGNIF_PER_READ</span><span class="p">:</span>
    <span class="n">_get_per_read_queue_wrapper</span> <span class="o">=</span> <span class="n">_get_per_read_queue</span>
    <span class="k">def</span> <span class="nf">_get_per_read_queue</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cProfile</span>
        <span class="n">cProfile</span><span class="o">.</span><span class="n">runctx</span><span class="p">(</span>
            <span class="s1">&#39;_get_per_read_queue_wrapper(*args)&#39;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;test_signif_per_read.prof&#39;</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">_get_progress_queue</span><span class="p">(</span><span class="n">progress_q</span><span class="p">,</span> <span class="n">prog_conn</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">):</span>
    <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
        <span class="s1">&#39;Performing modified base detection across genomic regions.&#39;</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tot_num_rec_proc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iter_val</span> <span class="o">=</span> <span class="n">progress_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tot_num_rec_proc</span> <span class="o">+=</span> <span class="n">iter_val</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_val</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prog_conn</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">prog_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tot_num_rec_proc</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">test_significance</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">stats_file_bn</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span>
        <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">,</span> <span class="n">per_read_bn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">single_read_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fm_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctrl_reads_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt_refs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_standard_llhr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prior_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test for significant shifted signal in mutliprocessed batches</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">region_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">stats_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">STAT_BLOCKS_QUEUE_LIMIT</span><span class="p">)</span>
    <span class="n">progress_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">per_read_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">STAT_BLOCKS_QUEUE_LIMIT</span><span class="p">)</span> \
                 <span class="k">if</span> <span class="n">per_read_bn</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="c1"># split chromosomes into separate regions to process independently</span>
    <span class="n">num_regions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO add min coverage when adding ctrl coverage (instead of adding</span>
    <span class="c1"># as is done currently)</span>
    <span class="k">for</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">reg_start</span> <span class="ow">in</span> <span class="n">reads_index</span><span class="o">.</span><span class="n">iter_cov_regs</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">ctrl_reads_index</span><span class="p">):</span>
        <span class="n">region_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">intervalData</span><span class="p">(</span>
            <span class="n">chrm</span><span class="o">=</span><span class="n">chrm</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">reg_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">reg_start</span> <span class="o">+</span> <span class="n">region_size</span><span class="p">,</span>
            <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">))</span>
        <span class="n">num_regions</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># wait for queue items to register in queue and avoid queue appearing empty</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">test_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">region_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">progress_q</span><span class="p">,</span> <span class="n">per_read_q</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">,</span> <span class="n">fm_offset</span><span class="p">,</span>
        <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">ctrl_reads_index</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="p">,</span> <span class="n">use_standard_llhr</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">prior_weights</span><span class="p">)</span>
    <span class="n">test_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_test_signif_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">test_args</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">test_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># start queue getter processes</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">main_prog_conn</span><span class="p">,</span> <span class="n">prog_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
        <span class="n">prog_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_get_progress_queue</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">progress_q</span><span class="p">,</span> <span class="n">prog_conn</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
        <span class="n">prog_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">prog_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># main region stats queue getter</span>
    <span class="n">alt_names</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">alt_refs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alt_refs</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">main_stats_conn</span><span class="p">,</span> <span class="n">stats_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
    <span class="n">stats_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_get_stats_queue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">stats_q</span><span class="p">,</span> <span class="n">stats_conn</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">stats_file_bn</span><span class="p">,</span>
        <span class="n">stat_type</span><span class="p">,</span> <span class="n">alt_names</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="p">,</span>
        <span class="n">num_most_signif</span><span class="p">))</span>
    <span class="n">stats_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">stats_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># per-read stats queue getter</span>
    <span class="k">if</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_per_read_conn</span><span class="p">,</span> <span class="n">per_read_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
        <span class="n">per_read_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">_get_per_read_queue</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">per_read_q</span><span class="p">,</span> <span class="n">per_read_conn</span><span class="p">,</span> <span class="n">per_read_bn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span>
                  <span class="n">alt_names</span><span class="p">,</span> <span class="n">region_size</span><span class="p">))</span>
        <span class="n">per_read_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">per_read_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait for test processes to finish</span>
    <span class="k">for</span> <span class="n">test_p</span> <span class="ow">in</span> <span class="n">test_ps</span><span class="p">:</span>
        <span class="n">test_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># in a very unlikely case the progress queue could die while the</span>
    <span class="c1"># main process remains active and thus we would have a deadlock here</span>
    <span class="k">if</span> <span class="n">VERBOSE</span> <span class="ow">and</span> <span class="n">prog_p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
        <span class="c1"># send signal to getter queue to finish and return results</span>
        <span class="n">main_prog_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># returns total number of processed reads if that is needed</span>
        <span class="n">main_prog_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">per_read_bn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">main_per_read_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">main_per_read_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

    <span class="n">main_stats_conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">main_stats_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

    <span class="k">return</span>


<span class="c1">################################################</span>
<span class="c1">########## Aggregate Multi-processing ##########</span>
<span class="c1">################################################</span>

<span class="k">def</span> <span class="nf">_write_stats</span><span class="p">(</span>
        <span class="n">stats_q</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="p">,</span>
        <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">all_stats</span> <span class="o">=</span> <span class="n">ModelStats</span><span class="p">(</span>
        <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="o">=</span><span class="n">region_size</span><span class="p">,</span>
        <span class="n">cov_damp_counts</span><span class="o">=</span><span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">cov_thresh</span><span class="o">=</span><span class="n">min_test_reads</span><span class="p">,</span>
        <span class="n">num_most_signif</span><span class="o">=</span><span class="n">num_most_signif</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_blocks</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">num_agg_ps_finished</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">agg_stats</span> <span class="o">=</span> <span class="n">stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">agg_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_agg_ps_finished</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">num_agg_ps_finished</span> <span class="o">&gt;=</span> <span class="n">num_processes</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">((</span><span class="n">reg_frac_std_base</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">),</span>
             <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">us_reg_poss</span><span class="p">)</span> <span class="o">=</span> <span class="n">agg_stats</span>
            <span class="n">all_stats</span><span class="o">.</span><span class="n">_write_stat_block</span><span class="p">(</span>
                <span class="n">th</span><span class="o">.</span><span class="n">regionStats</span><span class="p">(</span><span class="n">reg_frac_std_base</span><span class="p">,</span> <span class="n">us_reg_poss</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span>
                               <span class="n">start</span><span class="p">,</span> <span class="n">reg_cov</span><span class="p">,</span> <span class="n">ctrl_cov</span><span class="p">,</span> <span class="n">valid_cov</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">all_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No genomic positions contain --minimum-test-reads.&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_agg_stats_worker</span><span class="p">(</span>
        <span class="n">pr_stats_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_pr_stats</span> <span class="o">=</span> <span class="n">pr_stats_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># None value indicates that per-reads blocks have been exhausted</span>
            <span class="k">if</span> <span class="n">block_pr_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">block_stats</span> <span class="o">=</span> <span class="n">block_pr_stats</span>

            <span class="n">block_stats</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">))</span>
            <span class="n">reg_poss</span> <span class="o">=</span> <span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">us_reg_poss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)</span>

            <span class="n">reg_base_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">block_stats</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[[</span><span class="mi">0</span><span class="p">,],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">reg_poss</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">reg_stats</span> <span class="o">=</span> <span class="n">apply_per_read_thresh</span><span class="p">(</span>
                 <span class="n">reg_base_stats</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span>
                 <span class="n">stat_type</span><span class="p">,</span> <span class="n">reg_poss</span><span class="p">)</span>
            <span class="n">stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">reg_stats</span><span class="p">,</span> <span class="n">chrm</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">us_reg_poss</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_load_stats_batches</span><span class="p">(</span><span class="n">pr_stats_fn</span><span class="p">,</span> <span class="n">pr_stats_q</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="n">pr_stats</span> <span class="o">=</span> <span class="n">PerReadStats</span><span class="p">(</span><span class="n">pr_stats_fn</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pr_block</span> <span class="ow">in</span> <span class="n">pr_stats</span><span class="p">:</span>
        <span class="n">pr_stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pr_block</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">pr_stats_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">aggregate_per_read_stats</span><span class="p">(</span>
        <span class="n">pr_stats_fn</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span>
        <span class="n">cov_damp_counts</span><span class="p">,</span> <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Loading and aggregating per-read statistics.&#39;</span><span class="p">)</span>

    <span class="c1"># pre-load per-read stats queue</span>
    <span class="n">pr_stats</span> <span class="o">=</span> <span class="n">PerReadStats</span><span class="p">(</span><span class="n">pr_stats_fn</span><span class="p">)</span>
    <span class="n">stat_type</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">region_size</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pr_stats</span><span class="o">.</span><span class="n">stat_type</span><span class="p">,</span> <span class="n">pr_stats</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">,</span> <span class="n">pr_stats</span><span class="o">.</span><span class="n">region_size</span><span class="p">)</span>
    <span class="n">pr_stats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">pr_stats_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">STAT_BLOCKS_QUEUE_LIMIT</span><span class="p">)</span>
    <span class="n">stats_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">STAT_BLOCKS_QUEUE_LIMIT</span><span class="p">)</span>
    <span class="n">write_stats_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">STAT_BLOCKS_QUEUE_LIMIT</span><span class="p">)</span>

    <span class="n">load_stats_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_load_stats_batches</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">pr_stats_fn</span><span class="p">,</span> <span class="n">pr_stats_q</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">))</span>
    <span class="n">load_stats_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">load_stats_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">agg_stats_ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="n">agg_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_agg_stats_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
            <span class="n">pr_stats_q</span><span class="p">,</span> <span class="n">stats_q</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">))</span>
        <span class="n">agg_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">agg_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">agg_stats_ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg_p</span><span class="p">)</span>

    <span class="n">write_stats_p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_write_stats</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">stats_q</span><span class="p">,</span> <span class="n">stats_fn</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">region_size</span><span class="p">,</span> <span class="n">cov_damp_counts</span><span class="p">,</span>
        <span class="n">min_test_reads</span><span class="p">,</span> <span class="n">num_most_signif</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">))</span>
    <span class="n">write_stats_p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">write_stats_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># wait for processes to complete</span>
    <span class="n">load_stats_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">agg_p</span> <span class="ow">in</span> <span class="n">agg_stats_ps</span><span class="p">:</span>
        <span class="n">agg_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">write_stats_p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">return</span>


<span class="c1">##########################</span>
<span class="c1">##### Main Functions #####</span>
<span class="c1">##########################</span>

<span class="k">def</span> <span class="nf">_est_ref_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Context upstream and downstream must be greater &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;than 0 for model estimation.&#39;</span><span class="p">)</span>

    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">estimate_kmer_model</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_kmer_observations</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">kmer_specific_sd</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">coverage_threshold</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">estimate_mean</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
    <span class="n">std_ref</span><span class="o">.</span><span class="n">write_model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_est_alt_ref_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">estimate_alt_model</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">seq_sample_type</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_base</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alt_fraction_percentile</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_kmer_observations</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">save_density_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">kernel_density_bandwidth</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_density_filename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">control_density_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
    <span class="c1"># returns None when profiling method</span>
    <span class="k">if</span> <span class="n">alt_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_name</span>
    <span class="n">alt_ref</span><span class="o">.</span><span class="n">write_model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filename</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_est_motif_alt_ref_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="n">alt_ref</span> <span class="o">=</span> <span class="n">estimate_motif_alt_model</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">motif_description</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upstream_bases</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">downstream_bases</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">valid_locations_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_kmer_observations</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">coverage_threshold</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>
    <span class="n">alt_ref</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_name</span>
    <span class="n">alt_ref</span><span class="o">.</span><span class="n">write_model</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filename</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_estimate_scale_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Getting files list.&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Provided [fast5-basedir] is not a directory.&#39;</span><span class="p">)</span>
        <span class="n">fast5s_basedir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fast5s_basedir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">fast5_fns</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_files_list</span><span class="p">(</span><span class="n">fast5s_basedir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;Reads base directory, a sub-directory or an old (hidden) &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;index file does not appear to be accessible. Check &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;directory permissions.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
            <span class="s1">&#39;No files identified in the specified &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;directory or within immediate subdirectories.&#39;</span><span class="p">)</span>

    <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Global scaling estimate: &#39;</span> <span class="o">+</span>
                       <span class="n">unicode</span><span class="p">(</span><span class="n">estimate_global_scale</span><span class="p">(</span><span class="n">fast5_fns</span><span class="p">)))</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_de_novo_main</span><span class="p">(</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span>
        <span class="n">ref_fn</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
        <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>

    <span class="n">stat_type</span> <span class="o">=</span> <span class="n">DE_NOVO_TXT</span>
    <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">)</span> <span class="k">if</span> <span class="n">single_read_thresh</span>
        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DE_NOVO_THRESH</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Performing de novo model testing against canonical model.&#39;</span><span class="p">)</span>
    <span class="n">test_significance</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">num_most_significant_stored</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span>
        <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">coverage_dampen_counts</span><span class="p">,</span>
        <span class="n">fm_offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fishers_method_context</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">=</span><span class="n">std_ref</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_alt_main</span><span class="p">(</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="n">TomboModel</span><span class="p">(</span>
        <span class="n">ref_fn</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
        <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>

    <span class="n">stat_type</span> <span class="o">=</span> <span class="n">ALT_MODEL_TXT</span>
    <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">)</span> <span class="k">if</span> <span class="n">single_read_thresh</span>
        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">LLR_THRESH</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span><span class="s1">&#39;Performing alternative model testing.&#39;</span><span class="p">)</span>
    <span class="n">alt_refs</span> <span class="o">=</span> <span class="n">load_alt_refs</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filenames</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alternate_bases</span><span class="p">,</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_refs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;No alternative models successfully loaded.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Performing specific alternate base(s) testing.&#39;</span><span class="p">)</span>
    <span class="n">test_significance</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_most_significant_stored</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">coverage_dampen_counts</span><span class="p">,</span>
        <span class="n">std_ref</span><span class="o">=</span><span class="n">std_ref</span><span class="p">,</span> <span class="n">alt_refs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">alt_refs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
        <span class="n">use_standard_llhr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">standard_log_likelihood_ratio</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_model_samp_comp_main</span><span class="p">(</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">):</span>
    <span class="n">stat_type</span> <span class="o">=</span> <span class="n">SAMP_COMP_TXT</span>
    <span class="k">if</span> <span class="n">single_read_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">seq_samp_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">get_seq_sample_type</span><span class="p">(</span><span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>
        <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="n">SAMP_COMP_THRESH</span><span class="p">[</span><span class="n">seq_samp_type</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Performing two-sample comparison significance testing.&#39;</span><span class="p">)</span>
    <span class="n">ctrl_reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">control_fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="c1"># load expected levels ref for posterior computation</span>
    <span class="n">std_ref</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sample_only_estimates</span> <span class="k">else</span> <span class="n">TomboModel</span><span class="p">(</span>
        <span class="n">ref_fn</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tombo_model_filename</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="o">=</span><span class="n">seq_samp_type</span><span class="p">,</span>
        <span class="n">reads_index</span><span class="o">=</span><span class="n">reads_index</span><span class="p">)</span>

    <span class="n">test_significance</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">num_most_significant_stored</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_basename</span><span class="p">,</span>
        <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">coverage_dampen_counts</span><span class="p">,</span>
        <span class="n">fm_offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fishers_method_context</span><span class="p">,</span>
        <span class="n">ctrl_reads_index</span><span class="o">=</span><span class="n">ctrl_reads_index</span><span class="p">,</span> <span class="n">std_ref</span><span class="o">=</span><span class="n">std_ref</span><span class="p">,</span>
        <span class="n">prior_weights</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model_prior_weights</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_level_samp_comp_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">statistic_type</span> <span class="o">==</span> <span class="s1">&#39;ks&#39;</span><span class="p">:</span>
        <span class="n">stat_type</span> <span class="o">=</span> <span class="n">KS_TEST_TXT</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">store_p_value</span> <span class="k">else</span> <span class="n">KS_STAT_TEST_TXT</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">statistic_type</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
        <span class="n">stat_type</span> <span class="o">=</span> <span class="n">U_TEST_TXT</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">store_p_value</span> <span class="k">else</span> <span class="n">U_STAT_TEST_TXT</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">statistic_type</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
        <span class="n">stat_type</span> <span class="o">=</span> <span class="n">T_TEST_TXT</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">store_p_value</span> <span class="k">else</span> <span class="n">T_STAT_TEST_TXT</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboError</span><span class="p">(</span><span class="s1">&#39;Invalid statistic type.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">status_message</span><span class="p">(</span>
            <span class="s1">&#39;Performing two-sample group comparison significance testing.&#39;</span><span class="p">)</span>
    <span class="n">ctrl_reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">alternate_fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="n">test_significance</span><span class="p">(</span>
        <span class="n">reads_index</span><span class="p">,</span> <span class="n">stat_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">multiprocess_region_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_most_significant_stored</span><span class="p">,</span>
        <span class="n">fm_offset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fishers_method_context</span><span class="p">,</span>
        <span class="n">ctrl_reads_index</span><span class="o">=</span><span class="n">ctrl_reads_index</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_test_shifts_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="c1"># Check extra requirements for alternative model testing</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">action_command</span> <span class="o">==</span> <span class="s1">&#39;alternative_model&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_available_models</span><span class="p">:</span>
            <span class="n">_print_alt_models</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">statistics_file_basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Must provide both a set of FAST5 read files &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(--fast5-basedirs) and an output file basename &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;(--statistics-file-basename).&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">alternate_model_filenames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">args</span><span class="o">.</span><span class="n">alternate_bases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span>
                <span class="s1">&#39;Must provide an alterntive model against which to test.</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;Run with --print-available-models option to see possible &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;values for the --alternate-bases option.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;single_read_threshold&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lower_thresh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lower_thresh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                    <span class="s1">&#39;Only 1 or 2 values may be passed as single-read &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;thresholds. Only using the first 2 options provided.&#39;</span><span class="p">)</span>
            <span class="n">lower_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seq_sample_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># sample compare does not have seq_sample_type in the namespace</span>
            <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">DNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> \
                            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seq_sample_type</span> <span class="o">==</span> <span class="n">DNA_SAMP_TYPE</span> <span class="k">else</span> \
                               <span class="n">th</span><span class="o">.</span><span class="n">seqSampleType</span><span class="p">(</span><span class="n">RNA_SAMP_TYPE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">seq_samp_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">reads_index</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">TomboReads</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">fast5_basedirs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">corrected_group</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">basecall_subgroups</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">action_command</span> <span class="o">==</span> <span class="s1">&#39;de_novo&#39;</span><span class="p">:</span>
        <span class="n">_de_novo_main</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">action_command</span> <span class="o">==</span> <span class="s1">&#39;alternative_model&#39;</span><span class="p">:</span>
        <span class="n">_alt_main</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">action_command</span> <span class="o">==</span> <span class="s1">&#39;model_sample_compare&#39;</span><span class="p">:</span>
        <span class="n">_model_samp_comp_main</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">seq_samp_type</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">action_command</span> <span class="o">==</span> <span class="s1">&#39;level_sample_compare&#39;</span><span class="p">:</span>
        <span class="n">_level_samp_comp_main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">reads_index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span><span class="o">.</span><span class="n">error_message_and_exit</span><span class="p">(</span><span class="s1">&#39;Invalid Tombo detect_modifications command.&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_aggregate_per_read_main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span>
    <span class="n">th</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">VERBOSE</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lower_thresh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">th</span><span class="o">.</span><span class="n">warning_message</span><span class="p">(</span>
                <span class="s1">&#39;Only 1 or 2 values may be passed as single-read &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;thresholds. Only using the first 2 options provided.&#39;</span><span class="p">)</span>
        <span class="n">lower_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">single_read_thresh</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">single_read_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">aggregate_per_read_stats</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">per_read_statistics_filename</span><span class="p">,</span> <span class="n">single_read_thresh</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">statistics_filename</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">coverage_dampen_counts</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">minimum_test_reads</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_most_significant_stored</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;This is a module. See commands with `tombo -h`&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-18, Oxford Nanopore Technologies

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>